"""
LLM ê¸°ë°˜ ê½ƒ ë§¤ì¹­ ì„œë¹„ìŠ¤
"""
import os
import json
import re
from typing import List, Dict
from app.models.schemas import EmotionAnalysis, FlowerMatch
from app.services.realtime_context_extractor import RealtimeContextExtractor

class FlowerMatcher:
    def __init__(self):
        self.openai_api_key = os.getenv("OPENAI_API_KEY")
        self.context_extractor = RealtimeContextExtractor()
        
        # Base64 ì´ë¯¸ì§€ ë°ì´í„° ë¡œë“œ
        self.base64_images = self._load_base64_images()
        
        # ê½ƒ ë°ì´í„°ë² ì´ìŠ¤ (Base64 ì´ë¯¸ì§€ í¬í•¨)
        self.flower_database = {
            "Lathyrus Odoratus": {
                "korean_name": "Lathyrus Odoratus",
                "scientific_name": "Lathyrus Odoratus",
                "image_url": self.base64_images.get("lathyrus-odoratus", {}).get("í•‘í¬", ""),
                "keywords": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "colors": ['í•‘í¬'],
                "emotions": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "default_color": "í•‘í¬"
            },
            "Garden Peony": {
                "korean_name": "ì‘ì•½",
                "scientific_name": "Paeonia lactiflora",
                "image_url": self.base64_images.get("garden-peony", {}).get("á„’á…ªá„‹á…µá„á…³", ""),
                "keywords": ['ìš°ì•„í•¨', 'í´ë˜ì‹', 'ì„¸ë ¨ë¨', 'ì¶”ì–µ', 'ê·¸ë¦¬ì›€'],
                "colors": ['á„’á…ªá„‹á…µá„á…³', 'á„‘á…µá†¼á„á…³'],
                "emotions": ['ìš°ì•„í•¨', 'í´ë˜ì‹', 'ì„¸ë ¨ë¨', 'ì¶”ì–µ', 'ê·¸ë¦¬ì›€'],
                "default_color": "á„’á…ªá„‹á…µá„á…³"
            },
            "Alstroemeria Spp": {
                "korean_name": "Alstroemeria Spp",
                "scientific_name": "Alstroemeria Spp",
                "image_url": self.base64_images.get("alstroemeria-spp", {}).get("í™”ì´íŠ¸", ""),
                "keywords": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "colors": ['í™”ì´íŠ¸', 'í•‘í¬', 'ì˜¤ë Œì§€'],
                "emotions": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "default_color": "í™”ì´íŠ¸"
            },
            "Iris Sanguinea": {
                "korean_name": "Iris Sanguinea",
                "scientific_name": "Iris Sanguinea",
                "image_url": self.base64_images.get("iris-sanguinea", {}).get("í¼í”Œ", ""),
                "keywords": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "colors": ['í¼í”Œ'],
                "emotions": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "default_color": "í¼í”Œ"
            },
            "Ranunculus": {
                "korean_name": "Ranunculus",
                "scientific_name": "Ranunculus",
                "image_url": self.base64_images.get("ranunculus", {}).get("í™”ì´íŠ¸", ""),
                "keywords": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "colors": ['í™”ì´íŠ¸', 'í•‘í¬'],
                "emotions": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "default_color": "í™”ì´íŠ¸"
            },
            "Bouvardia": {
                "korean_name": "ë¶€ë°”ë¥´ë””ì•„",
                "scientific_name": "Bouvardia",
                "image_url": self.base64_images.get("bouvardia", {}).get("á„’á…ªá„‹á…µá„á…³", ""),
                "keywords": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "colors": ['á„’á…ªá„‹á…µá„á…³'],
                "emotions": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "default_color": "á„’á…ªá„‹á…µá„á…³"
            },
            "Iberis Sempervirens": {
                "korean_name": "Iberis Sempervirens",
                "scientific_name": "Iberis Sempervirens",
                "image_url": self.base64_images.get("iberis-sempervirens", {}).get("í™”ì´íŠ¸", ""),
                "keywords": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "colors": ['í™”ì´íŠ¸'],
                "emotions": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "default_color": "í™”ì´íŠ¸"
            },
            "Dianthus Caryophyllus": {
                "korean_name": "Dianthus Caryophyllus",
                "scientific_name": "Dianthus Caryophyllus",
                "image_url": self.base64_images.get("dianthus-caryophyllus", {}).get("ë ˆë“œ", ""),
                "keywords": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "colors": ['ë ˆë“œ'],
                "emotions": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "default_color": "ë ˆë“œ"
            },
            "Anthurium Andraeanum": {
                "korean_name": "Anthurium Andraeanum",
                "scientific_name": "Anthurium Andraeanum",
                "image_url": self.base64_images.get("anthurium-andraeanum", {}).get("ë ˆë“œ", ""),
                "keywords": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "colors": ['ë ˆë“œ', 'ê·¸ë¦°'],
                "emotions": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "default_color": "ë ˆë“œ"
            },
            "Anemone Coronaria": {
                "korean_name": "Anemone Coronaria",
                "scientific_name": "Anemone Coronaria",
                "image_url": self.base64_images.get("anemone-coronaria", {}).get("ë ˆë“œ", ""),
                "keywords": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "colors": ['ë ˆë“œ', 'í¼í”Œ'],
                "emotions": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "default_color": "ë ˆë“œ"
            },
            "Stock Flower": {
                "korean_name": "ìŠ¤í†¡í”Œë¼ì›Œ",
                "scientific_name": "Matthiola incana",
                "image_url": self.base64_images.get("stock-flower", {}).get("á„‘á…¥á„‘á…³á†¯", ""),
                "keywords": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "colors": ['á„‘á…¥á„‘á…³á†¯'],
                "emotions": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "default_color": "á„‘á…¥á„‘á…³á†¯"
            },
            "Scabiosa": {
                "korean_name": "ìŠ¤ì¹´ë¹„ì˜¤ì‚¬",
                "scientific_name": "Scabiosa atropurpurea",
                "image_url": self.base64_images.get("scabiosa", {}).get("á„’á…ªá„‹á…µá„á…³", ""),
                "keywords": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "colors": ['á„’á…ªá„‹á…µá„á…³', 'á„‡á…³á†¯á„…á…®'],
                "emotions": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "default_color": "á„’á…ªá„‹á…µá„á…³"
            },
            "Ranunculus Asiaticus": {
                "korean_name": "Ranunculus Asiaticus",
                "scientific_name": "Ranunculus Asiaticus",
                "image_url": self.base64_images.get("ranunculus-asiaticus", {}).get("ì˜¤ë Œì§€", ""),
                "keywords": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "colors": ['ì˜¤ë Œì§€'],
                "emotions": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "default_color": "ì˜¤ë Œì§€"
            },
            "Drumstick Flower": {
                "korean_name": "ë“œëŸ¼ìŠ¤í‹±í”Œë¼ì›Œ",
                "scientific_name": "Craspedia globosa",
                "image_url": self.base64_images.get("drumstick-flower", {}).get("á„‹á…¨á†¯á„…á…©á„‹á…®", ""),
                "keywords": ['ë…íŠ¹í•¨', 'ëª¨ë˜', 'í¬ì¸íŠ¸', 'ì¬ë¯¸'],
                "colors": ['á„‹á…¨á†¯á„…á…©á„‹á…®'],
                "emotions": ['ì¬ë¯¸', 'ë…íŠ¹í•¨', 'ëª¨ë˜'],
                "default_color": "á„‹á…¨á†¯á„…á…©á„‹á…®"
            },
            "Freesia Refracta": {
                "korean_name": "Freesia Refracta",
                "scientific_name": "Freesia Refracta",
                "image_url": self.base64_images.get("freesia-refracta", {}).get("ì˜ë¡œìš°", ""),
                "keywords": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "colors": ['ì˜ë¡œìš°'],
                "emotions": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "default_color": "ì˜ë¡œìš°"
            },
            "Cymbidium Spp": {
                "korean_name": "Cymbidium Spp",
                "scientific_name": "Cymbidium Spp",
                "image_url": self.base64_images.get("cymbidium-spp", {}).get("í™”ì´íŠ¸", ""),
                "keywords": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "colors": ['í™”ì´íŠ¸', 'ê·¸ë¦°', 'í•‘í¬'],
                "emotions": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "default_color": "í™”ì´íŠ¸"
            },
            "Dahlia": {
                "korean_name": "ë‹¬ë¦¬ì•„",
                "scientific_name": "Dahlia pinnata",
                "image_url": self.base64_images.get("dahlia", {}).get("á„‹á…¨á†¯á„…á…©á„‹á…®", ""),
                "keywords": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "colors": ['á„‹á…¨á†¯á„…á…©á„‹á…®', 'á„‘á…µá†¼á„á…³'],
                "emotions": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "default_color": "á„‹á…¨á†¯á„…á…©á„‹á…®"
            },
            "Rose": {
                "korean_name": "ì¥ë¯¸",
                "scientific_name": "Rosa",
                "image_url": self.base64_images.get("rose", {}).get("á„…á…¦á„ƒá…³", ""),
                "keywords": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "colors": ['á„…á…¦á„ƒá…³', 'ë¸”ë£¨', 'á„‘á…µá†¼á„á…³', 'ì˜¤ë Œì§€'],
                "emotions": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "default_color": "á„…á…¦á„ƒá…³"
            },
            "Lily": {
                "korean_name": "ë°±í•©",
                "scientific_name": "Lilium",
                "image_url": self.base64_images.get("lily", {}).get("á„’á…ªá„‹á…µá„á…³", ""),
                "keywords": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "colors": ['á„’á…ªá„‹á…µá„á…³'],
                "emotions": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "default_color": "á„’á…ªá„‹á…µá„á…³"
            },
            "Marguerite Daisy": {
                "korean_name": "ë§ˆê°€ë ›ë°ì´ì§€",
                "scientific_name": "Argyranthemum frutescens",
                "image_url": self.base64_images.get("marguerite-daisy", {}).get("í™”ì´íŠ¸", ""),
                "keywords": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "colors": ['í™”ì´íŠ¸'],
                "emotions": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "default_color": "í™”ì´íŠ¸"
            },
            "Tulip": {
                "korean_name": "íŠ¤ë¦½",
                "scientific_name": "Tulipa",
                "image_url": self.base64_images.get("tulip", {}).get("á„’á…ªá„‹á…µá„á…³", ""),
                "keywords": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "colors": ['á„’á…ªá„‹á…µá„á…³', 'á„…á…¦á„ƒá…³', 'á„‹á…¨á†¯á„…á…©á„‹á…®'],
                "emotions": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "default_color": "á„’á…ªá„‹á…µá„á…³"
            },
            "Gerbera Daisy": {
                "korean_name": "ê±°ë² ë¼",
                "scientific_name": "Gerbera jamesonii",
                "image_url": self.base64_images.get("gerbera-daisy", {}).get("ì˜ë¡œìš°", ""),
                "keywords": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "colors": ['ì˜ë¡œìš°', 'ì˜¤ë Œì§€'],
                "emotions": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "default_color": "ì˜ë¡œìš°"
            },
            "Astilbe Japonica": {
                "korean_name": "Astilbe Japonica",
                "scientific_name": "Astilbe Japonica",
                "image_url": self.base64_images.get("astilbe-japonica", {}).get("í™”ì´íŠ¸", ""),
                "keywords": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "colors": ['í™”ì´íŠ¸', 'í•‘í¬'],
                "emotions": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "default_color": "í™”ì´íŠ¸"
            },
            "Cockscomb": {
                "korean_name": "ë§¨ë“œë¼ë¯¸",
                "scientific_name": "Celosia cristata",
                "image_url": self.base64_images.get("cockscomb", {}).get("á„…á…¦á„ƒá…³", ""),
                "keywords": ['ë…íŠ¹í•¨', 'í¬ì¸íŠ¸', 'í™”ë ¤í•¨'],
                "colors": ['á„…á…¦á„ƒá…³', 'ì˜¤ë Œì§€'],
                "emotions": ['ë…íŠ¹í•¨', 'í™”ë ¤í•¨', 'í¬ì¸íŠ¸'],
                "default_color": "á„…á…¦á„ƒá…³"
            },
            "Cotton Plant": {
                "korean_name": "ëª©í™”",
                "scientific_name": "Gossypium",
                "image_url": self.base64_images.get("cotton-plant", {}).get("á„’á…ªá„‹á…µá„á…³", ""),
                "keywords": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "colors": ['á„’á…ªá„‹á…µá„á…³'],
                "emotions": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "default_color": "á„’á…ªá„‹á…µá„á…³"
            },
            "Ammi Majus": {
                "korean_name": "Ammi Majus",
                "scientific_name": "Ammi Majus",
                "image_url": self.base64_images.get("ammi-majus", {}).get("í™”ì´íŠ¸", ""),
                "keywords": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "colors": ['í™”ì´íŠ¸'],
                "emotions": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "default_color": "í™”ì´íŠ¸"
            },
            "Lisianthus": {
                "korean_name": "ë¦¬ì‹œì•ˆì„œìŠ¤",
                "scientific_name": "Eustoma grandiflorum",
                "image_url": self.base64_images.get("lisianthus", {}).get("á„’á…ªá„‹á…µá„á…³", ""),
                "keywords": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "colors": ['á„’á…ªá„‹á…µá„á…³', 'ë¼ì¼ë½', 'á„‘á…µá†¼á„á…³'],
                "emotions": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "default_color": "á„’á…ªá„‹á…µá„á…³"
            },
            "Gladiolus": {
                "korean_name": "Gladiolus",
                "scientific_name": "Gladiolus",
                "image_url": self.base64_images.get("gladiolus", {}).get("ë ˆë“œ", ""),
                "keywords": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "colors": ['ë ˆë“œ'],
                "emotions": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "default_color": "ë ˆë“œ"
            },
            "Gentiana Andrewsii": {
                "korean_name": "Gentiana Andrewsii",
                "scientific_name": "Gentiana Andrewsii",
                "image_url": self.base64_images.get("gentiana-andrewsii", {}).get("ë¸”ë£¨", ""),
                "keywords": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "colors": ['ë¸”ë£¨'],
                "emotions": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "default_color": "ë¸”ë£¨"
            },
            "Babys Breath": {
                "korean_name": "ë² ì´ë¹„ìŠ¤ë¸Œë ˆìŠ¤",
                "scientific_name": "Gypsophila paniculata",
                "image_url": self.base64_images.get("babys-breath", {}).get("á„’á…ªá„‹á…µá„á…³", ""),
                "keywords": ['ë¶€ë“œëŸ¬ì›€', 'ìš°ì•„í•¨', 'í•„ëŸ¬'],
                "colors": ['á„’á…ªá„‹á…µá„á…³'],
                "emotions": ['ë¶€ë“œëŸ¬ì›€', 'ìš°ì•„í•¨', 'ìˆœìˆ˜'],
                "default_color": "á„’á…ªá„‹á…µá„á…³"
            },
            "Zinnia Elegans": {
                "korean_name": "Zinnia Elegans",
                "scientific_name": "Zinnia Elegans",
                "image_url": self.base64_images.get("zinnia-elegans", {}).get("ë ˆë“œ", ""),
                "keywords": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "colors": ['ë ˆë“œ', 'í•‘í¬'],
                "emotions": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "default_color": "ë ˆë“œ"
            },
            "Tagetes Erecta": {
                "korean_name": "Tagetes Erecta",
                "scientific_name": "Tagetes Erecta",
                "image_url": self.base64_images.get("tagetes-erecta", {}).get("ì˜ë¡œìš°", ""),
                "keywords": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "colors": ['ì˜ë¡œìš°', 'ì˜¤ë Œì§€'],
                "emotions": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "default_color": "ì˜ë¡œìš°"
            },
            "Veronica Spicata": {
                "korean_name": "Veronica Spicata",
                "scientific_name": "Veronica Spicata",
                "image_url": self.base64_images.get("veronica-spicata", {}).get("í™”ì´íŠ¸", ""),
                "keywords": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "colors": ['í™”ì´íŠ¸', 'í¼í”Œ'],
                "emotions": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "default_color": "í™”ì´íŠ¸"
            },
            "Globe Amaranth": {
                "korean_name": "ì²œì¼í™",
                "scientific_name": "Gomphrena globosa",
                "image_url": self.base64_images.get("globe-amaranth", {}).get("á„‘á…¥á„‘á…³á†¯", ""),
                "keywords": ['ì§€ì†ì„±', 'ë‚´êµ¬ì„±', 'í¬ì¸íŠ¸'],
                "colors": ['á„‘á…¥á„‘á…³á†¯'],
                "emotions": ['ì§€ì†ì„±', 'í¬ì¸íŠ¸', 'ë‚´êµ¬ì„±'],
                "default_color": "á„‘á…¥á„‘á…³á†¯"
            },
            "Hydrangea": {
                "korean_name": "ìˆ˜êµ­",
                "scientific_name": "Hydrangea macrophylla",
                "image_url": self.base64_images.get("hydrangea", {}).get("ë¸”ë£¨", ""),
                "keywords": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "colors": ['ë¸”ë£¨', 'ê·¸ë¦°', 'á„‘á…µá†¼á„á…³'],
                "emotions": ['ì•„ë¦„ë‹¤ì›€', 'ìì—°ìŠ¤ëŸ¬ì›€'],
                "default_color": "ë¸”ë£¨"
            },
            "Gerbera Daisy": {
                "korean_name": "ê±°ë² ë¼",
                "scientific_name": "Gerbera jamesonii",
                "image_url": self.base64_images.get("gerbera-daisy", {}).get("ë…¸ë‘", ""),
                "keywords": ["í¬ë§", "í™œë ¥", "ê¸ì •", "ìƒˆë¡œìš´ ì‹œì‘", "ê¸°ì¨"],
                "colors": ["ë…¸ë‘", "ì˜¤ë Œì§€", "ë¹¨ê°•", "í•‘í¬"],
                "emotions": ["í¬ë§", "ê¸°ì¨", "í™œë ¥", "ê¸ì •"]
            },
            "Dahlia": {
                "korean_name": "ë‹¤ì•Œë¦¬ì•„",
                "scientific_name": "Dahlia pinnata",
                "image_url": self.base64_images.get("dahlia", {}).get("í•‘í¬", ""),
                "keywords": ["í™”ë ¤í•¨", "ì—ë„ˆì§€", "í¬ì¸íŠ¸", "í˜„ëŒ€ì "],
                "colors": ["ë…¸ë‘", "ì˜¤ë Œì§€", "ë¹¨ê°•", "ë³´ë¼"],
                "emotions": ["ê¸°ì¨", "ì¶•í•˜", "í™”ë ¤í•¨", "ì—ë„ˆì§€"]
            },
            "Rose": {
                "korean_name": "ì¥ë¯¸",
                "scientific_name": "Rosa",
                "image_url": self.base64_images.get("rose", {}).get("í•‘í¬", ""),
                "keywords": ["ì‚¬ë‘", "ë¡œë§¨ìŠ¤", "ìš°ì•„í•¨", "í´ë˜ì‹", "ì•„ë¦„ë‹¤ì›€"],
                "colors": ["í•‘í¬", "ë ˆë“œ", "ë¸”ë£¨", "ì˜¤ë Œì§€"],
                "emotions": ["ë¡œë§¨ìŠ¤", "ì‚¬ë‘", "ìš°ì•„í•¨", "ê°ì‚¬"],
                "available_colors": {
                    "í•‘í¬": True,
                    "ë ˆë“œ": True,
                    "ë¸”ë£¨": True,
                    "ì˜¤ë Œì§€": True
                },
                "color_meanings": {
                    "í•‘í¬": {
                        "emotions": ["ì„¤ë ˜", "ê¸°ì¨", "ì• í‹‹í•¨"],
                        "moods": ["ëŸ¬ë¸”ë¦¬", "íŒŒìŠ¤í…”", "ë¡œë§¨í‹±"],
                        "contexts": ["ê³ ë°±", "ìƒì¼", "ê°ì‚¬ì „ë‹¬"],
                        "meaning": "ì‚¬ë‘ì˜ ê³ ë°±, ìˆ˜ì¤ìŒ"
                    },
                    "ë ˆë“œ": {
                        "emotions": ["ìš©ê¸°", "ìë¶€ì‹¬", "ì„¤ë ˜"],
                        "moods": ["ë¹„ë¹„ë“œ", "ì‹œí¬", "ë¡œë§¨í‹±"],
                        "contexts": ["ê³ ë°±", "ìŠ¹ì§„Â·í•©ê²©", "ê¸°ë…ì¼"],
                        "meaning": "ì—´ì •, ì§„ì‹¬"
                    },
                    "ë¸”ë£¨": {
                        "emotions": ["ì‹ ë¹„", "ìš°ì•„í•¨", "ê³ ê¸‰ìŠ¤ëŸ¬ì›€"],
                        "moods": ["ì‹œí¬", "ìš°ì•„í•¨", "í´ë˜ì‹"],
                        "contexts": ["ê³ ê¸‰ìŠ¤ëŸ¬ìš´ ì„ ë¬¼", "íŠ¹ë³„í•œ ë‚ "],
                        "meaning": "ì‹ ë¹„ë¡œìš´ ì‚¬ë‘, íŠ¹ë³„í•¨"
                    },
                    "ì˜¤ë Œì§€": {
                        "emotions": ["ì—´ì •", "ì—ë„ˆì§€", "ê¸°ì¨"],
                        "moods": ["ë¹„ë¹„ë“œ", "ëª¨ë˜", "ê°•ë ¬í•¨"],
                        "contexts": ["ì¶•í•˜", "ì‘ì›", "ê²©ë ¤"],
                        "meaning": "ì—´ì •ì ì¸ ì‚¬ë‘, ì—ë„ˆì§€"
                    }
                }
            },
            "Lily": {
                "korean_name": "ë°±í•©",
                "scientific_name": "Lilium",
                "image_url": self.base64_images.get("lily", {}).get("í™”ì´íŠ¸", ""),
                "keywords": ["ìˆœìˆ˜", "ê³ ê·€í•¨", "ìš°ì•„í•¨", "í´ë˜ì‹", "ìˆœê²°"],
                "colors": ["í™”ì´íŠ¸"],  # ì‹¤ì œ íŒŒì¼ì— ë§ê²Œ ìˆ˜ì •
                "emotions": ["ìˆœìˆ˜", "ê³ ê·€í•¨", "ìš°ì•„í•¨"]
            },
            "Tulip": {
                "korean_name": "íŠ¤ë¦½",
                "scientific_name": "Tulipa",
                "image_url": self.base64_images.get("tulip", {}).get("í™”ì´íŠ¸", ""),
                "keywords": ["ë´„", "ì‹ ì„ í•¨", "ìƒˆë¡œìš´ ì‹œì‘", "í¬ë§", "ì™„ë²½í•œ ì‚¬ë‘"],
                "colors": ["ë…¸ë‘", "í•‘í¬", "í™”ì´íŠ¸", "ë³´ë¼"],
                "emotions": ["í¬ë§", "ì‹ ì„ í•¨", "ìƒˆë¡œìš´ ì‹œì‘"]
            },
            "Garden Peony": {
                "korean_name": "ì‘ì•½",
                "scientific_name": "Paeonia lactiflora",
                "image_url": self.base64_images.get("garden-peony", {}).get("í•‘í¬", ""),
                "keywords": ["ìš°ì•„í•¨", "í´ë˜ì‹", "ì„¸ë ¨ë¨", "í¬ì¸íŠ¸", "ìˆ˜ì¤ìŒ", "ë¶€ë„ëŸ¬ì›€"],
                "colors": ["í•‘í¬", "í™”ì´íŠ¸", "í¬ë¦¼", "ì—°ë³´ë¼"],
                "emotions": ["ìš°ì•„í•¨", "ì„¸ë ¨ë¨", "í´ë˜ì‹"]
            },
            "Lisianthus": {
                "korean_name": "ë¦¬ì‹œì•ˆì…”ìŠ¤",
                "scientific_name": "Eustoma grandiflorum",
                "image_url": self.base64_images.get("lisianthus", {}).get("í™”ì´íŠ¸", ""),
                "keywords": ["ìš°ì•„í•¨", "ì„¸ë ¨ë¨", "ê³ ê¸‰ìŠ¤ëŸ¬ì›€", "ì€ì€í•œ ì‚¬ë‘", "ê³ ê·€í•¨", "ê°ì‚¬"],
                "colors": ["í™”ì´íŠ¸", "í¬ë¦¼", "ì—°í•‘í¬", "ë¼ë²¤ë”"],
                "emotions": ["ìš°ì•„í•¨", "ì„¸ë ¨ë¨", "ê³ ê¸‰ìŠ¤ëŸ¬ì›€", "ì€ì€í•œ ì‚¬ë‘", "ê³ ê·€í•¨"]
            },
            "Hydrangea": {
                "korean_name": "ìˆ˜êµ­",
                "scientific_name": "Hydrangea macrophylla",
                "image_url": self.base64_images.get("hydrangea", {}).get("í•‘í¬", ""),
                "keywords": ["í’ì„±í•¨", "ìš°ì•„í•¨", "ìì—°ìŠ¤ëŸ¬ì›€"],
                "colors": ["í•‘í¬", "ë¸”ë£¨", "í¼í”Œ"],  # í´ë°± ë¡œì§ìœ¼ë¡œ ë¸”ë£¨/í¼í”Œë„ ì§€ì›
                "emotions": ["í’ì„±í•¨", "ìš°ì•„í•¨", "ìì—°ìŠ¤ëŸ¬ì›€"]
            },
            "Scabiosa": {
                "korean_name": "ìŠ¤ì¹´ë¹„ì˜¤ì‚¬",
                "scientific_name": "Scabiosa atropurpurea",
                "image_url": self.base64_images.get("scabiosa", {}).get("ë¸”ë£¨", ""),
                "keywords": ["ìš°ì•„í•¨", "ì„¸ë ¨ë¨", "í¬ì¸íŠ¸", "ëª¨ë˜", "ê·¸ë¦¬ì›€"],
                "colors": ["ë¸”ë£¨", "í™”ì´íŠ¸", "í¼í”Œ"],
                "emotions": ["ìš°ì•„í•¨", "ì„¸ë ¨ë¨", "ëª¨ë˜", "ê·¸ë¦¬ì›€"]
            },
            "Bouvardia": {
                "korean_name": "ë¶€ë°”ë¥´ë””ì•„",
                "scientific_name": "Bouvardia",
                "image_url": self.base64_images.get("bouvardia", {}).get("í™”ì´íŠ¸", ""),
                "keywords": ["ìš°ì•„í•¨", "ì„¸ë ¨ë¨", "ê³ ê¸‰ìŠ¤ëŸ¬ì›€"],
                "colors": ["í™”ì´íŠ¸"],
                "emotions": ["ê°ì‚¬", "ì• í‹‹í•¨", "í‰ì˜¨", "ì„¤ë ˜", "ê¸°ì¨"],
                "moods": ["ë¡œë§¨í‹±", "ìš°ì•„í•¨", "ë‚´ì¶”ëŸ´", "ëŸ¬ë¸”ë¦¬", "íŒŒìŠ¤í…”"],
                "available": True,
                "color_meanings": {
                    "í™”ì´íŠ¸": {
                        "emotions": ["ê°ì‚¬", "ì• í‹‹í•¨", "í‰ì˜¨"],
                        "moods": ["ë¡œë§¨í‹±", "ìš°ì•„í•¨", "ë‚´ì¶”ëŸ´"],
                        "contexts": ["ê°ì‚¬ì „ë‹¬", "ìƒì¼", "ìœ„ë¡œÂ·ì¾Œìœ "],
                        "meaning": "ìˆœìˆ˜í•œ ì‚¬ë‘, ê°ì‚¬"
                    }
                }
            },
            "Stock Flower": {
                "korean_name": "ìŠ¤í†¡í”Œë¼ì›Œ",
                "scientific_name": "Matthiola incana",
                "image_url": self.base64_images.get("stock-flower", {}).get("í¼í”Œ", ""),
                "keywords": ["ìš°ì•„í•¨", "í´ë˜ì‹", "ì„¸ë ¨ë¨", "ì¶”ì–µ", "ê·¸ë¦¬ì›€"],
                "colors": ["í¼í”Œ", "í™”ì´íŠ¸", "í•‘í¬"],
                "emotions": ["ìš°ì•„í•¨", "í´ë˜ì‹", "ì„¸ë ¨ë¨", "ì¶”ì–µ", "ê·¸ë¦¬ì›€"]
            },
            "Drumstick Flower": {
                "korean_name": "ë“œëŸ¼ìŠ¤í‹±í”Œë¼ì›Œ",
                "scientific_name": "Craspedia globosa",
                "image_url": self.base64_images.get("drumstick-flower", {}).get("ì˜ë¡œìš°", ""),
                "keywords": ["ë…íŠ¹í•¨", "ëª¨ë˜", "í¬ì¸íŠ¸", "ì¬ë¯¸"],
                "colors": ["ì˜ë¡œìš°"],
                "emotions": ["ì¬ë¯¸", "ë…íŠ¹í•¨", "ëª¨ë˜"],
                "default_color": "ì˜ë¡œìš°"
            },
            "Cotton Plant": {
                "korean_name": "ëª©í™”",
                "scientific_name": "Gossypium",
                "image_url": self.base64_images.get("cotton-plant", {}).get("í™”ì´íŠ¸", ""),
                "keywords": ["ìì—°ìŠ¤ëŸ¬ì›€", "ë‚´ì¶”ëŸ´", "ë¶€ë“œëŸ¬ì›€"],
                "colors": ["í™”ì´íŠ¸", "í¬ë¦¼"],
                "emotions": ["ìì—°ìŠ¤ëŸ¬ì›€", "ë¶€ë“œëŸ¬ì›€", "ë‚´ì¶”ëŸ´"]
            },
            "Cockscomb": {
                "korean_name": "ë§¨ë“œë¼ë¯¸",
                "scientific_name": "Celosia cristata",
                "image_url": self.base64_images.get("cockscomb", {}).get("ë ˆë“œ", ""),
                "keywords": ["ë…íŠ¹í•¨", "í¬ì¸íŠ¸", "í™”ë ¤í•¨"],
                "colors": ["ë ˆë“œ", "ì˜¤ë Œì§€"],
                "emotions": ["ì¶•í•˜", "ê²©ë ¤", "ê¸°ì¨", "ìš©ê¸°", "ìë¶€ì‹¬"],
                "moods": ["ë¹„ë¹„ë“œ", "ì‹œí¬", "ëª¨ë˜"],
                "default_color": "ë ˆë“œ"
            },
            "Globe Amaranth": {
                "korean_name": "ì²œì¼í™",
                "scientific_name": "Gomphrena globosa",
                "image_url": self.base64_images.get("globe-amaranth", {}).get("í¼í”Œ", ""),
                "keywords": ["ì§€ì†ì„±", "ë‚´êµ¬ì„±", "í¬ì¸íŠ¸"],
                "colors": ["í¼í”Œ"],
                "emotions": ["ì§€ì†ì„±", "í¬ì¸íŠ¸", "ë‚´êµ¬ì„±"],
                "default_color": "í¼í”Œ"
            },
            "Marguerite Daisy": {
                "korean_name": "ë§ˆê°€ë ›",
                "scientific_name": "Argyranthemum frutescens",
                "image_url": self.base64_images.get("marguerite-daisy", {}).get("í™”ì´íŠ¸", ""),
                "keywords": ["ìˆœìˆ˜", "ì‹ ì„ í•¨", "ìì—°ìŠ¤ëŸ¬ì›€", "ì§„ì‹¬", "ìˆœê²°í•œ ì‚¬ë‘", "ì€ì€í•œ ë§¤ë ¥"],
                "colors": ["í™”ì´íŠ¸"],
                "emotions": ["ê°ì‚¬", "í‰ì˜¨", "ì• í‹‹í•¨", "ì„¤ë ˜", "ê¸°ì¨"],
                "moods": ["ë¡œë§¨í‹±", "ë‚´ì¶”ëŸ´", "ìš°ì•„í•¨", "ëŸ¬ë¸”ë¦¬", "íŒŒìŠ¤í…”"],
                "available_colors": {
                    "í™”ì´íŠ¸": True
                },
                "color_meanings": {
                    "í™”ì´íŠ¸": {
                        "emotions": ["ê°ì‚¬", "í‰ì˜¨", "ì• í‹‹í•¨"],
                        "moods": ["ë¡œë§¨í‹±", "ë‚´ì¶”ëŸ´", "ìš°ì•„í•¨"],
                        "contexts": ["ê°ì‚¬ì „ë‹¬", "ê³ ë°±", "ì¸í…Œë¦¬ì–´"],
                        "meaning": "ì§„ì‹¬, ìˆœê²°í•œ ì‚¬ë‘"
                    }
                }
            },
            "Babys Breath": {
                "korean_name": "ë² ì´ë¹„ìŠ¤ë¸Œë ˆìŠ¤",
                "scientific_name": "Gypsophila paniculata",
                "image_url": self.base64_images.get("babys-breath", {}).get("í™”ì´íŠ¸", ""),
                "keywords": ["ë¶€ë“œëŸ¬ì›€", "ìš°ì•„í•¨", "í•„ëŸ¬", "ìˆœìˆ˜", "ê³ ìš”í•¨", "í‰ì˜¨"],
                "colors": ["í™”ì´íŠ¸"],
                "emotions": ["ë¶€ë“œëŸ¬ì›€", "ìš°ì•„í•¨", "ìˆœìˆ˜", "í‰ì˜¨", "ê³ ìš”í•¨"],
                "moods": ["ë¡œë§¨í‹±", "ë‚´ì¶”ëŸ´", "ìš°ì•„í•¨", "ë¯¸ë‹ˆë©€"],
                "available": True,
                "color_meanings": {
                    "í™”ì´íŠ¸": {
                        "emotions": ["ê°ì‚¬", "ì• í‹‹í•¨", "í‰ì˜¨"],
                        "moods": ["ë¡œë§¨í‹±", "ìš°ì•„í•¨", "ë‚´ì¶”ëŸ´"],
                        "contexts": ["ê°ì‚¬ì „ë‹¬", "ìƒì¼", "ìœ„ë¡œÂ·ì¾Œìœ "],
                        "meaning": "ìˆœìˆ˜í•œ ì‚¬ë‘, ê°ì‚¬"
                    }
                }
            },

            "Gladiolus": {
                "korean_name": "ê¸€ë¼ë””ì˜¬ëŸ¬ìŠ¤",
                "scientific_name": "Gladiolus",
                "image_url": self.base64_images.get("gladiolus", {}).get("ë ˆë“œ", ""),
                "keywords": ["ê°•ì¸í•¨", "ì •ì§", "ì„±ì‹¤", "ê¸°ë…"],
                "colors": ["ë ˆë“œ", "í•‘í¬", "í™”ì´íŠ¸", "ì˜ë¡œìš°"],
                "emotions": ["ê°•ì¸í•¨", "ì •ì§", "ì„±ì‹¤", "ê¸°ë…"]
            },
            "Astilbe Japonica": {
                "korean_name": "Astilbe Japonica",
                "scientific_name": "Astilbe Japonica",
                "image_url": self.base64_images.get("astilbe-japonica", {}).get("í•‘í¬", ""),
                "keywords": ["ì•„ë¦„ë‹¤ì›€", "ìì—°ìŠ¤ëŸ¬ì›€"],
                "colors": ["í•‘í¬"],
                "emotions": ["ì•„ë¦„ë‹¤ì›€", "ìì—°ìŠ¤ëŸ¬ì›€"]
            },
            "Cymbidium Spp": {
                "korean_name": "ì‹¬ë¹„ë””ì›€",
                "scientific_name": "Cymbidium spp.",
                "image_url": self.base64_images.get("cymbidium-spp", {}).get("í™”ì´íŠ¸", ""),
                "keywords": ["ê³ ê¸‰ìŠ¤ëŸ¬ì›€", "ìš°ì•„í•¨", "ì„¸ë ¨ë¨", "í´ë˜ì‹", "ì§€ì†ì„±", "ê°ì‚¬", "í‰ì˜¨", "ì§„ì‹¬"],
                "colors": ["í™”ì´íŠ¸", "í•‘í¬"],
                "emotions": ["í‰ì˜¨", "ê°ì‚¬", "ìë¶€ì‹¬"],
                "moods": ["ë‚´ì¶”ëŸ´", "ìš°ì•„í•¨", "ë¯¸ë‹ˆë©€"]
            },
            "Anemone Coronaria": {
                "korean_name": "ì•„ë„¤ëª¨ë„¤",
                "scientific_name": "Anemone coronaria",
                "image_url": self.base64_images.get("anemone-coronaria", {}).get("ë ˆë“œ", ""),
                "keywords": ["í¬ë§", "ê¸°ëŒ€", "ìƒˆë¡œìš´ ì‹œì‘", "ë´„", "ì‹ ì„ í•¨"],
                "colors": ["ë ˆë“œ", "í¼í”Œ"],
                "emotions": ["í¬ë§", "ê¸°ëŒ€", "ìƒˆë¡œìš´ ì‹œì‘", "ì‹ ì„ í•¨"]
            },
            "Anthurium Andraeanum": {
                "korean_name": "ì•ˆìŠ¤ë¦¬ì›€",
                "scientific_name": "Anthurium andraeanum",
                "image_url": self.base64_images.get("anthurium-andraeanum", {}).get("ë ˆë“œ", ""),
                "keywords": ["ì •ì—´", "ì—´ì •ì ì¸ ì‚¬ë‘", "í™”ë ¤í•¨", "íŠ¸ë¡œí”¼ì»¬", "ê°•ë ¬í•¨", "ì •ì—´ì ì¸ ì‚¬ë‘"],
                "colors": ["ë ˆë“œ", "ê·¸ë¦°"],
                "emotions": ["ì •ì—´", "ì—´ì •ì ì¸ ì‚¬ë‘", "í™”ë ¤í•¨", "ê°•ë ¬í•¨", "ì •ì—´ì ì¸ ì‚¬ë‘"]
            },
            "Ammi Majus": {
                "korean_name": "ì•„ë¯¸ ë§ˆì£¼ìŠ¤",
                "scientific_name": "Ammi majus",
                "image_url": self.base64_images.get("ammi-majus", {}).get("í™”ì´íŠ¸", ""),
                "keywords": ["ìì—°ìŠ¤ëŸ¬ì›€", "ë¶€ë“œëŸ¬ì›€", "í•„ëŸ¬", "ìš°ì•„í•¨", "ìˆœìˆ˜"],
                "colors": ["í™”ì´íŠ¸"],
                "emotions": ["ìì—°ìŠ¤ëŸ¬ì›€", "ë¶€ë“œëŸ¬ì›€", "ìš°ì•„í•¨", "ìˆœìˆ˜"]
            },
            "Veronica Spicata": {
                "korean_name": "ë² ë¡œë‹ˆì¹´",
                "scientific_name": "Veronica spicata",
                "image_url": self.base64_images.get("veronica-spicata", {}).get("í¼í”Œ", ""),
                "keywords": ["ì¶©ì„±", "ì‹ ë¢°", "ìš°ì •", "ì§€ì†ì„±", "ì•ˆì •ê°", "ì• í‹‹í•¨", "ê·¸ë¦¬ì›€"],
                "colors": ["í¼í”Œ"],
                "emotions": ["ê·¸ë¦¬ì›€", "ì• í‹‹í•¨", "ìœ„ë¡œ", "í¬ë§", "í‰ì˜¨"],
                "moods": ["ì‹œí¬", "ìš°ì•„í•¨", "í´ë˜ì‹", "ë¯¸ë‹ˆë©€", "ì‹œí¬"]
            },
            "Alstroemeria Spp": {
                "korean_name": "ì•ŒìŠ¤íŠ¸ë¡œë©”ë¦¬ì•„",
                "scientific_name": "Alstroemeria spp.",
                "image_url": self.base64_images.get("alstroemeria-spp", {}).get("í•‘í¬", ""),
                "keywords": ["ìƒˆë¡œìš´ ë§Œë‚¨", "ë°°ë ¤", "ìš°ì •", "ì§€ì†ì„±", "ë”°ëœ»í•¨"],
                "colors": ["í•‘í¬", "í™”ì´íŠ¸", "ì˜¤ë Œì§€"],
                "emotions": ["ìƒˆë¡œìš´ ë§Œë‚¨", "ë°°ë ¤", "ìš°ì •", "ì§€ì†ì„±", "ë”°ëœ»í•¨"],
                "moods": ["ëŸ¬ë¸”ë¦¬", "íŒŒìŠ¤í…”", "ë¡œë§¨í‹±", "ë‚´ì¶”ëŸ´", "ìš°ì•„í•¨"],
                "available_colors": {
                    "í•‘í¬": True,
                    "í™”ì´íŠ¸": True,
                    "ì˜¤ë Œì§€": True
                },
                "color_meanings": {
                    "í•‘í¬": {
                        "emotions": ["ì„¤ë ˜", "ê¸°ì¨", "ì• í‹‹í•¨"],
                        "moods": ["ëŸ¬ë¸”ë¦¬", "íŒŒìŠ¤í…”", "ë¡œë§¨í‹±"],
                        "contexts": ["ê³ ë°±", "ìƒì¼", "ê°ì‚¬ì „ë‹¬"],
                        "meaning": "ì‚¬ë‘ìŠ¤ëŸ¬ì›€, ì• ì •"
                    },
                    "í™”ì´íŠ¸": {
                        "emotions": ["ê°ì‚¬", "ì• í‹‹í•¨", "í‰ì˜¨"],
                        "moods": ["ë¡œë§¨í‹±", "ìš°ì•„í•¨", "ë‚´ì¶”ëŸ´"],
                        "contexts": ["ê°ì‚¬ì „ë‹¬", "ìƒì¼", "ìœ„ë¡œÂ·ì¾Œìœ "],
                        "meaning": "ìˆœìˆ˜í•œ ì‚¬ë‘, ê°ì‚¬"
                    },
                    "ì˜¤ë Œì§€": {
                        "emotions": ["ê¸°ì¨", "í™œë ¥", "ê¸ì •"],
                        "moods": ["ë¹„ë¹„ë“œ", "ë‚´ì¶”ëŸ´", "ëŸ¬ë¸”ë¦¬"],
                        "contexts": ["ìƒì¼", "ì‘ì›Â·ê²©ë ¤", "ê°ì‚¬ì „ë‹¬"],
                        "meaning": "ê¸°ì¨, í–‰ë³µí•œ ë¯¸ì†Œ"
                    }
                }
            },
            "Zinnia Elegans": {
                "korean_name": "ë°±ì¼í™",
                "scientific_name": "Zinnia elegans",
                "image_url": self.base64_images.get("zinnia-elegans", {}).get("í•‘í¬", ""),
                "keywords": ["ì§€ì†ì„±", "ê¸°ë…", "ì¶”ì–µ", "í™”ë ¤í•¨", "ì—¬ë¦„", "ë°ì€ ë¯¸ë˜", "ê¸°ì¨"],
                "colors": ["í•‘í¬"],
                "emotions": ["í¬ë§", "ê¸°ì¨", "ê²©ë ¤", "ì• í‹‹í•¨", "ê·¸ë¦¬ì›€", "ìœ„ë¡œ"],
                "moods": ["ë¹„ë¹„ë“œ", "ë‚´ì¶”ëŸ´", "í´ë˜ì‹", "ì‹œí¬", "ìš°ì•„í•¨"]
            },
            "Tagetes Erecta": {
                "korean_name": "Tagetes Erecta",
                "scientific_name": "Tagetes Erecta",
                "image_url": self.base64_images.get("tagetes-erecta", {}).get("ì˜¤ë Œì§€", ""),
                "keywords": ["ì•„ë¦„ë‹¤ì›€", "ìì—°ìŠ¤ëŸ¬ì›€"],
                "colors": ["ì˜¤ë Œì§€"],
                "emotions": ["ì•„ë¦„ë‹¤ì›€", "ìì—°ìŠ¤ëŸ¬ì›€"]
            },
            "Zinnia Elegans": {
                "korean_name": "ë°±ì¼í™",
                "scientific_name": "Zinnia elegans",
                "image_url": self.base64_images.get("zinnia-elegans", {}).get("í•‘í¬", ""),
                "keywords": ["ì§€ì†ì„±", "ê¸°ë…", "ì¶”ì–µ", "í™”ë ¤í•¨", "ì—¬ë¦„"],
                "colors": ["í•‘í¬"],
                "emotions": ["ì§€ì†ì„±", "ê¸°ë…", "ì¶”ì–µ", "í™”ë ¤í•¨"]
            },
            "Iberis Sempervirens": {
                "korean_name": "Iberis Sempervirens",
                "scientific_name": "Iberis Sempervirens",
                "image_url": self.base64_images.get("iberis-sempervirens", {}).get("í™”ì´íŠ¸", ""),
                "keywords": ["ì•„ë¦„ë‹¤ì›€", "ìì—°ìŠ¤ëŸ¬ì›€"],
                "colors": ["í™”ì´íŠ¸"],
                "emotions": ["ì•„ë¦„ë‹¤ì›€", "ìì—°ìŠ¤ëŸ¬ì›€"]
            },
            "Iris Sanguinea": {
                "korean_name": "Iris Sanguinea",
                "scientific_name": "Iris Sanguinea",
                "image_url": self.base64_images.get("iris-sanguinea", {}).get("í¼í”Œ", ""),
                "keywords": ["ì•„ë¦„ë‹¤ì›€", "ìì—°ìŠ¤ëŸ¬ì›€"],
                "colors": ["í¼í”Œ"],
                "emotions": ["ì•„ë¦„ë‹¤ì›€", "ìì—°ìŠ¤ëŸ¬ì›€"]
            },
            "Lathyrus Odoratus": {
                "korean_name": "ìŠ¤ìœ„íŠ¸í”¼",
                "scientific_name": "Lathyrus Odoratus",
                "image_url": self.base64_images.get("lathyrus-odoratus", {}).get("í•‘í¬", ""),
                "keywords": ["ì•„ë¦„ë‹¤ì›€", "ìì—°ìŠ¤ëŸ¬ì›€", "ê°ì‚¬", "ì„¤ë ˜", "ì‚¬ë‘"],
                "colors": ["í•‘í¬"],
                "emotions": ["ì„¤ë ˜", "ê¸°ì¨", "ê°ì‚¬", "ê·¸ë¦¬ì›€", "ì• í‹‹í•¨", "ìœ„ë¡œ"],
                "moods": ["ë¡œë§¨í‹±", "ëŸ¬ë¸”ë¦¬", "íŒŒìŠ¤í…”", "ìš°ì•„í•¨", "ì‹œí¬", "ë‚´ì¶”ëŸ´"]
            },
            "Ranunculus Asiaticus": {
                "korean_name": "Ranunculus Asiaticus",
                "scientific_name": "Ranunculus Asiaticus",
                "image_url": self.base64_images.get("ranunculus-asiaticus", {}).get("ì˜¤ë Œì§€", ""),
                "keywords": ["ì•„ë¦„ë‹¤ì›€", "ìì—°ìŠ¤ëŸ¬ì›€"],
                "colors": ["ì˜¤ë Œì§€"],
                "emotions": ["ì•„ë¦„ë‹¤ì›€", "ìì—°ìŠ¤ëŸ¬ì›€"]
            },
            "Gentiana Andrewsii": {
                "korean_name": "Gentiana Andrewsii",
                "scientific_name": "Gentiana Andrewsii",
                "image_url": self.base64_images.get("gentiana-andrewsii", {}).get("ë¸”ë£¨", ""),
                "keywords": ["ì•„ë¦„ë‹¤ì›€", "ìì—°ìŠ¤ëŸ¬ì›€"],
                "colors": ["ë¸”ë£¨"],
                "emotions": ["ì•„ë¦„ë‹¤ì›€", "ìì—°ìŠ¤ëŸ¬ì›€"]
            },
            "Dianthus Caryophyllus": {
                "korean_name": "Dianthus Caryophyllus",
                "scientific_name": "Dianthus Caryophyllus",
                "image_url": self.base64_images.get("dianthus-caryophyllus", {}).get("ë ˆë“œ", ""),
                "keywords": ["ì•„ë¦„ë‹¤ì›€", "ìì—°ìŠ¤ëŸ¬ì›€"],
                "colors": ["ë ˆë“œ"],
                "emotions": ["ì•„ë¦„ë‹¤ì›€", "ìì—°ìŠ¤ëŸ¬ì›€"]
            },
            "Freesia Refracta": {
                "korean_name": "Freesia Refracta",
                "scientific_name": "Freesia Refracta",
                "image_url": self.base64_images.get("freesia-refracta", {}).get("ì˜ë¡œìš°", ""),
                "keywords": ["ì•„ë¦„ë‹¤ì›€", "ìì—°ìŠ¤ëŸ¬ì›€"],
                "colors": ["ì˜ë¡œìš°"],
                "emotions": ["ì•„ë¦„ë‹¤ì›€", "ìì—°ìŠ¤ëŸ¬ì›€"]
            },
            "Ranunculus": {
                "korean_name": "ë¼ë„Œí˜ëŸ¬ìŠ¤",
                "scientific_name": "Ranunculus asiaticus",
                "image_url": self.base64_images.get("ranunculus", {}).get("í•‘í¬", ""),
                "keywords": ["ë§¤ë ¥", "ìš°ì•„í•¨", "ì•„ë¦„ë‹¤ì›€", "ë¡œë§¨ìŠ¤"],
                "colors": ["í•‘í¬", "í™”ì´íŠ¸", "ì˜ë¡œìš°", "ì˜¤ë Œì§€"],
                "emotions": ["ë§¤ë ¥", "ìš°ì•„í•¨", "ì•„ë¦„ë‹¤ì›€", "ë¡œë§¨ìŠ¤"]
            }
        }
    
    def _load_base64_images(self):
        """Base64 ì´ë¯¸ì§€ ë°ì´í„° ë¡œë“œ"""
        try:
            # í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬ì—ì„œ ì§ì ‘ ì°¾ê¸°
            import os
            base64_path = os.path.join(os.getcwd(), "base64_images.json")
            
            print(f"ğŸ” Base64 ì´ë¯¸ì§€ ê²½ë¡œ: {base64_path}")
            print(f"ğŸ” í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬: {os.getcwd()}")
            
            if not os.path.exists(base64_path):
                print(f"âŒ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ: {base64_path}")
                return {}
            
            with open(base64_path, "r", encoding="utf-8") as f:
                data = json.load(f)
                print(f"âœ… Base64 ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ: {len(data)} ê°œ í´ë”")
                print(f"ğŸ“ ì‚¬ìš© ê°€ëŠ¥í•œ í´ë”: {list(data.keys())}")
                return data
        except Exception as e:
            print(f"âŒ Base64 ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨: {e}")
            import traceback
            traceback.print_exc()
            return {}
    
    def _get_image_url(self, flower_name: str, color_keywords: List[str]) -> str:
        """ìƒ‰ìƒì— ë§ëŠ” ì´ë¯¸ì§€ URL ë°˜í™˜"""
        flower_folder = self._get_flower_folder(flower_name)
        
        print(f"ğŸ” ì´ë¯¸ì§€ ë§¤ì¹­ ë””ë²„ê¹…:")
        print(f"  ê½ƒ ì´ë¦„: {flower_name}")
        print(f"  í´ë”ëª…: {flower_folder}")
        print(f"  ìƒ‰ìƒ í‚¤ì›Œë“œ: {color_keywords}")
        
        if not flower_folder:
            print(f"âŒ í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: {flower_folder}")
            return ""
        
        # ê½ƒë³„ ìƒ‰ìƒ ë§¤í•‘ (ìš”ì²­ ìƒ‰ìƒ â†’ ì‹¤ì œ íŒŒì¼ëª…)
        color_mapping = self._get_flower_color_mapping(flower_name)
        
        print(f"  ìƒ‰ìƒ ë§¤í•‘ í…Œì´ë¸”: {color_mapping}")
        
        # ìƒ‰ìƒ í‚¤ì›Œë“œ ì •ë¦¬ (ë”°ì˜´í‘œ ì œê±°)
        clean_color_keywords = []
        for color in color_keywords:
            clean_color = color.strip("'\"")
            clean_color_keywords.append(clean_color)
        
        print(f"  ì •ë¦¬ëœ ìƒ‰ìƒ í‚¤ì›Œë“œ: {clean_color_keywords}")
        
        # 1ì°¨: ì •í™•í•œ ìƒ‰ìƒ ë§¤ì¹­ ì‹œë„
        for clean_keyword in clean_color_keywords:
            actual_color = color_mapping.get(clean_keyword, clean_keyword)
            image_url = f"/images/{flower_folder}/{actual_color}.webp"
            
            print(f"  ğŸ” 1ì°¨ ì‹œë„: {clean_keyword} â†’ {actual_color} â†’ {image_url}")
            
            # íŠ¹ì • ê½ƒì˜ ìƒ‰ìƒ í´ë°± ê·œì¹™ ì ìš©
            if self._is_color_available(flower_name, actual_color):
                print(f"âœ… ì´ë¯¸ì§€ URL ìƒì„±: {image_url} (ìš”ì²­: {clean_keyword} â†’ ì‹¤ì œ: {actual_color})")
                return image_url
            else:
                print(f"âŒ ìƒ‰ìƒ íŒŒì¼ ì—†ìŒ: {actual_color}")
        
        # 2ì°¨: ìƒ‰ìƒ í´ë°± ë¡œì§
        fallback_color = self._get_fallback_color(flower_name, clean_color_keywords)
        if fallback_color:
            fallback_url = f"/images/{flower_folder}/{fallback_color}.webp"
            print(f"ğŸ”„ í´ë°± ìƒ‰ìƒ ì‚¬ìš©: {fallback_url} (ì›ë³¸: {clean_color_keywords} â†’ í´ë°±: {fallback_color})")
            return fallback_url
        
        # 3ì°¨: ê¸°ë³¸ ìƒ‰ìƒ ì‚¬ìš© (ê½ƒë³„ë¡œ ë‹¤ë¥´ê²Œ)
        flower_data = self.flower_database.get(flower_name, {})
        default_color = flower_data.get("default_color", "í™”ì´íŠ¸")
        default_url = f"/images/{flower_folder}/{default_color}.webp"
        print(f"âœ… ê¸°ë³¸ ì´ë¯¸ì§€ URL: {default_url}")
        return default_url
    
    def _is_color_available(self, flower_name: str, color: str) -> bool:
        """íŠ¹ì • ê½ƒì˜ íŠ¹ì • ìƒ‰ìƒì´ ì‚¬ìš© ê°€ëŠ¥í•œì§€ í™•ì¸"""
        if flower_name not in self.flower_database:
            return False
        
        flower_data = self.flower_database[flower_name]
        
        # available_colorsê°€ ìˆìœ¼ë©´ í•´ë‹¹ ì»¬ëŸ¬ í™•ì¸
        if "available_colors" in flower_data:
            return color in flower_data["available_colors"] and flower_data["available_colors"][color]
        
        # available ì •ë³´ê°€ ìˆìœ¼ë©´ ê¸°ë³¸ í™•ì¸
        if "available" in flower_data:
            return flower_data["available"]
        
        # available ì •ë³´ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ì ìœ¼ë¡œ ì‚¬ìš© ê°€ëŠ¥
        return True
    
    def _get_flower_color_mapping(self, flower_name: str) -> Dict[str, str]:
        """ê½ƒë³„ ìƒ‰ìƒ ë§¤í•‘ ë°˜í™˜"""
        # ìƒ‰ìƒ ë§¤í•‘ (ìƒˆë¡œìš´ ìƒ‰ìƒ ì½”ë“œ ì‹œìŠ¤í…œ)
        base_mapping = {
            # ê°•ë ¬í•œ/ë¹„ë¹„ë“œ ìƒ‰ìƒ ìš”ì²­
            "ì•Œë¡ë‹¬ë¡": "ë…¸ë‘",
            "í™”ë ¤í•œ": "ë…¸ë‘",
            "í˜•í˜•ìƒ‰ìƒ‰": "ë…¸ë‘",
            "ë¹„ë¹„ë“œ": "ë…¸ë‘",
            "ì„ ëª…í•œ": "ë…¸ë‘",
            "ê°•ë ¬í•œ": "ë…¸ë‘",
            "í¬ì¸íŠ¸": "ë ˆë“œ",
            "í¬ì¸íŠ¸ ì»¬ëŸ¬": "ë ˆë“œ",
            
            # ê¸°ë³¸ ìƒ‰ìƒë“¤ (í†µì¼ëœ ìƒ‰ìƒëª… ì‚¬ìš©)
            "í™”ì´íŠ¸": "í™”ì´íŠ¸", "white": "í™”ì´íŠ¸", "í°ìƒ‰": "í™”ì´íŠ¸", "wh": "í™”ì´íŠ¸",
            "ì•„ì´ë³´ë¦¬": "ì•„ì´ë³´ë¦¬", "ivory": "ì•„ì´ë³´ë¦¬", "iv": "ì•„ì´ë³´ë¦¬",
            "ë² ì´ì§€": "ë² ì´ì§€", "beige": "ë² ì´ì§€", "be": "ë² ì´ì§€",
            "ì˜ë¡œìš°": "ì˜ë¡œìš°", "yellow": "ì˜ë¡œìš°", "yl": "ì˜ë¡œìš°", "ë…¸ë‘": "ì˜ë¡œìš°",
            "ì˜¤ë Œì§€": "ì˜¤ë Œì§€", "orange": "ì˜¤ë Œì§€", "or": "ì˜¤ë Œì§€",
            "ì½”ë„": "ì½”ë„", "coral": "ì½”ë„", "cr": "ì½”ë„",
            "í•‘í¬": "í•‘í¬", "pink": "í•‘í¬", "pk": "í•‘í¬",
            "ë ˆë“œ": "ë ˆë“œ", "red": "ë ˆë“œ", "rd": "ë ˆë“œ", "ë¹¨ê°•": "ë ˆë“œ",
            "ë¼ì¼ë½": "ë¼ì¼ë½", "lilac": "ë¼ì¼ë½", "ll": "ë¼ì¼ë½", "ë¼ë²¤ë”": "ë¼ì¼ë½",
            "í¼í”Œ": "í¼í”Œ", "purple": "í¼í”Œ", "pu": "í¼í”Œ", "ë³´ë¼": "í¼í”Œ",
            "ë¸”ë£¨": "ë¸”ë£¨", "blue": "ë¸”ë£¨", "bl": "ë¸”ë£¨", "íŒŒë‘": "ë¸”ë£¨", "ì˜…ì€ ë¸”ë£¨": "ë¸”ë£¨",
            "ê·¸ë¦°": "ê·¸ë¦°", "green": "ê·¸ë¦°", "gn": "ê·¸ë¦°", "ì´ˆë¡": "ê·¸ë¦°",
            
            # ê¸°ì¡´ í˜¸í™˜ì„± ìœ ì§€
            "í¬ë¦¼": "ì•„ì´ë³´ë¦¬", "cream": "ì•„ì´ë³´ë¦¬",
            "ì—°í•‘í¬": "í•‘í¬", "light-pink": "í•‘í¬",
            "ì—°ë³´ë¼": "ë¼ì¼ë½"
        }
        
        # ê½ƒë³„ íŠ¹ë³„ ë§¤í•‘ (ê¸°ì¡´ í˜¸í™˜ì„± ìœ ì§€)
        flower_specific_mapping = {
            "Alstroemeria Spp": {
                "ì˜ë¡œìš°": "ì˜¤ë Œì§€",
                "yellow": "ì˜¤ë Œì§€",
                "ë…¸ë‘": "ì˜¤ë Œì§€",
                "ë¸”ë£¨": "í™”ì´íŠ¸",
                "blue": "í™”ì´íŠ¸",
                "íŒŒë‘": "í™”ì´íŠ¸"
            },
            "Gerbera Daisy": {
                "ì˜ë¡œìš°": "ì˜ë¡œìš°",
                "yellow": "ì˜ë¡œìš°",
                "ë…¸ë‘": "ì˜ë¡œìš°",
                "ì˜¤ë Œì§€": "ì˜¤ë Œì§€",
                "orange": "ì˜¤ë Œì§€"
            },
            "Dahlia": {
                "ì˜ë¡œìš°": "ì˜ë¡œìš°",
                "yellow": "ì˜ë¡œìš°",
                "ë…¸ë‘": "ì˜ë¡œìš°",
                "ì˜¤ë Œì§€": "ì˜¤ë Œì§€",
                "orange": "ì˜¤ë Œì§€"
            },
            "Tulip": {
                "ì˜ë¡œìš°": "ì˜ë¡œìš°",
                "yellow": "ì˜ë¡œìš°",
                "ë…¸ë‘": "ì˜ë¡œìš°",
                "ê·¸ë¦°": "ê·¸ë¦°",
                "green": "ê·¸ë¦°"
            },
            "Lily": {
                "í¬ë¦¼": "ì•„ì´ë³´ë¦¬",
                "cream": "ì•„ì´ë³´ë¦¬",
                "ì•„ì´ë³´ë¦¬": "ì•„ì´ë³´ë¦¬",
                "ivory": "ì•„ì´ë³´ë¦¬",
                "ì—°í•‘í¬": "í•‘í¬",
                "light-pink": "í•‘í¬",
                "ì—°ë³´ë¼": "ë¼ì¼ë½"
            }
        }
        
        # ê¸°ë³¸ ë§¤í•‘ì— ê½ƒë³„ íŠ¹ë³„ ë§¤í•‘ ì¶”ê°€
        if flower_name in flower_specific_mapping:
            base_mapping.update(flower_specific_mapping[flower_name])
        
        return base_mapping
    
    def _is_color_available(self, flower_name: str, color: str) -> bool:
        """í•´ë‹¹ ê½ƒì˜ ìƒ‰ìƒì´ ì‹¤ì œë¡œ ì‚¬ìš© ê°€ëŠ¥í•œì§€ í™•ì¸"""
        # ì‹¤ì œ íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ëŠ” ë¡œì§
        # í˜„ì¬ëŠ” ê°„ë‹¨í•œ ë§¤í•‘ìœ¼ë¡œ ì²˜ë¦¬
        available_colors = {
            "gerbera-daisy": ["ì˜ë¡œìš°", "ì˜¤ë Œì§€", "ë ˆë“œ", "í•‘í¬"],
            "tulip": ["ë ˆë“œ", "í™”ì´íŠ¸", "ì˜ë¡œìš°", "í•‘í¬", "í¼í”Œ"],
            "lily": ["í™”ì´íŠ¸", "ì•„ì´ë³´ë¦¬", "í•‘í¬", "ë¼ì¼ë½"],
            "hydrangea": ["í•‘í¬", "ë¸”ë£¨", "í¼í”Œ", "ë¼ì¼ë½"],
            "scabiosa": ["í™”ì´íŠ¸", "ë¸”ë£¨", "í¼í”Œ", "ë¼ì¼ë½"],
            "stock-flower": ["í¼í”Œ", "í™”ì´íŠ¸", "í•‘í¬", "ë¼ì¼ë½"],
            "rose": ["ë ˆë“œ", "í•‘í¬", "í™”ì´íŠ¸", "í¼í”Œ", "ë¼ì¼ë½"],
            "garden-peony": ["í™”ì´íŠ¸", "í•‘í¬", "ì•„ì´ë³´ë¦¬", "ë¼ì¼ë½"],
            "lisianthus": ["í™”ì´íŠ¸", "ì•„ì´ë³´ë¦¬", "í•‘í¬", "ë¼ì¼ë½"],
            "bouvardia": ["í™”ì´íŠ¸", "ì•„ì´ë³´ë¦¬", "í•‘í¬"],
            "drumstick-flower": ["ì˜ë¡œìš°", "ì˜¤ë Œì§€"],
            "cotton-plant": ["í™”ì´íŠ¸", "ì•„ì´ë³´ë¦¬", "ë² ì´ì§€"],
            "cockscomb": ["ë ˆë“œ", "ì˜¤ë Œì§€", "ì˜ë¡œìš°"],
            "globe-amaranth": ["í¼í”Œ", "í•‘í¬", "í™”ì´íŠ¸", "ë¼ì¼ë½"],
            "marguerite-daisy": ["í™”ì´íŠ¸", "ì•„ì´ë³´ë¦¬"],
            "babys-breath": ["í™”ì´íŠ¸", "ì•„ì´ë³´ë¦¬"],
            "dahlia": ["ì˜ë¡œìš°", "í•‘í¬", "ì˜¤ë Œì§€", "ë ˆë“œ"],
            
            "gladiolus": ["ë ˆë“œ", "í•‘í¬", "í™”ì´íŠ¸", "ì˜ë¡œìš°"],
            "astilbe-japonica": ["í•‘í¬"],
            "ranunculus": ["í•‘í¬", "í™”ì´íŠ¸", "ì˜ë¡œìš°", "ì˜¤ë Œì§€"],
            "alstroemeria-spp": ["í•‘í¬"],
            "ammi-majus": ["í™”ì´íŠ¸"],
            "anemone-coronaria": ["ë ˆë“œ", "í¼í”Œ"],
            "anthurium-andraeanum": ["ë ˆë“œ", "ê·¸ë¦°"],
            "cymbidium-spp": ["í™”ì´íŠ¸", "í•‘í¬"],
            "veronica-spicata": ["í¼í”Œ"],
            "zinnia-elegans": ["í•‘í¬"]
        }
        
        flower_folder = self._get_flower_folder(flower_name)
        return color in available_colors.get(flower_folder, [])
    
    def _get_fallback_color(self, flower_name: str, requested_colors: List[str]) -> str:
        """ìƒ‰ìƒ í´ë°± ë¡œì§"""
        flower_folder = self._get_flower_folder(flower_name)
        
        # ë¸”ë£¨ â†’ í¼í”Œ í´ë°± ê·œì¹™
        if "ë¸”ë£¨" in requested_colors or "blue" in requested_colors:
            if self._is_color_available(flower_name, "í¼í”Œ"):
                return "í¼í”Œ"
            elif self._is_color_available(flower_name, "í•‘í¬"):
                return "í•‘í¬"
        
        # í¼í”Œ â†’ ë¸”ë£¨ í´ë°± ê·œì¹™
        if "í¼í”Œ" in requested_colors or "purple" in requested_colors:
            if self._is_color_available(flower_name, "ë¸”ë£¨"):
                return "ë¸”ë£¨"
            elif self._is_color_available(flower_name, "í•‘í¬"):
                return "í•‘í¬"
        
        # í•‘í¬ â†’ í™”ì´íŠ¸ í´ë°± ê·œì¹™
        if "í•‘í¬" in requested_colors or "pink" in requested_colors:
            if self._is_color_available(flower_name, "í™”ì´íŠ¸"):
                return "í™”ì´íŠ¸"
        
        # ë…¸ë‘ â†’ í™”ì´íŠ¸ í´ë°± ê·œì¹™
        if "ë…¸ë‘" in requested_colors or "yellow" in requested_colors:
            if self._is_color_available(flower_name, "í™”ì´íŠ¸"):
                return "í™”ì´íŠ¸"
        
        # ì˜¤ë Œì§€ â†’ ë…¸ë‘ í´ë°± ê·œì¹™
        if "ì˜¤ë Œì§€" in requested_colors or "orange" in requested_colors:
            if self._is_color_available(flower_name, "ë…¸ë‘"):
                return "ë…¸ë‘"
            elif self._is_color_available(flower_name, "í™”ì´íŠ¸"):
                return "í™”ì´íŠ¸"
        
        # ë ˆë“œ â†’ í•‘í¬ í´ë°± ê·œì¹™
        if "ë ˆë“œ" in requested_colors or "red" in requested_colors:
            if self._is_color_available(flower_name, "í•‘í¬"):
                return "í•‘í¬"
            elif self._is_color_available(flower_name, "í™”ì´íŠ¸"):
                return "í™”ì´íŠ¸"
        
        return None
    
    def _get_flower_folder(self, flower_name: str) -> str:
        """ê½ƒ ì´ë¦„ì„ í´ë”ëª…ìœ¼ë¡œ ë³€í™˜"""
        folder_mapping = {
            "Gerbera Daisy": "gerbera-daisy",
            "Dahlia": "dahlia",
            "Rose": "rose",
            "Lily": "lily",
            "Tulip": "tulip",
            "Garden Peony": "garden-peony",
            "Lisianthus": "lisianthus",
            "Hydrangea": "hydrangea",
            "Scabiosa": "scabiosa",
            "Bouvardia": "bouvardia",
            "Stock Flower": "stock-flower",
            "Drumstick Flower": "drumstick-flower",
            "Cotton Plant": "cotton-plant",
            "Cockscomb": "cockscomb",
            "Globe Amaranth": "globe-amaranth",
            "Marguerite Daisy": "marguerite-daisy",
            "Babys Breath": "babys-breath",

            "Gladiolus": "gladiolus",
            "Astilbe Japonica": "astilbe-japonica",
            "Cymbidium Spp": "cymbidium-spp",
            "Anemone Coronaria": "anemone-coronaria",
            "Anthurium Andraeanum": "anthurium-andraeanum",
            "Ammi Majus": "ammi-majus",
            "Veronica Spicata": "veronica-spicata",
            "Alstroemeria Spp": "alstroemeria-spp",
            "Zinnia Elegans": "zinnia-elegans",
            "Tagetes Erecta": "tagetes-erecta",
            "Iberis Sempervirens": "iberis-sempervirens",
            "Iris Sanguinea": "iris-sanguinea",
            "Lathyrus Odoratus": "lathyrus-odoratus",
            "Ranunculus Asiaticus": "ranunculus-asiaticus",
            "Gentiana Andrewsii": "gentiana-andrewsii",
            "Dianthus Caryophyllus": "dianthus-caryophyllus",
            "Freesia Refracta": "freesia-refracta",
            "Ranunculus": "ranunculus"
        }
        return folder_mapping.get(flower_name, "")
    
    def _check_image_exists(self, folder_name: str, color: str) -> bool:
        """ì´ë¯¸ì§€ íŒŒì¼ì´ ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸"""
        import os
        image_path = f"data/images_webp/{folder_name}/{color}.webp"
        return os.path.exists(image_path)
    
    def match(self, emotions: List[EmotionAnalysis], story: str) -> FlowerMatch:
        """ê°ì •ê³¼ ì‚¬ì—°ì„ ê¸°ë°˜ìœ¼ë¡œ ê½ƒ ë§¤ì¹­"""
        if not self.openai_api_key:
            return self._fallback_match(emotions, story)
        
        try:
            import openai
            client = openai.OpenAI(api_key=self.openai_api_key)
            
            # ì‹¤ì‹œê°„ ì»¨í…ìŠ¤íŠ¸ ì¶”ì¶œê¸°ì—ì„œ ìƒ‰ìƒ ê°€ì ¸ì˜¤ê¸°
            from app.services.realtime_context_extractor import RealtimeContextExtractor
            context_extractor = RealtimeContextExtractor()
            context = context_extractor.extract_context_realtime(story)
            
            # ì‹¤ì‹œê°„ ì¶”ì¶œëœ ìƒ‰ìƒ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©
            color_keywords = context.colors if context.colors else self._extract_contextual_colors(story)
            print(f"ğŸ¨ ì‹¤ì‹œê°„ ì¶”ì¶œëœ ìƒ‰ìƒ í‚¤ì›Œë“œ: {color_keywords}")
            
            # ì›¨ë”© ë¶€ì¼€ íŠ¹ë³„ ì²˜ë¦¬
            if self._is_wedding_bouquet(story):
                return self._match_wedding_bouquet(emotions, story, color_keywords)
            
            prompt = self._create_matching_prompt(emotions, story, color_keywords)
            
            response = client.chat.completions.create(
                model="gpt-3.5-turbo",
                messages=[
                    {"role": "system", "content": "ë‹¹ì‹ ì€ ê°ì •ê³¼ ìƒ‰ìƒ ì„ í˜¸ë„ì— ë§ëŠ” ê½ƒì„ ë§¤ì¹­í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤."},
                    {"role": "user", "content": prompt}
                ],
                temperature=0.1,
                max_tokens=300
            )
            
            result = response.choices[0].message.content
            return self._parse_matching_response(result, emotions, story)
            
        except Exception as e:
            print(f"âŒ ê½ƒ ë§¤ì¹­ ì‹¤íŒ¨: {e}")
            return self._fallback_match(emotions, story)
    
    def _create_matching_prompt(self, emotions: List[EmotionAnalysis], story: str, color_keywords: List[str]) -> str:
        """ê½ƒ ë§¤ì¹­ í”„ë¡¬í”„íŠ¸ ìƒì„±"""
        emotion_text = ", ".join([f"{e.emotion}({e.percentage}%)" for e in emotions])
        
        # ì‚¬ìš© ê°€ëŠ¥í•œ ê½ƒ ëª©ë¡ì„ ë™ì ìœ¼ë¡œ ìƒì„±
        available_flowers = []
        for flower_name, flower_data in self.flower_database.items():
            colors = ", ".join(flower_data.get("colors", []))
            keywords = ", ".join(flower_data.get("keywords", []))
            available_flowers.append(f"{flower_name}: {keywords} - {colors}")
        
        flowers_list = "\n".join([f"{i+1}. {flower}" for i, flower in enumerate(available_flowers)])
        
        return f"""
ë‹¤ìŒ ê³ ê°ì˜ ì‚¬ì—°ê³¼ ê°ì •ì— ê°€ì¥ ì í•©í•œ ê½ƒì„ ì„ íƒí•´ì£¼ì„¸ìš”:

ê³ ê° ì‚¬ì—°: "{story}"
ê°ì • ë¶„ì„: {emotion_text}
ìƒ‰ìƒ ì„ í˜¸ë„: {', '.join(color_keywords) if color_keywords else 'ì—†ìŒ'}

ì‚¬ìš© ê°€ëŠ¥í•œ ê½ƒë“¤:
{flowers_list}

**ìƒ‰ìƒë³„ ì‚¬ìš© ê°€ëŠ¥í•œ ê½ƒë“¤:**
- ë¸”ë£¨ ê³„ì—´ (ë¸”ë£¨, ì˜…ì€ ë¸”ë£¨, íŒŒë‘): Scabiosa (ìŠ¤ì¹´ë¹„ì˜¤ì‚¬), Rose (ì¥ë¯¸)
- í™”ì´íŠ¸ ê³„ì—´ (í™”ì´íŠ¸, í°ìƒ‰, ì•„ì´ë³´ë¦¬): ëŒ€ë¶€ë¶„ì˜ ê½ƒë“¤ì´ ë³´ìœ 
- í•‘í¬ ê³„ì—´ (í•‘í¬, ì—°í•‘í¬, ì˜…ì€ í•‘í¬): Rose, Alstroemeria, Lisianthus, Ranunculus, Tulip, Gerbera Daisy, Hydrangea ë“±
- ë ˆë“œ ê³„ì—´ (ë ˆë“œ, ë¹¨ê°•): Rose, Anthurium, Anemone, Tulip, Zinnia ë“±
- ì˜ë¡œìš°/ì˜¤ë Œì§€ ê³„ì—´ (ì˜ë¡œìš°, ë…¸ë‘, ì˜¤ë Œì§€): Gerbera Daisy, Dahlia, Tagetes, Ranunculus ë“±
- í¼í”Œ ê³„ì—´ (í¼í”Œ, ë³´ë¼, ë¼ì¼ë½): Lisianthus, Veronica, Stock Flower, Globe Amaranth ë“±

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:

```json
{{
    "flower_name": "ì„ íƒëœ ê½ƒ ì´ë¦„",
    "reason": "ì„ íƒ ì´ìœ "
}}
```

**ê½ƒ ì„ íƒ ê¸°ì¤€ (ìš°ì„ ìˆœìœ„ ìˆœì„œ):**

1. **ìƒ‰ìƒ ì ˆëŒ€ ìš°ì„ **: ìƒ‰ìƒ ì„ í˜¸ë„ê°€ ëª…ì‹œëœ ê²½ìš° í•´ë‹¹ ìƒ‰ìƒì´ í¬í•¨ëœ ê½ƒì„ ë°˜ë“œì‹œ ì„ íƒí•˜ì„¸ìš”
   - ìƒ‰ìƒì´ ìš”ì²­ë˜ì—ˆë‹¤ë©´ í•´ë‹¹ ìƒ‰ìƒì„ ê°€ì§„ ê½ƒ ì¤‘ì—ì„œë§Œ ì„ íƒ
   - ìƒ‰ìƒì´ ì—†ëŠ” ê½ƒì€ ì ˆëŒ€ ì„ íƒí•˜ì§€ ë§ˆì„¸ìš”
   - ì˜ˆ: "í•‘í¬" ìš”ì²­ ì‹œ í•‘í¬ ìƒ‰ìƒì´ ìˆëŠ” ê½ƒë§Œ ê³ ë ¤
   - ì˜ˆ: "ì˜…ì€ ë¸”ë£¨" ìš”ì²­ ì‹œ ë¸”ë£¨ ê³„ì—´ ìƒ‰ìƒì´ ìˆëŠ” ê½ƒë§Œ ê³ ë ¤
   - **ìƒ‰ìƒì´ ìˆìœ¼ë©´ ë‹¤ë¥¸ ëª¨ë“  ì¡°ê±´ë³´ë‹¤ ìš°ì„ í•©ë‹ˆë‹¤**
   - **ë”°ëœ»í•œ ìš°ì •/ì§€ì†ì„±**: Alstroemeria (ì•ŒìŠ¤íŠ¸ë¡œë©”ë¦¬ì•„), Veronica (ë² ë¡œë‹ˆì¹´), Zinnia (ë°±ì¼í™)
   - **í¬ë§ê³¼ ìƒˆë¡œìš´ ì‹œì‘**: Anemone (ì•„ë„¤ëª¨ë„¤), Gerbera Daisy (ê±°ë² ë¼), Tulip (íŠ¤ë¦½)
   - **ê³ ê¸‰ìŠ¤ëŸ½ê³  ì„¸ë ¨ëœ**: Cymbidium (ì‹¬ë¹„ë””ì›€), Lisianthus (ë¦¬ì‹œì•ˆì…”ìŠ¤), Garden Peony (ì‘ì•½)
   - **ì‚¬ë‘ì˜ ì¢…ë¥˜ë³„ ì„¸ë°€í•œ ë§¤ì¹­**:
     * **ì€ì€í•˜ê³  ìš°ì•„í•œ ì‚¬ë‘**: Lisianthus (ë¦¬ì‹œì•ˆì…”ìŠ¤), Garden Peony (ì‘ì•½), Cymbidium (ì‹¬ë¹„ë””ì›€)
     * **ì •ì—´ì ì´ê³  ì—´ì •ì ì¸ ì‚¬ë‘**: Anthurium (ì•ˆìŠ¤ë¦¬ì›€), Rose (ì¥ë¯¸), Ranunculus (ë¼ë„Œí˜ëŸ¬ìŠ¤)
     * **ìˆœìˆ˜í•˜ê³  ê¹¨ë—í•œ ì‚¬ë‘**: Tulip (íŠ¤ë¦½), Lily (ë°±í•©), Babys Breath (ë² ì´ë¹„ìŠ¤ë¸Œë ˆìŠ¤)
     * **ë¡œë§¨í‹±í•˜ê³  ë‹¬ì½¤í•œ ì‚¬ë‘**: Ranunculus (ë¼ë„Œí˜ëŸ¬ìŠ¤), Rose (ì¥ë¯¸), Garden Peony (ì‘ì•½)
   - **ìì—°ìŠ¤ëŸ½ê³  ë¶€ë“œëŸ¬ìš´**: Ammi Majus (ì•„ë¯¸ ë§ˆì£¼ìŠ¤), Babys Breath (ë² ì´ë¹„ìŠ¤ë¸Œë ˆìŠ¤), Cotton Plant (ëª©í™”)
   - **ë…íŠ¹í•˜ê³  ëª¨ë˜í•œ**: Astilbe Japonica (ì•„ìŠ¤í‹¸ë² ), Scabiosa (ìŠ¤ì¹´ë¹„ì˜¤ì‚¬), Drumstick Flower (ë“œëŸ¼ìŠ¤í‹±)

3. **íŠ¹ë³„í•œ ìš”ì²­ ë°˜ì˜**:
   - "ë…íŠ¹í•œ", "ìœ ë‹ˆí¬í•œ", "íŠ¹ë³„í•œ", "ëª¨ë˜í•œ", "í¬ì¸íŠ¸" â†’ ë…íŠ¹í•œ í˜•íƒœì˜ ê½ƒë“¤
   - "ë”°ëœ»í•œ", "ìœ„ë¡œ", "ì‘ì›" â†’ ë”°ëœ»í•œ ê°ì •ì˜ ê½ƒë“¤
   - "ì‹ ì„ í•œ", "ë°ì€", "í™œê¸°ì°¬" â†’ ë°ê³  ìƒë™ê° ìˆëŠ” ê½ƒë“¤
   - "ìš°ì•„í•œ", "ì„¸ë ¨ëœ", "ê³ ê¸‰ìŠ¤ëŸ¬ìš´" â†’ ìš°ì•„í•˜ê³  ì„¸ë ¨ëœ ê½ƒë“¤
   - **ì‚¬ë‘ ê´€ë ¨ ì„¸ë°€í•œ êµ¬ë¶„**:
     * "ì€ì€í•œ", "ìš°ì•„í•œ", "ê³ ê·€í•œ", "ì„¸ë ¨ëœ" â†’ Lisianthus, Garden Peony, Cymbidium
     * "ì •ì—´ì ì¸", "ì—´ì •ì ì¸", "ê°•ë ¬í•œ", "í™”ë ¤í•œ" â†’ Anthurium, Rose, Ranunculus
     * "ìˆœìˆ˜í•œ", "ê¹¨ë—í•œ", "ìˆœê²°í•œ" â†’ Tulip, Lily, Babys Breath
     * "ë¡œë§¨í‹±í•œ", "ë‹¬ì½¤í•œ", "ë¶€ë“œëŸ¬ìš´" â†’ Ranunculus, Rose, Garden Peony

4. **ì¼ë°˜ì  ê½ƒ íšŒí”¼**: "ì¥ë¯¸ëŠ” ë„ˆë¬´ ì¼ë°˜ì ", "í´ë˜ì‹í•˜ì§€ ì•Šì€" ë“±ì˜ í‘œí˜„ì´ ìˆìœ¼ë©´ Rose, Lily, Garden Peony ë“± ì¼ë°˜ì ì¸ ê½ƒì€ í”¼í•˜ì„¸ìš”

5. **ì‚¬ì—°ì—ì„œ ì–¸ê¸‰ëœ ê½ƒ**: íŠ¹ì • ê½ƒì„ ì–¸ê¸‰í–ˆë‹¤ë©´ í•´ë‹¹ ê½ƒì„ ìš°ì„ ì ìœ¼ë¡œ ê³ ë ¤í•˜ì„¸ìš”

**í•µì‹¬ ì›ì¹™**: 
1. **ìƒ‰ìƒì´ ìš”ì²­ë˜ì—ˆë‹¤ë©´ ë°˜ë“œì‹œ í•´ë‹¹ ìƒ‰ìƒì„ ê°€ì§„ ê½ƒì„ ì„ íƒí•˜ì„¸ìš”**
2. **ìƒ‰ìƒì´ ì—†ëŠ” ê½ƒì€ ì ˆëŒ€ ì„ íƒí•˜ì§€ ë§ˆì„¸ìš”**
3. **"í•‘í¬" ìš”ì²­ ì‹œ í•‘í¬ ìƒ‰ìƒì´ ìˆëŠ” ê½ƒë§Œ ì„ íƒí•˜ì„¸ìš”**
4. **"ì˜…ì€ í•‘í¬" ìš”ì²­ ì‹œ í•‘í¬ ê³„ì—´ ê½ƒë§Œ ì„ íƒí•˜ì„¸ìš”**
5. **"ì˜…ì€ ë¸”ë£¨" ìš”ì²­ ì‹œ ë¸”ë£¨ ê³„ì—´ ê½ƒë§Œ ì„ íƒí•˜ì„¸ìš”**
6. **í•‘í¬ ê³„ì—´ì—ì„œëŠ” Rose, Alstroemeria, Lisianthus, Ranunculus, Tulip, Gerbera Daisy, Hydrangea ì¤‘ì—ì„œ ì„ íƒí•˜ì„¸ìš”**
7. **ìƒ‰ìƒ ìš°ì„ ìˆœìœ„ê°€ ëª¨ë“  ë‹¤ë¥¸ ì¡°ê±´ë³´ë‹¤ ë†’ìŠµë‹ˆë‹¤**
8. ì‚¬ìš©ìì˜ ì‚¬ì—°ê³¼ ê°ì •ì— ê°€ì¥ ë”°ëœ»í•˜ê³  ì˜ë¯¸ìˆëŠ” ê½ƒì„ ì„ íƒí•˜ì„¸ìš”
9. íŠ¹íˆ ì‚¬ë‘ì˜ ê²½ìš° ì€ì€í•œ ìš°ì•„í•¨ê³¼ ì •ì—´ì ì¸ ì—´ì •ì„ ì •í™•íˆ êµ¬ë¶„í•˜ì—¬ ë§¤ì¹­í•˜ì„¸ìš”

**ì¤‘ìš”**: ìƒ‰ìƒ ì„ í˜¸ë„ê°€ ëª…ì‹œëœ ê²½ìš°, í•´ë‹¹ ìƒ‰ìƒì„ ê°€ì§„ ê½ƒë“¤ ì¤‘ì—ì„œë§Œ ì„ íƒí•˜ì„¸ìš”!
"""

    def _parse_matching_response(self, response: str, emotions: List[EmotionAnalysis], story: str) -> FlowerMatch:
        """LLM ì‘ë‹µ íŒŒì‹±"""
        try:
            import json
            # JSON ë¶€ë¶„ ì¶”ì¶œ
            start = response.find('{')
            end = response.rfind('}') + 1
            if start != -1 and end != 0:
                json_str = response[start:end]
                data = json.loads(json_str)
                
                flower_name = data.get("flower_name", "")
                
                # ê½ƒ ì´ë¦„ì—ì„œ ê´„í˜¸ ì œê±° (ì˜ˆ: "Lily (ë°±í•©)" â†’ "Lily")
                if "(" in flower_name:
                    flower_name = flower_name.split("(")[0].strip()
                
                if flower_name in self.flower_database:
                    flower_data = self.flower_database[flower_name]
                    
                    # ìƒ‰ìƒì— ë§ëŠ” ì´ë¯¸ì§€ URL ìƒì„±
                    color_keywords = self._extract_contextual_colors(story)
                    image_url = self._get_image_url(flower_name, color_keywords)
                    
                    hashtags = self._generate_emotion_hashtags(emotions)
                    
                    return FlowerMatch(
                        flower_name=flower_name,
                        korean_name=flower_data["korean_name"],
                        scientific_name=flower_data["scientific_name"],
                        image_url=image_url,
                        keywords=flower_data["keywords"],
                        hashtags=hashtags,
                        color_keywords=color_keywords
                    )
            
            print(f"âŒ ê½ƒ ë§¤ì¹­ ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨: {response}")
            return self._fallback_match(emotions, story)
            
        except Exception as e:
            print(f"âŒ ê½ƒ ë§¤ì¹­ ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨: {e}")
            return self._fallback_match(emotions, story)
    
    def _fallback_match(self, emotions: List[EmotionAnalysis], story: str) -> FlowerMatch:
        """í´ë°± ë§¤ì¹­ ë¡œì§"""
        # ì‹¤ì‹œê°„ ì»¨í…ìŠ¤íŠ¸ ì¶”ì¶œê¸°ì—ì„œ ìƒ‰ìƒ ê°€ì ¸ì˜¤ê¸°
        try:
            from app.services.realtime_context_extractor import RealtimeContextExtractor
            context_extractor = RealtimeContextExtractor()
            context = context_extractor.extract_context_realtime(story)
            color_keywords = context.colors if context.colors else self._extract_contextual_colors(story)
        except:
            color_keywords = self._extract_contextual_colors(story)
        
        print(f"ğŸ¨ í´ë°± - ì‹¤ì‹œê°„ ì¶”ì¶œëœ ìƒ‰ìƒ í‚¤ì›Œë“œ: {color_keywords}")
        
        # ìƒ‰ìƒ ìš°ì„  ë§¤ì¹­ - ì ˆëŒ€ ìš°ì„ ìˆœìœ„
        if color_keywords:
            color_flower_map = {
                "ë¸”ë£¨": ["Scabiosa", "Rose"],
                "ì˜…ì€ ë¸”ë£¨": ["Scabiosa", "Rose"],
                "íŒŒë‘": ["Scabiosa", "Rose"],
                "í•‘í¬": ["Rose", "Alstroemeria", "Lisianthus", "Ranunculus", "Tulip", "Gerbera Daisy", "Hydrangea"],
                "ì—°í•‘í¬": ["Rose", "Alstroemeria", "Lisianthus", "Ranunculus", "Hydrangea"],
                "ì˜…ì€ í•‘í¬": ["Rose", "Alstroemeria", "Lisianthus", "Ranunculus", "Hydrangea"],
                "ë ˆë“œ": ["Rose", "Anthurium", "Anemone", "Tulip", "Zinnia"],
                "ë¹¨ê°•": ["Rose", "Anthurium", "Anemone", "Tulip", "Zinnia"],
                "ì˜ë¡œìš°": ["Gerbera Daisy", "Dahlia", "Tagetes", "Ranunculus"],
                "ë…¸ë‘": ["Gerbera Daisy", "Dahlia", "Tagetes", "Ranunculus"],
                "ì˜¤ë Œì§€": ["Gerbera Daisy", "Dahlia", "Tagetes", "Ranunculus"],
                "í¼í”Œ": ["Lisianthus", "Veronica", "Stock Flower", "Globe Amaranth"],
                "ë³´ë¼": ["Lisianthus", "Veronica", "Stock Flower", "Globe Amaranth"],
                "ë¼ì¼ë½": ["Lisianthus", "Veronica", "Stock Flower", "Globe Amaranth"]
            }
            
            # ìƒ‰ìƒì— ë§ëŠ” ê½ƒë“¤ ì°¾ê¸° (ì´ë¯¸ì§€ê°€ ìˆëŠ” ì»¬ëŸ¬ë§Œ)
            available_flowers = []
            for color in color_keywords:
                if color in color_flower_map:
                    for flower_name in color_flower_map[color]:
                        if flower_name in self.flower_database:
                            flower_data = self.flower_database[flower_name]
                            # available_colorsê°€ ìˆìœ¼ë©´ í•´ë‹¹ ì»¬ëŸ¬ í™•ì¸, ì—†ìœ¼ë©´ ê¸°ë³¸ available í™•ì¸
                            if "available_colors" in flower_data:
                                if color in flower_data["available_colors"] and flower_data["available_colors"][color]:
                                    available_flowers.append(flower_name)
                            elif "available" in flower_data and flower_data["available"]:
                                available_flowers.append(flower_name)
                            elif "available" not in flower_data:  # available ì •ë³´ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ì ìœ¼ë¡œ ì‚¬ìš© ê°€ëŠ¥
                                available_flowers.append(flower_name)
            
            if available_flowers:
                import random
                flower_name = random.choice(available_flowers)
                print(f"ğŸ¨ ìƒ‰ìƒ ìš°ì„  ë§¤ì¹­: {color_keywords} â†’ {flower_name}")
                # ìƒ‰ìƒì´ ìˆìœ¼ë©´ ë¬´ì¡°ê±´ ìƒ‰ìƒ ìš°ì„  ë§¤ì¹­ ì‚¬ìš©
            else:
                # ìƒ‰ìƒì— ë§ëŠ” ê½ƒì´ ì—†ìœ¼ë©´ ë‹¤ë¥¸ ìƒ‰ìƒìœ¼ë¡œ fallback
                print(f"âš ï¸ ìš”ì²­ëœ ìƒ‰ìƒ {color_keywords}ì— ë§ëŠ” ê½ƒì´ ì—†ì–´ ë‹¤ë¥¸ ìƒ‰ìƒìœ¼ë¡œ fallback")
                flower_name = self._get_fallback_flower_by_context(story)
        else:
            # ìƒ‰ìƒ ìš”ì²­ì´ ì—†ìœ¼ë©´ ì¼ë°˜ ë¡œì§ ì‚¬ìš©
            flower_name = self._get_fallback_flower_by_context(story)
        
        flower_data = self.flower_database[flower_name]
        image_url = self._get_image_url(flower_name, color_keywords)
        hashtags = self._generate_emotion_hashtags(emotions)
        
        return FlowerMatch(
            flower_name=flower_name,
            korean_name=flower_data["korean_name"],
            scientific_name=flower_data["scientific_name"],
            image_url=image_url,
            keywords=flower_data["keywords"],
            hashtags=hashtags,
            color_keywords=color_keywords
        )
    
    def _get_fallback_flower_by_context(self, story: str) -> str:
        """ì»¨í…ìŠ¤íŠ¸ ê¸°ë°˜ í´ë°± ê½ƒ ì„ íƒ"""
        # ìš°ì„ ìˆœìœ„ ê·œì¹™
        if any(keyword in story.lower() for keyword in ["ì•Œë¡ë‹¬ë¡", "í™”ë ¤í•œ", "í˜•í˜•ìƒ‰ìƒ‰", "ë¹„ë¹„ë“œ", "ì„ ëª…í•œ"]):
            # ì•Œë¡ë‹¬ë¡/ë¹„ë¹„ë“œ ìƒ‰ìƒ ìš”ì²­ - ê°€ì¥ ë°ê³  ì„ ëª…í•œ ê½ƒë“¤ ìš°ì„ 
            vivid_flowers = ["Gerbera Daisy", "Dahlia", "Cockscomb", "Drumstick Flower"]
            import random
            return random.choice(vivid_flowers)
        elif any(keyword in story.lower() for keyword in ["í•´ì™¸ ìœ í•™", "ìœ í•™ ì™„ë£Œ", "ëŒì•„ì™”ì–´", "ì—¬í–‰ì§€"]):
            # í•´ì™¸ ìœ í•™ ì™„ë£Œ í™˜ì˜ - ë°ê³  ê²½ì¾Œí•œ ê½ƒ ìš°ì„ 
            celebration_flowers = ["Gerbera Daisy", "Dahlia", "Tulip", "Cockscomb", "Drumstick Flower"]
            import random
            return random.choice(celebration_flowers)
        elif any(keyword in story.lower() for keyword in ["í˜•í˜•ìƒ‰ìƒ‰", "í™”ë ¤í•œ", "ì¶•í•˜", "í•©ê²©", "ì„±ì·¨"]):
            return "Dahlia"
        elif any(keyword in story.lower() for keyword in ["ìš°ë“œí†¤", "ë‚´ì¶”ëŸ´", "ì¸í…Œë¦¬ì–´"]):
            # ë‚´ì¶”ëŸ´í•œ ê½ƒë“¤ ì¤‘ì—ì„œ ì„ íƒ
            natural_flowers = ["Lily", "Lisianthus", "Garden Peony", "Cotton Plant", "Babys Breath"]
            import random
            return random.choice(natural_flowers)
        elif any(keyword in story.lower() for keyword in ["ë…íŠ¹í•œ", "ëª¨ë˜í•œ", "í¬ì¸íŠ¸"]):
            # ë…íŠ¹í•œ ê½ƒë“¤ ì¤‘ì—ì„œ ì„ íƒ
            unique_flowers = ["Scabiosa", "Drumstick Flower", "Cockscomb", "Globe Amaranth"]
            import random
            return random.choice(unique_flowers)
        elif any(keyword in story.lower() for keyword in ["ë¶€ë“œëŸ¬ìš´", "ìì—°ìŠ¤ëŸ¬ìš´", "ìˆœìˆ˜í•œ"]):
            # ë¶€ë“œëŸ¬ìš´ ê½ƒë“¤ ì¤‘ì—ì„œ ì„ íƒ
            soft_flowers = ["Babys Breath", "Marguerite Daisy", "Cotton Plant", "Lily"]
            import random
            return random.choice(soft_flowers)
        elif any(keyword in story.lower() for keyword in ["ê·¸ë¦¬ì›€", "ì¶”ì–µ", "ì´ì‚¬", "ë– ë‚¨", "20ë…„ì§€ê¸°"]):
            # ê·¸ë¦¬ì›€/ì¶”ì–µ ê´€ë ¨ ê½ƒë“¤ ì¤‘ì—ì„œ ì„ íƒ
            memory_flowers = ["Scabiosa", "Stock Flower", "Hydrangea", "Lisianthus"]
            import random
            return random.choice(memory_flowers)
        elif any(keyword in story.lower() for keyword in ["ìœ„ë¡œ", "ì‘ì›", "í˜ë“¤ì–´"]):
            return "Gerbera Daisy"
        else:
            # ì ìˆ˜ ê¸°ë°˜ ì„ íƒ
            scores = self._calculate_flower_scores(emotions, story)
            return max(scores, key=scores.get)
    
    def _calculate_flower_scores(self, emotions: List[EmotionAnalysis], story: str) -> dict:
        """ê½ƒ ì ìˆ˜ ê³„ì‚°"""
        scores = {}
        color_keywords = self._extract_contextual_colors(story)
        
        # ê·¸ë¦¬ì›€/ì¶”ì–µ ì‚¬ì—°ì—ì„œëŠ” ì¥ë¯¸ ì œì™¸
        excluded_flowers = []
        if any(keyword in story.lower() for keyword in ["ê·¸ë¦¬ì›€", "ì¶”ì–µ", "ì´ì‚¬", "ë– ë‚˜", "20ë…„ì§€ê¸°"]):
            excluded_flowers = ["Rose"]
        
        # ì‘ì—…ì‹¤/ì¸í…Œë¦¬ì–´ ì‚¬ì—°ì—ì„œëŠ” ì í•©í•œ ê½ƒë“¤ ìš°ì„ 
        preferred_flowers = []
        if any(keyword in story.lower() for keyword in ["ì‘ì—…ì‹¤", "ì¸í…Œë¦¬ì–´", "ì»¤í”¼", "ì±…", "ê³µê°„", "ë¶„ìœ„ê¸°"]):
            preferred_flowers = ["Lily", "Lisianthus", "Garden Peony", "Cotton Plant", "Babys Breath", "Hydrangea"]
        
        for flower_name, flower_data in self.flower_database.items():
            # ì œì™¸ëœ ê½ƒì€ ì ìˆ˜ ê³„ì‚°ì—ì„œ ì œì™¸
            if flower_name in excluded_flowers:
                continue
                
            score = 0.0
            
            # ê°ì • ë§¤ì¹­ ì ìˆ˜
            for emotion in emotions:
                if emotion.emotion in flower_data.get("emotions", []):
                    score += emotion.percentage * 0.01
            
            # ìƒ‰ìƒ ë§¤ì¹­ ì ìˆ˜
            for color in color_keywords:
                if color in flower_data.get("colors", []):
                    score += 0.3
            
            # ì‚¬ì—° í‚¤ì›Œë“œ ë§¤ì¹­ ì ìˆ˜
            story_lower = story.lower()
            for keyword in flower_data.get("keywords", []):
                if keyword in story_lower:
                    score += 0.2
            
            # ì„ í˜¸í•˜ëŠ” ê½ƒë“¤ì— ì¶”ê°€ ì ìˆ˜
            if flower_name in preferred_flowers:
                score += 0.5
                print(f"â­ ì„ í˜¸ ê½ƒ ì¶”ê°€ ì ìˆ˜: {flower_name}")
            
            scores[flower_name] = score
        
        print(f"ğŸ“Š ê½ƒ ì ìˆ˜: {scores}")
        return scores
    
    def _is_wedding_bouquet(self, story: str) -> bool:
        """ì›¨ë”© ë¶€ì¼€ ê´€ë ¨ ì‚¬ì—°ì¸ì§€ í™•ì¸"""
        wedding_keywords = ["ê²°í˜¼ì‹", "ë¶€ì¼€", "ì›¨ë”©", "ì‹ ë¶€", "ë“œë ˆìŠ¤", "ë¯¸ë‹ˆë©€", "ì‹¬í”Œ", "í¬ì¸íŠ¸ ì»¬ëŸ¬"]
        story_lower = story.lower()
        return any(keyword in story_lower for keyword in wedding_keywords)
    
    def _match_wedding_bouquet(self, emotions: List[EmotionAnalysis], story: str, color_keywords: List[str]) -> FlowerMatch:
        """ì›¨ë”© ë¶€ì¼€ íŠ¹ë³„ ë§¤ì¹­"""
        # ì›¨ë”© ë¶€ì¼€ìš© ê³ ê¸‰ ê½ƒë“¤ (ìš°ì„ ìˆœìœ„ ìˆœì„œ)
        wedding_flowers = [
            "Garden Peony",  # ì‘ì•½ - ê°€ì¥ ê³ ê¸‰ìŠ¤ëŸ½ê³  ìš°ì•„í•¨
            "Lisianthus",    # ë¦¬ì‹œì•ˆì…”ìŠ¤ - ì„¸ë ¨ë˜ê³  ê³ ê¸‰ìŠ¤ëŸ¬ì›€
            "Rose",          # ì¥ë¯¸ - í´ë˜ì‹í•˜ê³  ìš°ì•„í•¨
            "Lily",          # ë°±í•© - ìˆœìˆ˜í•˜ê³  ê³ ê·€í•¨
            "Hydrangea",     # ìˆ˜êµ­ - í’ì„±í•˜ê³  ìš°ì•„í•¨
            "Scabiosa",      # ìŠ¤ì¹´ë¹„ì˜¤ì‚¬ - ëª¨ë˜í•˜ê³  ì„¸ë ¨ë¨
            "Bouvardia",     # ë¶€ë°”ë¥´ë””ì•„ - ìš°ì•„í•˜ê³  ì„¸ë ¨ë¨
            "Tulip",         # íŠ¤ë¦½ - ì‹ ì„ í•˜ê³  ìš°ì•„í•¨
            "Dahlia",        # ë‹¤ì•Œë¦¬ì•„ - í™”ë ¤í•˜ê³  í˜„ëŒ€ì 
            "Gerbera Daisy"  # ê±°ë² ë¼ - ë°ê³  í™œê¸°ì°¸
        ]
        
        # í¬ì¸íŠ¸ ì»¬ëŸ¬ê°€ ìˆëŠ” ê²½ìš° ë¹„ë¹„ë“œí•œ ìƒ‰ìƒìœ¼ë¡œ ë§¤í•‘
        if color_keywords:
            for color in color_keywords:
                if "í¬ì¸íŠ¸" in color or "ì»¬ëŸ¬" in color:
                    # í¬ì¸íŠ¸ ì»¬ëŸ¬ëŠ” ë¹„ë¹„ë“œí•œ ìƒ‰ìƒìœ¼ë¡œ ë§¤í•‘ (í™”ì´íŠ¸ ì œì™¸)
                    vivid_colors = ["í•‘í¬", "ë ˆë“œ", "ì˜¤ë Œì§€", "ì˜ë¡œìš°", "í¼í”Œ", "ë¸”ë£¨"]
                    for vivid_color in vivid_colors:
                        for flower_name in wedding_flowers:
                            flower_data = self.flower_database.get(flower_name, {})
                            available_colors = flower_data.get("colors", [])
                            if vivid_color in available_colors:
                                # ì‹¤ì œ ì´ë¯¸ì§€ íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
                                image_folder = self._get_flower_folder(flower_name)
                                if self._check_image_exists(image_folder, vivid_color):
                                    print(f"ğŸ¨ ì›¨ë”© ë¶€ì¼€ í¬ì¸íŠ¸ ì»¬ëŸ¬ ë§¤ì¹­: {flower_name} - {vivid_color}")
                                    return self._create_flower_match(flower_name, [vivid_color], story)
        
        # ê¸°ë³¸ì ìœ¼ë¡œ ê°€ì¥ ê³ ê¸‰ìŠ¤ëŸ¬ìš´ ê½ƒ ì„ íƒ (ì‹¤ì œ ì´ë¯¸ì§€ê°€ ìˆëŠ” ìƒ‰ìƒìœ¼ë¡œ)
        return self._fallback_match(emotions, story)
    
    def _extract_contextual_colors(self, story: str) -> List[str]:
        """ë§¥ë½ ê¸°ë°˜ ìƒ‰ìƒ ì¶”ì¶œ"""
        try:
            # RealtimeContextExtractorì˜ ì˜¬ë°”ë¥¸ ë©”ì„œë“œ í˜¸ì¶œ
            context = self.context_extractor.extract_context_realtime(story)
            return context.colors
        except Exception as e:
            print(f"âŒ ì»¨í…ìŠ¤íŠ¸ ì¶”ì¶œ ì‹¤íŒ¨: {e}")
            # í´ë°± ìƒ‰ìƒ ì¶”ì¶œ
            return self._fallback_color_extraction(story)
    
    def _fallback_color_extraction(self, story: str) -> List[str]:
        """í´ë°± ìƒ‰ìƒ ì¶”ì¶œ ë¡œì§"""
        story_lower = story.lower()
        
        # ëª…ì‹œì  ìƒ‰ìƒ ìš”ì²­ ìš°ì„  ì²˜ë¦¬
        explicit_colors = self._extract_explicit_colors(story)
        if explicit_colors:
            return explicit_colors
        
        # ë§¥ë½ ê¸°ë°˜ ìƒ‰ìƒ ì¶”ì²œ
        contextual_colors = []
        
        # ìœ„ë¡œ/íë§ ê´€ë ¨ ìƒ‰ìƒ
        if any(word in story_lower for word in ["ìœ„ë¡œ", "íë§", "í¸ì•ˆ", "ì°¨ë¶„", "ê°€ë²¼ìš´", "í•œê²°"]):
            contextual_colors = ["ë¸”ë£¨", "í¼í”Œ", "í¬ë¦¼", "í™”ì´íŠ¸"]
        
        # í¬ë§/ê¸°ì¨/ì¶•í•˜ ê´€ë ¨ ìƒ‰ìƒ
        elif any(word in story_lower for word in ["í¬ë§", "ê¸°ì¨", "ë°", "í™œê¸°", "ê²½ì¾Œ", "ì¶•í•˜", "í•©ê²©", "ì„±ì·¨"]):
            contextual_colors = ["ë…¸ë‘", "ì˜¤ë Œì§€", "í•‘í¬", "ë ˆë“œ"]
        
        # í˜•í˜•ìƒ‰ìƒ‰/í™”ë ¤í•œ ìƒ‰ìƒ
        elif any(word in story_lower for word in ["í˜•í˜•ìƒ‰ìƒ‰", "í™”ë ¤", "ë‹¤ì–‘í•œ", "ì»¬ëŸ¬í’€"]):
            contextual_colors = ["ë…¸ë‘", "ì˜¤ë Œì§€", "í•‘í¬", "ë ˆë“œ", "í¼í”Œ"]
        
        # ì‚¬ë‘/ë¡œë§¨ìŠ¤ ê´€ë ¨ ìƒ‰ìƒ
        elif any(word in story_lower for word in ["ì‚¬ë‘", "ë¡œë§¨ìŠ¤", "ê³ ë°±", "ì—°ì¸"]):
            contextual_colors = ["í•‘í¬", "ë ˆë“œ", "í™”ì´íŠ¸"]
        
        # ê·¸ë¦°í†¤ ì†ŒíŒŒì™€ ì–´ìš¸ë¦¬ëŠ” ìƒ‰ìƒ
        elif "ê·¸ë¦°" in story_lower or "green" in story_lower:
            contextual_colors = ["ê·¸ë¦°", "í™”ì´íŠ¸", "í¬ë¦¼"]
        
        # ìš°ë“œí†¤/ë‚´ì¶”ëŸ´ ê´€ë ¨ ìƒ‰ìƒ
        elif "ìš°ë“œí†¤" in story_lower or "ë‚´ì¶”ëŸ´" in story_lower:
            contextual_colors = ["ê·¸ë¦°", "í™”ì´íŠ¸", "í¬ë¦¼", "ë² ì´ì§€"]
        
        # ê°•ë ¬í•œ í¬ì¸íŠ¸ ìƒ‰ìƒ
        elif any(word in story_lower for word in ["ê°•ë ¬", "í¬ì¸íŠ¸", "ëŒ€ë¹„"]):
            contextual_colors = ["ë…¸ë‘", "ì˜¤ë Œì§€", "ë¹¨ê°•"]
        
        # ê¸°ë³¸ ìœ„ë¡œ ìƒ‰ìƒ (ì•„ë¬´ ì¡°ê±´ë„ ë§Œì¡±í•˜ì§€ ì•Šì„ ë•Œ)
        if not contextual_colors:
            contextual_colors = ["í¬ë¦¼", "í™”ì´íŠ¸", "ì—°í•‘í¬"]
        
        return contextual_colors[:2]  # ìµœëŒ€ 2ê°œ ìƒ‰ìƒ ì¶”ì¶œ
    
    def _extract_explicit_colors(self, story: str) -> List[str]:
        """ëª…ì‹œì  ìƒ‰ìƒ ìš”ì²­ ì¶”ì¶œ"""
        import re
        color_mapping = {
            "ê·¸ë¦°": "ê·¸ë¦°", "green": "ê·¸ë¦°",
            "ì˜ë¡œìš°": "ì˜ë¡œìš°", "yellow": "ì˜ë¡œìš°", "ë…¸ë‘": "ì˜ë¡œìš°",
            "í•‘í¬": "í•‘í¬", "pink": "í•‘í¬",
            "í™”ì´íŠ¸": "í™”ì´íŠ¸", "white": "í™”ì´íŠ¸", "í°ìƒ‰": "í™”ì´íŠ¸",
            "ë¸”ë£¨": "ë¸”ë£¨", "blue": "ë¸”ë£¨", "íŒŒë‘": "ë¸”ë£¨",
            "ë ˆë“œ": "ë ˆë“œ", "red": "ë ˆë“œ", "ë¹¨ê°•": "ë ˆë“œ",
            "í¼í”Œ": "í¼í”Œ", "purple": "í¼í”Œ", "ë³´ë¼": "í¼í”Œ",
            "ì˜¤ë Œì§€": "ì˜¤ë Œì§€", "orange": "ì˜¤ë Œì§€"
        }

        extracted_colors = []

        # "ê·¸ë¦°Â·ì˜ë¡œìš°" ê°™ì€ ì¡°í•© íŒ¨í„´ ì°¾ê¸°
        patterns = [
            r'ê·¸ë¦°[Â·\s]*ì˜ë¡œìš°',
            r'ì˜ë¡œìš°[Â·\s]*ê·¸ë¦°',
            r'green[Â·\s]*yellow',
            r'yellow[Â·\s]*green',
            r'ê·¸ë¦°[Â·\s]*ë…¸ë‘',
            r'ë…¸ë‘[Â·\s]*ê·¸ë¦°'
        ]

        for pattern in patterns:
            if re.search(pattern, story, re.IGNORECASE):
                if "ê·¸ë¦°" in pattern or "green" in pattern:
                    extracted_colors.append("ê·¸ë¦°")
                if "ì˜ë¡œìš°" in pattern or "yellow" in pattern or "ë…¸ë‘" in pattern:
                    extracted_colors.append("ì˜ë¡œìš°")
                return extracted_colors

        # ê°œë³„ ìƒ‰ìƒ í‚¤ì›Œë“œ ì°¾ê¸°
        for keyword, color in color_mapping.items():
            if keyword in story.lower():
                if color not in extracted_colors:
                    extracted_colors.append(color)

        return extracted_colors[:3]  # ìµœëŒ€ 3ê°œ
    
    def _generate_emotion_hashtags(self, emotions: List[EmotionAnalysis]) -> List[str]:
        """ê°ì • ê¸°ë°˜ í•´ì‹œíƒœê·¸ ìƒì„±"""
        hashtags = []
        for emotion in emotions[:3]:  # ìƒìœ„ 3ê°œ ê°ì •
            hashtags.append(f"#{emotion.emotion}")
        return hashtags
