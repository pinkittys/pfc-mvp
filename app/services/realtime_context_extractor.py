"""
ì‹¤ì‹œê°„ LLM ê¸°ë°˜ ë§¥ë½ ì¶”ì¶œ ì„œë¹„ìŠ¤
"""
import os
import json
from typing import Dict, List, Any, Optional
from dataclasses import dataclass, field

# .env íŒŒì¼ ë¡œë“œ
try:
    from dotenv import load_dotenv
    load_dotenv()
except ImportError:
    print("âš ï¸  python-dotenvê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. pip install python-dotenv")

@dataclass
class ExtractedContext:
    """ì¶”ì¶œëœ ë§¥ë½ ì •ë³´"""
    emotions: List[str]  # ê°ì • (ë©”ì¸ í‚¤ì›Œë“œ 1ê°œ)
    situations: List[str]  # ìƒí™© (ë©”ì¸ í‚¤ì›Œë“œ 1ê°œ)
    moods: List[str]  # ë¬´ë“œ (ë©”ì¸ í‚¤ì›Œë“œ 1ê°œ)
    colors: List[str]  # ì»¬ëŸ¬ (ë©”ì¸ í‚¤ì›Œë“œ 1ê°œ)
    confidence: float  # ì‹ ë¢°ë„
    user_intent: str = "meaning_based"  # ì‚¬ìš©ì ì˜ë„ (meaning_based ë˜ëŠ” design_based)
    mentioned_flower: Optional[str] = None  # ì–¸ê¸‰ëœ ê½ƒ ì´ë¦„
    
    # ëŒ€ì•ˆ í‚¤ì›Œë“œ ì œì•ˆ
    emotions_alternatives: List[str] = field(default_factory=list)  # ê°ì • ëŒ€ì•ˆ í‚¤ì›Œë“œ 2-3ê°œ
    situations_alternatives: List[str] = field(default_factory=list)  # ìƒí™© ëŒ€ì•ˆ í‚¤ì›Œë“œ 2-3ê°œ
    moods_alternatives: List[str] = field(default_factory=list)  # ë¬´ë“œ ëŒ€ì•ˆ í‚¤ì›Œë“œ 2-3ê°œ
    colors_alternatives: List[str] = field(default_factory=list)  # ìƒ‰ìƒ ëŒ€ì•ˆ í‚¤ì›Œë“œ 2-3ê°œ

class RealtimeContextExtractor:
    def __init__(self):
        self.openai_api_key = os.getenv("OPENAI_API_KEY")
        if not self.openai_api_key:
            print("âš ï¸  OPENAI_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
        
        # ê½ƒ ì´ë¦„ ë§¤í•‘ ë°ì´í„° ë¡œë“œ
        self.flower_names = self._load_flower_names()
    
    def _load_flower_names(self) -> Dict[str, str]:
        """ê½ƒ ì´ë¦„ ë§¤í•‘ ë°ì´í„° ë¡œë“œ"""
        try:
            with open("data/flower_dictionary.json", 'r', encoding='utf-8') as f:
                data = json.load(f)
                flowers = data.get("flowers", {})
                
                flower_mapping = {}
                for flower_id, flower_data in flowers.items():
                    korean_name = flower_data.get("korean_name", "")
                    scientific_name = flower_data.get("scientific_name", "")
                    color = flower_data.get("color", "")
                    
                    # í•œêµ­ì–´ ì´ë¦„ ë§¤í•‘
                    if korean_name:
                        flower_mapping[korean_name] = flower_id
                        # ë¶€ë¶„ ë§¤ì¹­ì„ ìœ„í•œ í‚¤ì›Œë“œë„ ì¶”ê°€
                        for word in korean_name.split():
                            if len(word) > 1:
                                flower_mapping[word] = flower_id
                    
                    # í•™ëª… ë§¤í•‘
                    if scientific_name:
                        flower_mapping[scientific_name] = flower_id
                        # ë¶€ë¶„ ë§¤ì¹­ì„ ìœ„í•œ í‚¤ì›Œë“œë„ ì¶”ê°€
                        for word in scientific_name.split():
                            if len(word) > 2:
                                flower_mapping[word] = flower_id
                
                return flower_mapping
        except Exception as e:
            print(f"âŒ ê½ƒ ì´ë¦„ ë§¤í•‘ ë¡œë“œ ì‹¤íŒ¨: {e}")
            return {}
    
    def _detect_mentioned_flower(self, story: str) -> Optional[str]:
        """ì‚¬ìš©ìê°€ ì–¸ê¸‰í•œ ê½ƒ ì´ë¦„ ê°ì§€"""
        if not self.flower_names:
            return None
        
        story_lower = story.lower()
        
        # ê½ƒ ì´ë¦„ ë§¤ì¹­ (ê¸´ ì´ë¦„ë¶€í„° ë§¤ì¹­)
        sorted_flowers = sorted(self.flower_names.keys(), key=len, reverse=True)
        
        for flower_name in sorted_flowers:
            if flower_name.lower() in story_lower:
                print(f"ğŸŒ¸ ì–¸ê¸‰ëœ ê½ƒ ê°ì§€: {flower_name} -> {self.flower_names[flower_name]}")
                return self.flower_names[flower_name]
        
        return None
    
    def extract_context_realtime(self, story: str, emotions: List[dict] = None, excluded_keywords: List[Dict[str, str]] = None) -> ExtractedContext:
        """ì‹¤ì‹œê°„ìœ¼ë¡œ ê³ ê° ì´ì•¼ê¸°ì—ì„œ ë§¥ë½ ì¶”ì¶œ (ê°ì • ë¶„ì„ ê²°ê³¼ ë°˜ì˜, ì œì™¸ëœ í‚¤ì›Œë“œ ê³ ë ¤)"""
        # ê½ƒ ì´ë¦„ ê°ì§€
        mentioned_flower = self._detect_mentioned_flower(story)
        
        if not self.openai_api_key:
            print("ğŸ”§ OPENAI_API_KEYê°€ ì—†ì–´ì„œ fallback_extraction ì‚¬ìš©")
            result = self._fallback_extraction(story, emotions, excluded_keywords)
            result.mentioned_flower = mentioned_flower
            return result
        
        try:
            import openai
            client = openai.OpenAI(api_key=self.openai_api_key)
            
            prompt = self._create_extraction_prompt(story, emotions)
            
            response = client.chat.completions.create(
                model="gpt-4o-mini",  # ë” ë¹ ë¥´ê³  ì €ë ´í•œ ëª¨ë¸ë¡œ ë³€ê²½
                messages=[
                    {"role": "system", "content": "ê½ƒ ì¶”ì²œ í‚¤ì›Œë“œ ì¶”ì¶œ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ê°„ë‹¨í•˜ê³  ì •í™•í•˜ê²Œ ì¶”ì¶œí•´ì£¼ì„¸ìš”."},
                    {"role": "user", "content": prompt}
                ],
                temperature=0.1,
                max_tokens=100,  # í† í° ìˆ˜ ë” ì¤„ì—¬ì„œ ì†ë„ ê°œì„ 
                timeout=3  # 3ì´ˆ íƒ€ì„ì•„ì›ƒ ì„¤ì •
            )
            
            result = response.choices[0].message.content
            parsed_result = self._parse_llm_response(result, mentioned_flower)
            
            # ê°ì • ë¶„ì„ ê²°ê³¼ê°€ ìˆìœ¼ë©´ emotionsë¥¼ ê°ì • ë¶„ì„ ê²°ê³¼ë¡œ ëŒ€ì²´
            if emotions and len(emotions) > 0:
                # ê°ì • ë¶„ì„ ê²°ê³¼ì—ì„œ ê°ì •ëª…ë§Œ ì¶”ì¶œ
                emotion_names = []
                for emotion in emotions:
                    if hasattr(emotion, 'emotion'):
                        emotion_names.append(emotion.emotion)
                    elif isinstance(emotion, dict) and 'emotion' in emotion:
                        emotion_names.append(emotion['emotion'])
                
                if emotion_names:  # ê°ì •ëª…ì´ ì‹¤ì œë¡œ ì¶”ì¶œëœ ê²½ìš°ì—ë§Œ ì ìš©
                    parsed_result.emotions = emotion_names[:3]  # ìµœëŒ€ 3ê°œ ê°ì • ì‚¬ìš©
                    print(f"ğŸ”§ ê°ì • ë¶„ì„ ê²°ê³¼ ì ìš©: {emotion_names[:3]}")
                else:
                    # ê°ì • ë¶„ì„ ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ê°ì • ì¶”ì¶œ
                    parsed_result.emotions = self._extract_basic_emotions(story)
                    print(f"ğŸ”§ ê¸°ë³¸ ê°ì • ì¶”ì¶œ: {parsed_result.emotions}")
            else:
                # ê°ì • ë¶„ì„ ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ê°ì • ì¶”ì¶œ
                parsed_result.emotions = self._extract_basic_emotions(story)
                print(f"ğŸ”§ ê¸°ë³¸ ê°ì • ì¶”ì¶œ: {parsed_result.emotions}")
            
            # ìƒ‰ìƒì´ ë¹„ì–´ìˆìœ¼ë©´ fallback ë¡œì§ìœ¼ë¡œ ìƒ‰ìƒ ì¶”ì¶œ
            if not parsed_result.colors:
                print("ğŸ”§ ìƒ‰ìƒì´ ë¹„ì–´ìˆì–´ fallback ë¡œì§ìœ¼ë¡œ ìƒ‰ìƒ ì¶”ì¶œ")
                fallback_result = self._fallback_extraction(story, emotions, excluded_keywords)
                parsed_result.colors = fallback_result.colors
            else:
                print(f"ğŸ¨ LLMì—ì„œ ìƒ‰ìƒ ì¶”ì¶œë¨: {parsed_result.colors}")
            
            # ì¤‘ë³µ í‚¤ì›Œë“œ ì œê±° ë° í›„ì²˜ë¦¬
            parsed_result = self._remove_duplicates_and_postprocess(parsed_result, story)
            
            print(f"ğŸ”§ í›„ì²˜ë¦¬ëœ í‚¤ì›Œë“œ: emotions={parsed_result.emotions}, situations={parsed_result.situations}, moods={parsed_result.moods}, colors={parsed_result.colors}")
            
            # ì–¸ê¸‰ëœ ê½ƒ ì •ë³´ ì¶”ê°€
            parsed_result.mentioned_flower = mentioned_flower
            
            return parsed_result
            
        except Exception as e:
            print(f"âŒ LLM ë§¥ë½ ì¶”ì¶œ ì‹¤íŒ¨: {e}")
            return self._fallback_extraction(story, emotions)
    
    def _remove_duplicates_and_postprocess(self, context: ExtractedContext, story: str) -> ExtractedContext:
        """ì¤‘ë³µ í‚¤ì›Œë“œ ì œê±° ë° í›„ì²˜ë¦¬"""
        # ëª¨ë“  í‚¤ì›Œë“œë¥¼ í•˜ë‚˜ì˜ ë¦¬ìŠ¤íŠ¸ë¡œ ìˆ˜ì§‘
        all_keywords = []
        all_keywords.extend(context.emotions)
        all_keywords.extend(context.situations)
        all_keywords.extend(context.moods)
        all_keywords.extend(context.colors)
        
        # ì¤‘ë³µ ì œê±° (ì²« ë²ˆì§¸ ë°œê²¬ëœ ê²ƒë§Œ ìœ ì§€)
        seen_keywords = set()
        unique_keywords = []
        for keyword in all_keywords:
            if keyword not in seen_keywords:
                seen_keywords.add(keyword)
                unique_keywords.append(keyword)
        
        # í…ìŠ¤íŠ¸ ê¸¸ì´ì— ë”°ë¼ í‚¤ì›Œë“œ ìˆ˜ ì¡°ì ˆ
        text_length = len(story.strip())
        
        # ê½ƒ ë§¤ì¹­ì„ ìœ„í•´ ìµœì†Œ 4ê°œ ì°¨ì› ëª¨ë‘ í•„ìš”
        # í…ìŠ¤íŠ¸ ê¸¸ì´ì— ê´€ê³„ì—†ì´ ìµœì†Œ 4ê°œ í‚¤ì›Œë“œ ë³´ì¥
        if text_length <= 15:
            # ë§¤ìš° ì§§ì€ í…ìŠ¤íŠ¸: 4ê°œ ì°¨ì› ëª¨ë‘ ì¶”ì¶œ (ì¤‘ë³µ í—ˆìš©)
            max_keywords = 4
        elif text_length <= 40:
            # ì¤‘ê°„ í…ìŠ¤íŠ¸: 4ê°œ ì°¨ì› ëª¨ë‘ ì¶”ì¶œ
            max_keywords = 4
        else:
            # ê¸´ í…ìŠ¤íŠ¸: ë” ë§ì€ í‚¤ì›Œë“œ (4ê°œ ì´ìƒ)
            max_keywords = 6
        
        # í‚¤ì›Œë“œ ìˆ˜ ì œí•œ
        unique_keywords = unique_keywords[:max_keywords]
        
        # ì¹´í…Œê³ ë¦¬ë³„ë¡œ ì¬ë¶„ë°° (ìš°ì„ ìˆœìœ„: emotions > situations > moods > colors)
        result = ExtractedContext(
            emotions=[],
            situations=[],
            moods=[],
            colors=[],
            confidence=context.confidence,
            emotions_alternatives=context.emotions_alternatives,
            situations_alternatives=context.situations_alternatives,
            moods_alternatives=context.moods_alternatives,
            colors_alternatives=context.colors_alternatives
        )
        
        # ìƒ‰ìƒì€ í•­ìƒ ìƒ‰ìƒ ì¹´í…Œê³ ë¦¬ì— ë³´ì¡´
        original_colors = context.colors.copy()
        other_keywords = [kw for kw in unique_keywords if kw not in original_colors]
        
        # ìƒ‰ìƒ ë¨¼ì € í• ë‹¹
        for color in original_colors:
            if color not in result.colors:
                result.colors.append(color)
        
        # ë‚˜ë¨¸ì§€ í‚¤ì›Œë“œë¥¼ ìš°ì„ ìˆœìœ„ì— ë”°ë¼ ë¶„ë°° (4ê°œ ì°¨ì› ëª¨ë‘ ë³´ì¥)
        for i, keyword in enumerate(other_keywords):
            if i == 0 and len(result.emotions) == 0:
                result.emotions.append(keyword)
            elif i == 1 and len(result.situations) == 0:
                result.situations.append(keyword)
            elif i == 2 and len(result.moods) == 0:
                result.moods.append(keyword)
            elif i == 3 and len(result.emotions) == 0:
                result.emotions.append(keyword)  # emotionsê°€ ë¹„ì–´ìˆìœ¼ë©´ ì¶”ê°€
            elif i == 4 and len(result.situations) == 0:
                result.situations.append(keyword)  # situationsê°€ ë¹„ì–´ìˆìœ¼ë©´ ì¶”ê°€
            elif i == 5 and len(result.moods) == 0:
                result.moods.append(keyword)  # moodsê°€ ë¹„ì–´ìˆìœ¼ë©´ ì¶”ê°€
        
        print(f"ğŸ”§ ì¤‘ë³µ ì œê±° í›„ í‚¤ì›Œë“œ: {unique_keywords}")
        
        # 4ê°œ ì°¨ì› ëª¨ë‘ ë³´ì¥ (ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ê°’ ì œê³µ)
        if not result.emotions:
            result.emotions = self._get_default_emotions(story)
            print(f"ğŸ”§ ê¸°ë³¸ ê°ì • ì œê³µ: {result.emotions}")
        
        if not result.situations:
            result.situations = self._get_default_situations(story)
            print(f"ğŸ”§ ê¸°ë³¸ ìƒí™© ì œê³µ: {result.situations}")
        
        if not result.moods:
            result.moods = self._get_default_moods(story)
            print(f"ğŸ”§ ê¸°ë³¸ ë¬´ë“œ ì œê³µ: {result.moods}")
        
        if not result.colors:
            recommended_color = self._recommend_color_based_on_context(
                result.emotions, result.situations, result.moods, story
            )
            if recommended_color:
                result.colors.append(recommended_color)
                print(f"ğŸ¨ ì»¨í…ìŠ¤íŠ¸ ê¸°ë°˜ ìƒ‰ìƒ ì¶”ì²œ: {recommended_color}")
        
        return result
    
    def _recommend_color_based_on_context(self, emotions: List[str], situations: List[str], moods: List[str], story: str) -> str:
        """ì»¨í…ìŠ¤íŠ¸ ê¸°ë°˜ ìƒ‰ìƒ ì¶”ì²œ"""
        # ê°ì • ê¸°ë°˜ ìƒ‰ìƒ ë§¤í•‘
        emotion_color_map = {
            # ë¶€ì •ì  ê°ì • â†’ ì°¨ë¶„í•˜ê³  ìœ„ë¡œë˜ëŠ” ìƒ‰ìƒ
            "ìš°ìš¸": "ë¸”ë£¨",
            "ìŠ¬í””": "ë¸”ë£¨", 
            "ìŠ¤íŠ¸ë ˆìŠ¤": "ê·¸ë¦°",
            "í”¼ê³¤": "ê·¸ë¦°",
            "ì™¸ë¡œì›€": "ë¸”ë£¨",
            "ë¶ˆì•ˆ": "ê·¸ë¦°",
            "ë‹µë‹µí•¨": "ë¸”ë£¨",
            "ì§€ì¹¨": "ê·¸ë¦°",
            "í—ˆì „í•¨": "ë¸”ë£¨",
            "ê·¸ë¦¬ì›€": "ë¼ì¼ë½",
            "ë¯¸ì•ˆí•¨": "í™”ì´íŠ¸",
            "í›„íšŒ": "ë¸”ë£¨",
            "ë¶„ë…¸": "ê·¸ë¦°",
            "ì§€ë£¨í•¨": "ì˜ë¡œìš°",
            
            # ê¸ì •ì  ê°ì • â†’ ë°ê³  ë”°ëœ»í•œ ìƒ‰ìƒ
            "ê¸°ì¨": "ì˜ë¡œìš°",
            "ì„¤ë ˜": "í•‘í¬",
            "ê°ì‚¬": "í•‘í¬",
            "ë§Œì¡±": "ê·¸ë¦°",
            "í¬ë§": "ì˜ë¡œìš°",
            "ìì‹ ê°": "ë ˆë“œ",
            "ìš©ê¸°": "ë ˆë“œ",
            "ì—´ì •": "ì˜¤ë Œì§€",
            "ì• ì •": "í•‘í¬",
            "ë”°ëœ»í•¨": "í•‘í¬",
            "ì•ˆì •ê°": "ê·¸ë¦°",
            "í™œë ¥": "ì˜ë¡œìš°",
            "ê²©ë ¤": "í•‘í¬",
            "ì§„ì‹¬": "í™”ì´íŠ¸",
            "ìš°ì •": "í•‘í¬"
        }
        
        # ìƒí™© ê¸°ë°˜ ìƒ‰ìƒ ë§¤í•‘
        situation_color_map = {
            # ê°œì¸ì  ìƒí™©
            "ë°©ê¾¸ë¯¸ê¸°": "í™”ì´íŠ¸",
            "ì¼ìƒ": "ê·¸ë¦°",
            "íœ´ì‹ê³µê°„": "ë¸”ë£¨",
            "ê¸°ë¶„ì „í™˜": "ì˜ë¡œìš°",
            "ìŠ¤íŠ¸ë ˆìŠ¤í•´ì†Œ": "ê·¸ë¦°",
            "ìê¸°ìœ„ë¡œ": "ë¸”ë£¨",
            "íë§": "ê·¸ë¦°",
            "ëª…ìƒ": "ë¸”ë£¨",
            "ë…ì„œ": "í™”ì´íŠ¸",
            "ìš´ë™": "ê·¸ë¦°",
            "ì·¨ë¯¸í™œë™": "ì˜ë¡œìš°",
            "ìê¸°ê³„ë°œ": "ë¸”ë£¨",
            "ìƒˆë¡œìš´ì‹œì‘": "ì˜ë¡œìš°",
            
            # ëŒ€ì¸ê´€ê³„ ìƒí™©
            "ìœ„ë¡œ": "ë¸”ë£¨",
            "ê²©ë ¤": "í•‘í¬",
            "ì¶•í•˜": "ë ˆë“œ",
            "ê°ì‚¬": "í•‘í¬",
            "ì‚¬ê³¼": "í™”ì´íŠ¸",
            "ê³ ë°±": "í•‘í¬",
            "í”„ë¡œí¬ì¦ˆ": "ë ˆë“œ",
            "ìƒì¼": "í•‘í¬",
            "ê¸°ë…ì¼": "ë ˆë“œ",
            "ì¡¸ì—…": "ë¸”ë£¨",
            "í•©ê²©": "ì˜ë¡œìš°",
            "ì·¨ì—…": "ë¸”ë£¨",
            "ì´ì‚¬": "ê·¸ë¦°",
            "ì—¬í–‰": "ì˜ë¡œìš°",
            "ì„ ë¬¼": "í•‘í¬",
            "ìš°ì •": "í•‘í¬",
            "ì‚¬ë‘": "í•‘í¬",
            "ê°€ì¡±": "í•‘í¬",
            "ë™ë£Œ": "ë¸”ë£¨",
            "ì„ ìƒë‹˜": "í•‘í¬",
            "ì˜ì‚¬": "í™”ì´íŠ¸",
            "ê°„í˜¸ì‚¬": "í•‘í¬"
        }
        
        # ë¬´ë“œ ê¸°ë°˜ ìƒ‰ìƒ ë§¤í•‘
        mood_color_map = {
            "í™œê¸°ì°¬": "ì˜ë¡œìš°",
            "í¸ì•ˆí•œ": "ê·¸ë¦°",
            "ë¶€ë“œëŸ¬ìš´": "í•‘í¬",
            "ë”°ëœ»í•œ": "í•‘í¬",
            "ë°ì€": "ì˜ë¡œìš°",
            "ì‹¬í”Œí•œ": "í™”ì´íŠ¸",
            "ìì—°ìŠ¤ëŸ¬ìš´": "ê·¸ë¦°",
            "ìš°ì•„í•œ": "ë¼ì¼ë½",
            "ì‹ ë¹„ë¡œìš´": "í¼í”Œ",
            "ë¡œë§¨í‹±í•œ": "í•‘í¬",
            "ì°¨ë¶„í•œ": "ë¸”ë£¨",
            "ê³ ê¸‰ìŠ¤ëŸ¬ìš´": "í¼í”Œ",
            "ê·€ì—¬ìš´": "í•‘í¬",
            "ì„±ìˆ™í•œ": "í¼í”Œ",
            "ì²­ì¶˜ë‹¤ìš´": "í•‘í¬",
            "í˜ìˆëŠ”": "ë ˆë“œ",
            "ì‹ ë¢°ê°ìˆëŠ”": "ë¸”ë£¨",
            "í¬ë§ì°¬": "ì˜ë¡œìš°",
            "í‰í™”ë¡œìš´": "ê·¸ë¦°",
            "ì—´ì •ì ì¸": "ì˜¤ë Œì§€"
        }
        
        # ìš°ì„ ìˆœìœ„: ê°ì • > ìƒí™© > ë¬´ë“œ
        for emotion in emotions:
            if emotion in emotion_color_map:
                return emotion_color_map[emotion]
        
        for situation in situations:
            if situation in situation_color_map:
                return situation_color_map[situation]
        
        for mood in moods:
            if mood in mood_color_map:
                return mood_color_map[mood]
        
        # ê¸°ë³¸ê°’: ìƒí™©ì— ë”°ë¼
        if any(word in story for word in ["ìœ„ë¡œ", "ìŠ¬í””", "ìš°ìš¸", "í˜ë“¤"]):
            return "ë¸”ë£¨"
        elif any(word in story for word in ["ì‚¬ë‘", "ë¡œë§¨í‹±", "ê³ ë°±", "í”„ë¡œí¬ì¦ˆ"]):
            return "í•‘í¬"
        elif any(word in story for word in ["ì¶•í•˜", "ìƒì¼", "ê¸°ë…ì¼"]):
            return "ë ˆë“œ"
        elif any(word in story for word in ["íë§", "íœ´ì‹", "í¸ì•ˆ"]):
            return "ê·¸ë¦°"
        else:
            return "í•‘í¬"  # ê°€ì¥ ë²”ìš©ì ì¸ ìƒ‰ìƒ
    
    def _create_extraction_prompt(self, story: str, emotions: List[dict] = None) -> str:
        """LLM ì¶”ì¶œ í”„ë¡¬í”„íŠ¸ ìƒì„±"""
        # ê°ì • ë¶„ì„ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ìš°ì„ ì ìœ¼ë¡œ ì‚¬ìš©
        emotion_priority = ""
        if emotions and len(emotions) > 0:
            # ê°ì • ë¶„ì„ ê²°ê³¼ë¥¼ ê°•ë ¥í•˜ê²Œ ìš°ì„  ì‚¬ìš©
            emotion_names = []
            for emotion in emotions:
                if hasattr(emotion, 'emotion'):
                    emotion_names.append(emotion.emotion)
                elif isinstance(emotion, dict) and 'emotion' in emotion:
                    emotion_names.append(emotion['emotion'])
            
            if emotion_names:
                emotion_priority = f"\n\nâš ï¸ ë§¤ìš° ì¤‘ìš”: ê°ì • ë¶„ì„ ê²°ê³¼ê°€ ì´ë¯¸ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. emotions í•„ë“œì—ëŠ” ë°˜ë“œì‹œ ë‹¤ìŒ ì¤‘ í•˜ë‚˜ë§Œ ì‚¬ìš©í•˜ì„¸ìš”: {emotion_names[:3]}"
                emotion_priority += f"\n\nì ˆëŒ€ ë‹¤ë¥¸ ê°ì •ì„ ì¶”ì¶œí•˜ì§€ ë§ˆì„¸ìš”. ê°ì • ë¶„ì„ ê²°ê³¼ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì„¸ìš”."
        
        # í…ìŠ¤íŠ¸ ê¸¸ì´ì— ë”°ë¥¸ í”„ë¡¬í”„íŠ¸ ì¡°ì •
        text_length = len(story.strip())
        
        if text_length <= 15:
            # ì§§ì€ í…ìŠ¤íŠ¸: ë” ìì„¸í•œ ë¶„ì„ ìš”ì²­
            context_instruction = f"""
**ì§§ì€ í…ìŠ¤íŠ¸ ë¶„ì„ ê°€ì´ë“œ**:
í…ìŠ¤íŠ¸ê°€ ì§§ì•„ì„œ ë§¥ë½ íŒŒì•…ì´ ì–´ë ¤ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ìŒì„ ê³ ë ¤í•´ì£¼ì„¸ìš”:

1. **ê°ì • ì¶”ë¡ **: "ìœ„ë¡œí•˜ê³  ì‹¶ì–´" â†’ ìŠ¬í””/ìš°ìš¸/ìŠ¤íŠ¸ë ˆìŠ¤ ì¤‘ í•˜ë‚˜
2. **ìƒí™© ì¶”ë¡ **: "ì¹œêµ¬ê°€ ë°˜ë ¤ê²¬ì„ ìƒì—ˆì–´" â†’ ìœ„ë¡œ/ê²©ë ¤ ìƒí™©
3. **ë¬´ë“œ ì¶”ë¡ **: ìœ„ë¡œ ìƒí™©ì´ë©´ â†’ ë”°ëœ»í•œ/ë¶€ë“œëŸ¬ìš´ ë¬´ë“œ
4. **ìƒ‰ìƒ ì¶”ë¡ **: ìœ„ë¡œ/ë”°ëœ»í•¨ì´ë©´ â†’ ë¸”ë£¨/í™”ì´íŠ¸/í•‘í¬ ì¤‘ ì„ íƒ

**ì¶”ì¶œ ê·œì¹™**:
- emotions: í˜„ì¬ ëŠë¼ëŠ” ê°ì • 1ê°œ (ìš°ìš¸, ìŠ¬í””, ìŠ¤íŠ¸ë ˆìŠ¤, í”¼ê³¤, ì™¸ë¡œì›€, ë¶ˆì•ˆ, ê°ì‚¬, ê¸°ì¨, ì‚¬ë‘ ë“±)
- situations: êµ¬ì²´ì ì¸ ìƒí™©/ëª©ì  1ê°œ (ê¸°ë¶„ì „í™˜, ìê¸°ìœ„ë¡œ, ë°©ê¾¸ë¯¸ê¸°, ì¼ìƒ, íœ´ì‹ê³µê°„, ìŠ¤íŠ¸ë ˆìŠ¤í•´ì†Œ, í•©ê²©, ìƒì¼, ìœ„ë¡œ ë“±)
- moods: ì›í•˜ëŠ” ë¶„ìœ„ê¸°/ë¬´ë“œ 1ê°œ (í™œê¸°ì°¬, í¸ì•ˆí•œ, ë¶€ë“œëŸ¬ìš´, ë”°ëœ»í•œ, ë°ì€, ì‹¬í”Œí•œ, ìì—°ìŠ¤ëŸ¬ìš´, ìš°ì•„í•œ ë“±)
- colors: ì„ í˜¸í•˜ëŠ” ìƒ‰ìƒ 1ê°œ (í•‘í¬, ë ˆë“œ, ë¸”ë£¨, í™”ì´íŠ¸, ê·¸ë¦°, ì˜ë¡œìš°, ì˜¤ë Œì§€, í¼í”Œ ë“±)
"""
        else:
            # ê¸´ í…ìŠ¤íŠ¸: ë” ë‹¤ì–‘í•˜ê³  êµ¬ì²´ì ì¸ í‚¤ì›Œë“œ ì¶”ì¶œ
            context_instruction = f"""
**ë‹¤ì–‘í•œ í‚¤ì›Œë“œ ì¶”ì¶œ ê°€ì´ë“œ**:
ì‚¬ìš©ìì˜ ê³ ìœ í•œ ìƒí™©ê³¼ ê°ì •ì„ ì •í™•íˆ íŒŒì•…í•˜ì—¬ ë‹¤ì–‘í•œ í‚¤ì›Œë“œë¥¼ ì¶”ì¶œí•´ì£¼ì„¸ìš”.

**ê°ì • (emotions) - ë” êµ¬ì²´ì ìœ¼ë¡œ**:
- ë¶€ì •ì : ìš°ìš¸, ìŠ¬í””, ìŠ¤íŠ¸ë ˆìŠ¤, í”¼ê³¤, ì™¸ë¡œì›€, ë¶ˆì•ˆ, ê±±ì •, ë‹µë‹µí•¨, ì§€ì¹¨, í—ˆì „í•¨, ê·¸ë¦¬ì›€, ë¯¸ì•ˆí•¨, í›„íšŒ, ë¶„ë…¸, ì§œì¦, ì§€ë£¨í•¨
- ê¸ì •ì : ê¸°ì¨, í–‰ë³µ, ì„¤ë ˜, ì„¤ë ˜, ê°ì‚¬, ë§Œì¡±, í¬ë§, ìì‹ ê°, ìš©ê¸°, ì—´ì •, ì• ì •, ì‚¬ë‘, ë”°ëœ»í•¨, í¸ì•ˆí•¨, ì•ˆì •ê°, í™œë ¥

**ìƒí™© (situations) - ë” êµ¬ì²´ì ìœ¼ë¡œ**:
- ê°œì¸ì : ìê¸°ìœ„ë¡œ, ê¸°ë¶„ì „í™˜, ìŠ¤íŠ¸ë ˆìŠ¤í•´ì†Œ, íœ´ì‹, íë§, ëª…ìƒ, ë…ì„œ, ìš´ë™, ì·¨ë¯¸í™œë™, ìê¸°ê³„ë°œ, ìƒˆë¡œìš´ì‹œì‘, ë³€í™”
- ëŒ€ì¸ê´€ê³„: ìœ„ë¡œ, ê²©ë ¤, ì¶•í•˜, ê°ì‚¬, ì‚¬ê³¼, í™”í•´, ì¬íšŒ, ì´ë³„, ê³ ë°±, í”„ë¡œí¬ì¦ˆ, ê²°í˜¼, ìƒì¼, ì¡¸ì—…, í•©ê²©, ì·¨ì—…, ì°½ì—…
- ê³µê°„: ë°©ê¾¸ë¯¸ê¸°, ê±°ì‹¤, ì¹¨ì‹¤, ì‚¬ë¬´ì‹¤, ì¹´í˜, ì •ì›, ë°œì½”ë‹ˆ, ë² ë€ë‹¤, ì¸í…Œë¦¬ì–´, í™ˆë°ì½”, ê³µê°„ë¶„ìœ„ê¸°, ì¡°ëª…

**ë¬´ë“œ (moods) - ë” ë‹¤ì–‘í•˜ê²Œ**:
- ë”°ëœ»í•œ: ë”°ëœ»í•œ, í¬ê·¼í•œ, í¸ì•ˆí•œ, ì•ˆì •ì ì¸, ë¶€ë“œëŸ¬ìš´, ì€ì€í•œ, ì°¨ë¶„í•œ, ì¡°ìš©í•œ
- í™œê¸°ì°¬: í™œê¸°ì°¬, ê²½ì¾Œí•œ, ë°ì€, ì¦ê±°ìš´, ì‹ ë‚˜ëŠ”, ì—ë„ˆì§€ë„˜ì¹˜ëŠ”, ìƒë™ê°ìˆëŠ”, ì—­ë™ì ì¸
- ìš°ì•„í•œ: ìš°ì•„í•œ, ì„¸ë ¨ëœ, ê³ ê¸‰ìŠ¤ëŸ¬ìš´, í’ˆê²©ìˆëŠ”, í´ë˜ì‹í•œ, ëª¨ë˜í•œ, ë¯¸ë‹ˆë©€í•œ, ì‹¬í”Œí•œ
- ìì—°ìŠ¤ëŸ¬ìš´: ìì—°ìŠ¤ëŸ¬ìš´, ë‚´ì¶”ëŸ´í•œ, ê¹”ë”í•œ, ì‚°ëœ»í•œ, ì‹œì›í•œ, ì²­ëŸ‰í•œ, ìƒì¾Œí•œ
- ë¡œë§¨í‹±í•œ: ë¡œë§¨í‹±í•œ, ë‹¬ì½¤í•œ, ì‚¬ë‘ìŠ¤ëŸ¬ìš´, ì•„ë¦„ë‹¤ìš´, í™˜ìƒì ì¸, ê¿ˆê¾¸ëŠ”, ëª½í™˜ì ì¸

**ìƒ‰ìƒ (colors) - ì‹¤ì œ DB ì»¬ëŸ¬ì½”ë“œë§Œ ì‚¬ìš©**:
- **í™”ì´íŠ¸ (wh)**: "í™”ì´íŠ¸", "í°ìƒ‰", "ìˆœìˆ˜", "ê¹¨ë—í•œ"
- **ì˜¤ë Œì§€ (or)**: "ì˜¤ë Œì§€", "ì£¼í™©", "ë”°ëœ»í•œ", "í™œê¸°"
- **ë ˆë“œ (rd)**: "ë ˆë“œ", "ë¹¨ê°•", "ì—´ì •", "ì‚¬ë‘"
- **ì˜ë¡œìš° (yl)**: "ì˜ë¡œìš°", "ë…¸ë‘", "ê³¨ë“œ", "ë°ì€"
- **í•‘í¬ (pk)**: "í•‘í¬", "ë¶„í™", "ë¡œì¦ˆ", "ë¡œë§¨í‹±"
- **ë¼ì¼ë½ (ll)**: "ë¼ì¼ë½", "ì—°ë³´ë¼", "ì€ì€í•œ", "ë¶€ë“œëŸ¬ìš´"
- **ë¸”ë£¨ (bl)**: "ë¸”ë£¨", "íŒŒë‘", "ì‹œì›í•œ", "ì°¨ë¶„í•œ"
- **í¼í”Œ (pu)**: "í¼í”Œ", "ë³´ë¼", "ì‹ ë¹„ë¡œìš´", "ìš°ì•„í•œ"

**ì¤‘ìš”**: ìœ„ 8ê°œ ìƒ‰ìƒ ì¤‘ì—ì„œë§Œ ì„ íƒí•˜ì„¸ìš”. ë‹¤ë¥¸ ìƒ‰ìƒì€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.

**ì¤‘ìš”**: ëª…ì‹œì  ìƒ‰ìƒ í‘œí˜„ì´ ìˆìœ¼ë©´ ë°˜ë“œì‹œ í•´ë‹¹ ìƒ‰ìƒì„ ìš°ì„  ì¶”ì¶œí•˜ì„¸ìš”.
"""
        
        return f"""
ë‹¤ìŒ ì´ì•¼ê¸°ì—ì„œ ê½ƒ ì¶”ì²œ í‚¤ì›Œë“œë¥¼ ì¶”ì¶œí•´ì£¼ì„¸ìš”:

"{story}"

{context_instruction}

**ì¤‘ìš”**: 
- emotions: í˜„ì¬ ê°ì • (ì˜ˆ: "ìš°ìš¸í•´ì„œ" â†’ "ìš°ìš¸")
- situations: ëª©ì /ìƒí™© (ì˜ˆ: "í™œë ¥ì„ ì£¼ëŠ”" â†’ "ê¸°ë¶„ì „í™˜", "ìŠ¤ìŠ¤ë¡œì—ê²Œ" â†’ "ìê¸°ìœ„ë¡œ")
- moods: ì›í•˜ëŠ” ë¶„ìœ„ê¸° (ì˜ˆ: "ë°ì€ ê½ƒ" â†’ "ë°ì€", "í™œë ¥" â†’ "í™œê¸°ì°¬")
- ê° ì¹´í…Œê³ ë¦¬ë³„ë¡œ 1ê°œì”©ë§Œ ì¶”ì¶œ

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µ:
{{
    "emotions": ["ê°ì •1"],
    "situations": ["ìƒí™©1"],
    "moods": ["ë¬´ë“œ1"],
    "colors": ["ìƒ‰ìƒ1"],
    "confidence": 0.85
}}
"""
    
    def _parse_llm_response(self, response: str, mentioned_flower: Optional[str] = None) -> ExtractedContext:
        """LLM ì‘ë‹µ íŒŒì‹±"""
        try:
            # JSON ì¶”ì¶œ (```json ... ``` í˜•íƒœì¼ ìˆ˜ë„ ìˆìŒ)
            if "```json" in response:
                json_start = response.find("```json") + 7
                json_end = response.find("```", json_start)
                json_str = response[json_start:json_end].strip()
            else:
                json_str = response.strip()
            
            data = json.loads(json_str)
            
            # LLMì—ì„œ ì¶”ì¶œëœ í‚¤ì›Œë“œì— ëŒ€í•œ ëŒ€ì•ˆ í‚¤ì›Œë“œ ìƒì„±
            emotions = data.get("emotions", [])
            situations = data.get("situations", [])
            moods = data.get("moods", [])
            colors = data.get("colors", [])
            
            # ê° ë””ë©˜ì…˜ì—ì„œ ì²« ë²ˆì§¸ í‚¤ì›Œë“œë§Œ ë©”ì¸ í‚¤ì›Œë“œë¡œ ì‚¬ìš©
            emotions = emotions[:1] if emotions else []
            situations = situations[:1] if situations else []
            moods = moods[:1] if moods else []
            colors = colors[:1] if colors else []
            
            # ëŒ€ì•ˆ í‚¤ì›Œë“œ ìƒì„±
            emotions_alternatives = []
            situations_alternatives = []
            moods_alternatives = []
            colors_alternatives = []
            
            print(f"ğŸ¯ LLM ê²½ë¡œì—ì„œ ëŒ€ì•ˆ í‚¤ì›Œë“œ ìƒì„±:")
            print(f"  emotions: {emotions}")
            print(f"  situations: {situations}")
            print(f"  moods: {moods}")
            print(f"  colors: {colors}")
            
            if emotions and len(emotions) > 0:
                emotions_alternatives = self._generate_emotion_alternatives(emotions[0])
                print(f"  ê°ì • ëŒ€ì•ˆ: {emotions_alternatives}")
            
            if situations and len(situations) > 0:
                situations_alternatives = self._generate_situation_alternatives(situations[0])
                print(f"  ìƒí™© ëŒ€ì•ˆ: {situations_alternatives}")
            
            if moods and len(moods) > 0:
                moods_alternatives = self._generate_mood_alternatives(moods[0])
                print(f"  ë¬´ë“œ ëŒ€ì•ˆ: {moods_alternatives}")
            
            if colors and len(colors) > 0:
                colors_alternatives = self._generate_color_alternatives(colors[0])
                print(f"  ìƒ‰ìƒ ëŒ€ì•ˆ: {colors_alternatives}")
            
            result = ExtractedContext(
                emotions=emotions,
                situations=situations,
                moods=moods,
                colors=colors,
                confidence=data.get("confidence", 0.5),
                emotions_alternatives=emotions_alternatives,
                situations_alternatives=situations_alternatives,
                moods_alternatives=moods_alternatives,
                colors_alternatives=colors_alternatives
            )
            result.mentioned_flower = mentioned_flower
            return result
            
        except Exception as e:
            print(f"âŒ LLM ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨: {e}")
            return self._fallback_extraction("", emotions, excluded_keywords)
    
    def _fallback_extraction(self, story: str, emotions: List[dict] = None, excluded_keywords: List[Dict[str, str]] = None) -> ExtractedContext:
        """ê¸°ë³¸ ì¶”ì¶œê¸° (LLM ì‹¤íŒ¨ ì‹œ)"""
        # ê°„ë‹¨í•œ í‚¤ì›Œë“œ ë§¤ì¹­ìœ¼ë¡œ fallback
        emotions = []
        situations = []
        moods = []
        colors = []
        
        # ê°ì • í‚¤ì›Œë“œ (í˜„ì¬ ëŠë¼ëŠ” ê°ì •) - ë” ë‹¤ì–‘í•˜ê²Œ
        emotion_keywords = {
            # ë¶€ì •ì  ê°ì •
            "ìš°ìš¸": ["ìš°ìš¸", "ìš°ìš¸í•´", "ìš°ìš¸í•œ", "ìš°ìš¸í•¨", "ìš°ìš¸í•´ì„œ", "ì¹¨ìš¸", "ìš°ìš¸ì¦"],
            "ìŠ¬í””": ["ìŠ¬í”„", "ìŠ¬í”ˆ", "ìŠ¬í¼", "ìŠ¬í””", "ì• ë„", "ë¹„í†µ", "ì„œëŸ½"],
            "ìŠ¤íŠ¸ë ˆìŠ¤": ["ìŠ¤íŠ¸ë ˆìŠ¤", "ìŠ¤íŠ¸ë ˆìŠ¤ë°›", "ìŠ¤íŠ¸ë ˆìŠ¤ ë°›", "ìŠ¤íŠ¸ë ˆìŠ¤ë°›ì•„", "ì••ë°•", "ë¶€ë‹´"],
            "í”¼ê³¤": ["í”¼ê³¤", "í”¼ê³¤í•´", "í”¼ê³¤í•œ", "ì§€ì³", "ì§€ì³¤ì–´", "í—ˆê¸°", "ë¬´ê¸°ë ¥"],
            "ì™¸ë¡œì›€": ["ì™¸ë¡œì›Œ", "ì™¸ë¡œìš´", "ì™¸ë¡œì›€", "ê³ ë…", "ì“¸ì“¸", "í—ˆì „"],
            "ë¶ˆì•ˆ": ["ë¶ˆì•ˆ", "ë¶ˆì•ˆí•´", "ë¶ˆì•ˆí•œ", "ê±±ì •", "ê±±ì •í•´", "ê·¼ì‹¬", "ì¡°ë§ˆì¡°ë§ˆ"],
            "ë‹µë‹µí•¨": ["ë‹µë‹µ", "ë‹µë‹µí•´", "ë‹µë‹µí•œ", "ë§‰ë§‰", "ë§‰ë§‰í•´", "ë§‰ë§‰í•œ"],
            "ì§€ì¹¨": ["ì§€ì¹¨", "ì§€ì³", "ì§€ì³¤ì–´", "ë¬´ê¸°ë ¥", "ì˜ìš•ì—†"],
            "í—ˆì „í•¨": ["í—ˆì „", "í—ˆì „í•´", "í—ˆì „í•œ", "ë¹ˆ", "í……ë¹ˆ", "ì“¸ì“¸"],
            "ê·¸ë¦¬ì›€": ["ê·¸ë¦¬ì›Œ", "ê·¸ë¦¬ìš´", "ê·¸ë¦¬ì›€", "ë³´ê³ ì‹¶", "ë³´ê³ ì‹¶ì–´"],
            "ë¯¸ì•ˆí•¨": ["ë¯¸ì•ˆ", "ë¯¸ì•ˆí•´", "ë¯¸ì•ˆí•œ", "ì£„ì†¡", "ì£„ì†¡í•´", "ì£„ì†¡í•œ"],
            "í›„íšŒ": ["í›„íšŒ", "í›„íšŒí•´", "í›„íšŒí•œ", "ì•„ê¹", "ì•„ê¹ë‹¤"],
            "ë¶„ë…¸": ["í™”ë‚˜", "í™”ë‚˜ì„œ", "ë¶„ë…¸", "ì§œì¦", "ì§œì¦ë‚˜", "ì—´ë°›"],
            "ì§€ë£¨í•¨": ["ì§€ë£¨", "ì§€ë£¨í•´", "ì§€ë£¨í•œ", "ì‹¬ì‹¬", "ì‹¬ì‹¬í•´", "ì¬ë¯¸ì—†"],
            
            # ê¸ì •ì  ê°ì •
            "ê¸°ì¨": ["ê¸°ì˜", "ê¸°ë»", "ê¸°ìœ", "í–‰ë³µ", "ì¦ê±°", "ì‹ ë‚˜", "ì›ƒìŒ", "ì›ƒê²¨"],
            "ì„¤ë ˜": ["ì„¤ë ˜", "ì„¤ë ˆ", "ì„¤ë ˆëŠ”", "ë‘ê·¼", "ë‘ê·¼ê±°ë ¤", "ë–¨ë ¤"],
            "ê°ì‚¬": ["ê°ì‚¬", "ê³ ë§ˆì›Œ", "ì€í˜œ", "ë„ì›€", "ì¤‘ìš”í•œ", "ì†Œì¤‘í•œ", "ê³ ë§™"],
            "ë§Œì¡±": ["ë§Œì¡±", "ë§Œì¡±í•´", "ë§Œì¡±í•œ", "ì¶©ì¡±", "ì¶©ì¡±í•´", "ì¶©ì¡±í•œ"],
            "í¬ë§": ["í¬ë§", "ìƒˆë¡œìš´", "ì‹œì‘", "ë¯¸ë˜", "ê¿ˆ", "ê¿ˆê¿”", "ê¿ˆê¾¸"],
            "ìì‹ ê°": ["ìì‹ ê°", "ìì‹ ìˆ", "ìì‹ ìˆì–´", "í™•ì‹ ", "í™•ì‹ ìˆ"],
            "ìš©ê¸°": ["ìš©ê¸°", "ìš©ê°", "ìš©ê°í•´", "ìš©ê°í•œ", "ëŒ€ë‹´", "ëŒ€ë‹´í•´"],
            "ì—´ì •": ["ì—´ì •", "ì—´ì •ì ", "ì—´ì‹¬", "ì—´ì‹¬íˆ", "íˆ¬ì§€", "íˆ¬ì§€ìˆ"],
            "ì• ì •": ["ì• ì •", "ì‚¬ë‘", "ì¢‹ì•„", "ì •", "ë§ˆìŒ", "ì• í‹‹"],
            "ë”°ëœ»í•¨": ["ë”°ëœ»í•œ", "í¬ê·¼í•œ", "ì•ˆì •ì ì¸", "í¸ì•ˆ", "í¸ì•ˆí•´"],
            "ì•ˆì •ê°": ["ì•ˆì •", "ì•ˆì •ê°", "ì•ˆì •ì ", "ì°¨ë¶„", "ì°¨ë¶„í•´", "ì°¨ë¶„í•œ"],
            "í™œë ¥": ["í™œë ¥", "í™œê¸°", "í™œê¸°ì°¬", "ìƒê¸°", "ìƒê¸°ìˆ", "ì—ë„ˆì§€"],
            "ê²©ë ¤": ["ê²©ë ¤", "ì‘ì›", "í˜ë‚´", "í™”ì´íŒ…", "ë„ì „", "ë‹¤ì‹œ", "ê´œì°®ì•„"],
            "ì§„ì‹¬": ["ì§„ì‹¬", "ì§„ì§œ", "ì •ë§", "ì–´ë¦°", "ê°€ë³ì§€ë§Œ ì§„ì‹¬", "ì„±ì‹¤"],
            "ìš°ì •": ["ì¹œêµ¬", "ìš°ì •", "ë™ë£Œ", "ì¹œí•œ", "ì˜¤ë˜ëœ", "ì ˆì¹œ"]
        }
        
        # ìƒí™©/ëª©ì  í‚¤ì›Œë“œ - ë” ë‹¤ì–‘í•˜ê³  êµ¬ì²´ì ìœ¼ë¡œ
        situation_keywords = {
            # ê°œì¸ì  ìƒí™©
            "ë°©ê¾¸ë¯¸ê¸°": ["ë°©", "ì§‘", "ê³µê°„", "ê¾¸ë¯¸", "ì¸í…Œë¦¬ì–´", "ê°€êµ¬", "ì†Œí’ˆ", "ì¥ì‹"],
            "ì¼ìƒ": ["ì¼ìƒ", "í‰ì†Œ", "ë§¤ì¼", "ì¼ìƒì ì¸", "ë£¨í‹´", "ìŠµê´€"],
            "íœ´ì‹ê³µê°„": ["íœ´ì‹", "ì‰¬ê³ ", "í¸í•˜ê²Œ", "í¸ì•ˆí•˜ê²Œ", "ì‰¬ëŠ”", "íœ´ê°€", "ì—¬í–‰"],
            "ê¸°ë¶„ì „í™˜": ["ê¸°ë¶„ ì „í™˜", "ê¸°ë¶„ì „í™˜", "ê¸°ë¶„ ë°”ê¿”", "ìƒˆë¡œìš´", "í™œë ¥ì„", "í™œë ¥ì´", "ë°ì€", "ë°ê²Œ", "í™˜ê¸°"],
            "ìŠ¤íŠ¸ë ˆìŠ¤í•´ì†Œ": ["ìŠ¤íŠ¸ë ˆìŠ¤", "ìŠ¤íŠ¸ë ˆìŠ¤ í•´ì†Œ", "ìŠ¤íŠ¸ë ˆìŠ¤í•´ì†Œ", "í˜ë“¤", "ì§€ì³", "í”¼ê³¤", "ì••ë°•", "ë¶€ë‹´"],
            "ìê¸°ìœ„ë¡œ": ["ìê¸°ìœ„ë¡œ", "ìŠ¤ìŠ¤ë¡œì—ê²Œ", "ë‚˜ì—ê²Œ", "ë‚´ê°€", "ì €ì—ê²Œ", "ì œê°€", "í˜¼ì", "í˜¼ìì„œ"],
            "íë§": ["íë§", "ì¹˜ìœ ", "ë§ˆìŒ", "ë§ˆìŒì¹˜ìœ ", "ìƒì²˜", "ì•„í””", "íšŒë³µ"],
            "ëª…ìƒ": ["ëª…ìƒ", "ìš”ê°€", "ë§ˆìŒì±™ê¹€", "ì§‘ì¤‘", "ì§‘ì¤‘ë ¥", "ëª…ìƒê³µê°„"],
            "ë…ì„œ": ["ë…ì„œ", "ì±…", "ì½ê¸°", "ë„ì„œê´€", "ì„œì ", "ì§€ì‹"],
            "ìš´ë™": ["ìš´ë™", "í—¬ìŠ¤", "ìš”ê°€", "í•„ë¼í…ŒìŠ¤", "ì¡°ê¹…", "ê±·ê¸°", "ë“±ì‚°"],
            "ì·¨ë¯¸í™œë™": ["ì·¨ë¯¸", "ì·¨ë¯¸í™œë™", "ê·¸ë¦¼", "ê·¸ë¦¬ê¸°", "ì•…ê¸°", "ìŒì•…", "ìš”ë¦¬", "ë² ì´í‚¹"],
            "ìê¸°ê³„ë°œ": ["ìê¸°ê³„ë°œ", "í•™ìŠµ", "ê³µë¶€", "ìŠ¤í‚¬", "ëŠ¥ë ¥", "ì„±ì¥", "ë°œì „"],
            "ìƒˆë¡œìš´ì‹œì‘": ["ìƒˆë¡œìš´", "ì‹œì‘", "ë³€í™”", "ì „í™˜", "ë„ì „", "ëª¨í—˜", "ìƒˆì¶œë°œ"],
            
            # ëŒ€ì¸ê´€ê³„ ìƒí™©
            "ìœ„ë¡œ": ["ìœ„ë¡œ", "ë‹¬ë˜", "ì•ˆì•„", "ë³´ë“¬", "ì“°ë‹¤ë“¬", "ì–´ë£¨ë§Œ", "ìœ„ì•ˆ"],
            "ê²©ë ¤": ["ê²©ë ¤", "ì‘ì›", "í˜ë‚´", "í™”ì´íŒ…", "ë„ì „", "ë‹¤ì‹œ", "ê´œì°®ì•„", "ë²„í‹°"],
            "ì¶•í•˜": ["ì¶•í•˜", "ì¶•í•˜í•´", "ì¶•í•˜í•˜ëŠ”", "ê²½ì‚¬", "ê²½ì‚¬ìŠ¤ëŸ¬ìš´", "ì¶•í•˜íŒŒí‹°"],
            "ê°ì‚¬": ["ê°ì‚¬", "ê³ ë§ˆì›Œ", "ì€í˜œ", "ë„ì›€", "ì¤‘ìš”í•œ", "ì†Œì¤‘í•œ", "ê³ ë§™"],
            "ì‚¬ê³¼": ["ì‚¬ê³¼", "ë¯¸ì•ˆ", "ìš©ì„œ", "ì˜ëª»", "ì‹¤ìˆ˜", "ì£„ì†¡"],
            "í™”í•´": ["í™”í•´", "í™”í•´í•´", "í™”í•´í•˜ëŠ”", "ë‹¤ì‹œ", "ì¬íšŒ", "ë§Œë‚¨"],
            "ì¬íšŒ": ["ì¬íšŒ", "ë‹¤ì‹œ", "ë§Œë‚¨", "í™”í•´", "ì—°ë½", "ì—°ë½ì²˜"],
            "ì´ë³„": ["ì´ë³„", "í—¤ì–´ì§", "ì‘ë³„", "ì•ˆë…•", "ì˜ê°€", "ë– ë‚¨"],
            "ê³ ë°±": ["ê³ ë°±", "ê³ ë°±í•´", "ê³ ë°±í•˜ëŠ”", "ì‚¬ë‘", "ë§ˆìŒ", "ì§„ì‹¬"],
            "í”„ë¡œí¬ì¦ˆ": ["í”„ë¡œí¬ì¦ˆ", "ì²­í˜¼", "ê²°í˜¼", "ì•½í˜¼", "ë°˜ì§€", "ê¿ˆ"],
            "ê²°í˜¼": ["ê²°í˜¼", "ì›¨ë”©", "ë¶€ë¶€", "ì‹ ë‘", "ì‹ ë¶€", "ê²°í˜¼ì‹"],
            "ìƒì¼": ["ìƒì¼", "ê¸°ë…ì¼", "ì¶•í•˜", "íŒŒí‹°", "ì¼€ì´í¬", "ì„ ë¬¼"],
            "ì¡¸ì—…": ["ì¡¸ì—…", "ì¡¸ì—…ì‹", "í•™ìœ„", "í•™ì‚¬ëª¨", "ìº¡", "ìº¡ìŠ¤í†¤"],
            "í•©ê²©": ["í•©ê²©", "ì„±ê³µ", "í•©ê²©ì¦", "í•©ê²©í†µì§€", "í•©ê²©ë°œí‘œ", "í•©ê²©ì"],
            "ì·¨ì—…": ["ì·¨ì—…", "ì§ì¥", "íšŒì‚¬", "ê·¼ë¬´", "ì¶œê·¼", "ì§ì¥ìƒí™œ"],
            "ì°½ì—…": ["ì°½ì—…", "ì‚¬ì—…", "ë¹„ì¦ˆë‹ˆìŠ¤", "íšŒì‚¬", "ì‚¬ì¥", "CEO"],
            
            # ê³µê°„/í™˜ê²½
            "ê±°ì‹¤": ["ê±°ì‹¤", "ì‘ì ‘ì‹¤", "ë¦¬ë¹™ë£¸", "ì†ŒíŒŒ", "TV", "ê°€ì¡±"],
            "ì¹¨ì‹¤": ["ì¹¨ì‹¤", "ë² ë“œë£¸", "ì¹¨ëŒ€", "ìˆ˜ë©´", "ì ", "íœ´ì‹"],
            "ì‚¬ë¬´ì‹¤": ["ì‚¬ë¬´ì‹¤", "ì˜¤í”¼ìŠ¤", "ì±…ìƒ", "ì—…ë¬´", "ì¼", "ì§ì¥"],
            "ì¹´í˜": ["ì¹´í˜", "ì»¤í”¼", "ìŒë£Œ", "ë¶„ìœ„ê¸°", "ì•„ëŠ‘", "í¸ì•ˆ"],
            "ì •ì›": ["ì •ì›", "ê°€ë“ ", "í™”ë‹¨", "ê½ƒë°­", "ì‹ë¬¼", "ìì—°"],
            "ë°œì½”ë‹ˆ": ["ë°œì½”ë‹ˆ", "ë² ë€ë‹¤", "í…Œë¼ìŠ¤", "ì•¼ì™¸", "ë°”ëŒ", "í–‡ì‚´"],
            "ë² ë€ë‹¤": ["ë² ë€ë‹¤", "ë°œì½”ë‹ˆ", "í…Œë¼ìŠ¤", "ì•¼ì™¸", "ë°”ëŒ", "í–‡ì‚´"],
            "ì¸í…Œë¦¬ì–´": ["ì¸í…Œë¦¬ì–´", "ë””ìì¸", "ìŠ¤íƒ€ì¼", "ë¶„ìœ„ê¸°", "í…Œë§ˆ", "ì»¨ì…‰"],
            "í™ˆë°ì½”": ["í™ˆë°ì½”", "ì¥ì‹", "ì†Œí’ˆ", "ì•¡ì„¸ì„œë¦¬", "í¬ì¸íŠ¸", "í¬ì¸íŠ¸ì•„ì´í…œ"],
            "ê³µê°„ë¶„ìœ„ê¸°": ["ë¶„ìœ„ê¸°", "ë¬´ë“œ", "ê°ì„±", "ëŠë‚Œ", "í™˜ê²½", "ê³µê°„"],
            "ì¡°ëª…": ["ì¡°ëª…", "ë¶ˆ", "ë¼ì´íŠ¸", "ë°ê¸°", "ì–´ë‘ ", "ë¶„ìœ„ê¸°ì¡°ëª…"]
        }
        
        # ë¬´ë“œ í‚¤ì›Œë“œ (ì›í•˜ëŠ” ê°ì •/ëª©í‘œ/ë¶„ìœ„ê¸°) - ì˜ë¯¸ ê¸°ë°˜ ë§¤í•‘ (í™•ì¥)
        mood_keywords = {
            "ë”°ëœ»í•œ": ["ë”°ëœ»í•œ", "í¬ê·¼í•œ", "í¸ì•ˆí•œ", "ì•ˆì •ì ì¸", "ê³ ë§ˆì›Œ", "ë“ ë“ í•œ"],
            "ë¶€ë“œëŸ¬ìš´": ["ë¶€ë“œëŸ¬ìš´", "ì€ì€í•œ", "ì¡°ìš©í•œ", "ì°¨ë¶„í•œ", "ë¶€ë“œëŸ¬ìš´ ê½ƒ"],
            "ë¡œë§¨í‹±í•œ": ["ë¡œë§¨í‹±", "ë‹¬ì½¤í•œ", "ì‚¬ë‘ìŠ¤ëŸ¬ìš´", "ì•„ë¦„ë‹¤ìš´", "ì‚¬ë‘"],
            "í™œê¸°ì°¬": ["í™œê¸°ì°¬", "ê²½ì¾Œí•œ", "ë°ì€", "ì¦ê±°ìš´", "í™œë ¥", "í™œë ¥ì„", "í™œë ¥ì´"],
            "ìš°ì•„í•œ": ["ìš°ì•„í•œ", "ì„¸ë ¨ëœ", "ê³ ê¸‰ìŠ¤ëŸ¬ìš´", "í’ˆê²© ìˆëŠ”"],
            "ìì—°ìŠ¤ëŸ¬ìš´": ["ìì—°ìŠ¤ëŸ¬ìš´", "ë‚´ì¶”ëŸ´í•œ", "ê¹”ë”í•œ", "ì‹¬í”Œí•œ"],
            "í™”ë ¤í•œ": ["í™”ë ¤í•œ", "ë¹„ë¹„ë“œí•œ", "ì•Œë¡ë‹¬ë¡í•œ", "í˜•í˜•ìƒ‰ìƒ‰", "ëˆˆë¶€ì‹ ", "ë¹›ë‚˜ëŠ”"],
            "ì‹¬í”Œí•œ": ["ì‹¬í”Œí•œ", "ê°€ë²¼ìš´", "ê°„ë‹¨í•œ", "ê°€ë³ì§€ë§Œ", "ê°€ë²¼ìš´ ë§ˆìŒ"],
            "ê°€ë²¼ìš´": ["ê°€ë²¼ìš´", "ê°€ë³ì§€ë§Œ", "ê°„ë‹¨í•œ", "ì‹¬í”Œí•œ"],
            "ê°ì‚¬í•œ": ["ê°ì‚¬", "ê³ ë§ˆì›Œ", "ì€í˜œ", "ë„ì›€", "ë“ ë“ í•œ"],
            "ì‚¬ë‘ìŠ¤ëŸ¬ìš´": ["ì‚¬ë‘", "ì¢‹ì•„", "ì• ì •", "ì •", "ë§ˆìŒ", "ë‚¨í¸", "ì•„ë‚´"],
            "í¸ì•ˆí•œ": ["í¸ì•ˆ", "í¸í•˜ê²Œ", "ì‰¬ê³ ", "íœ´ì‹", "í¸ì•ˆí•˜ê²Œ", "í¸ì•ˆíˆ", "ì‰¬ê³  ì‹¶ì–´"],
            "í‰ì˜¨í•œ": ["í‰ì˜¨", "ì°¨ë¶„", "ì¡°ìš©í•œ", "ê³ ìš”í•œ", "ì”ì”í•œ"],
            "ê¸°ë¶„ì „í™˜": ["ê¸°ë¶„ ì „í™˜", "ê¸°ë¶„ì „í™˜", "ê¸°ë¶„ ë°”ê¿”", "ìƒˆë¡œìš´", "ê¸°ë¶„ ë°”ê¾¸ê³  ì‹¶ì–´"],
            "ë°ì€": ["ë°ì€", "ë°ê²Œ", "ë°ì•„ì§€ê³  ì‹¶ì–´", "ë°ì•„ì§€ê³  ì‹¶ì€"],
            "ê¸°ìœ": ["ê¸°ìœ", "ê¸°ì˜ê³  ì‹¶ì–´", "ê¸°ì˜ê³  ì‹¶ì€", "í–‰ë³µí•˜ê³  ì‹¶ì–´"],
            "ìœ„ë¡œë°›ê³  ì‹¶ì€": ["ìœ„ë¡œ", "ë‹¬ë˜", "ì•ˆì•„", "ë³´ë“¬", "ì“°ë‹¤ë“¬", "ì–´ë£¨ë§Œ", "ìœ„ë¡œë°›ê³  ì‹¶ì–´"]
        }
        
        # ìƒ‰ìƒ í‚¤ì›Œë“œ (í™•ì¥)
        color_keywords = {
            "ë¸”ë£¨": ["ë¸”ë£¨", "íŒŒë‘", "í‘¸ë¥¸", "ì‹œì›í•œ", "ë°”ë‹·ê°€", "ì—¬í–‰"],
            "í¼í”Œ": ["í¼í”Œ", "ë¼ë²¤ë”", "ê·¸ë¦¬ì›€", "ì¶”ì–µ"],  # "ë³´ë¼" ì œê±°í•˜ì—¬ ì—°ë³´ë¼ê°€ í¼í”Œë¡œ ë§¤ì¹­ë˜ì§€ ì•Šë„ë¡ í•¨
            "ë¼ì¼ë½": ["ë¼ì¼ë½", "ì—°ë³´ë¼", "ì—°í•œ ë³´ë¼", "ì€ì€í•œ ë³´ë¼", "ë¶€ë“œëŸ¬ìš´ ë³´ë¼", "ë³´ë¼"],  # "ë³´ë¼"ë¥¼ ë¼ì¼ë½ìœ¼ë¡œ ì´ë™
            "í•‘í¬": ["í•‘í¬", "ë¶„í™", "ë¡œì¦ˆ", "ë¡œë§¨í‹±", "ì‚¬ë‘", "ë¶€ë“œëŸ¬ìš´"],
            "ë ˆë“œ": ["ë ˆë“œ", "ë¹¨ê°•", "ë¹¨ê°„", "ì—´ì •", "ì‚¬ë‘"],
            "í™”ì´íŠ¸": ["í™”ì´íŠ¸", "í°ìƒ‰", "í™”ì´íŠ¸", "ìˆœìˆ˜", "ê¹¨ë—í•œ", "ë¶€ë“œëŸ¬ìš´"],
            "ë…¸ë‘": ["ë…¸ë‘", "ì˜ë¡œìš°", "ê³¨ë“œ", "ë°ì€"],
            "ì˜¤ë Œì§€": ["ì˜¤ë Œì§€", "ì£¼í™©", "ë”°ëœ»í•œ", "í™œê¸°"],
            "ê·¸ë¦°": ["ê·¸ë¦°", "ì´ˆë¡", "ìì—°", "ë‚´ì¶”ëŸ´"],
            # "íŒŒìŠ¤í…”í†¤": ["íŒŒìŠ¤í…”í†¤", "íŒŒìŠ¤í…”", "ë¶€ë“œëŸ¬ìš´ ìƒ‰", "ì—°í•œ ìƒ‰", "ë¶€ë“œëŸ¬ìš´"]  # íŒŒìŠ¤í…”í†¤ì€ ìƒ‰ìƒì´ ì•„ë‹Œ í†¤ì´ë¯€ë¡œ ì œì™¸
        }
        
        # ëª…ì‹œì  ìƒ‰ìƒ ìš”ì²­ ìš°ì„  ì²˜ë¦¬
        story_lower = story.lower()
        
        # ì—°ë³´ë¼/ë¼ì¼ë½ ê´€ë ¨ í‚¤ì›Œë“œ â†’ ë¼ì¼ë½ (ìµœìš°ì„ )
        if any(keyword in story_lower for keyword in ["ì—°ë³´ë¼", "ë¼ì¼ë½", "ì—°í•œ ë³´ë¼", "ì€ì€í•œ ë³´ë¼", "ë¶€ë“œëŸ¬ìš´ ë³´ë¼"]):
            colors = ["ë¼ì¼ë½"]
        # ëª…ì‹œì  ìƒ‰ìƒ ìš”ì²­ì´ ìˆìœ¼ë©´ ìµœìš°ì„  ì²˜ë¦¬
        elif any(keyword in story_lower for keyword in ["ì˜…ì€ í•‘í¬", "ë¶€ë“œëŸ¬ìš´ ìƒ‰ê°", "ì—°í•œ í•‘í¬"]):
            colors = ["í•‘í¬"]  # íŒŒìŠ¤í…”í†¤ ëŒ€ì‹  í•‘í¬ë¡œ ë§¤í•‘
        # ì„±ê³µ/ì°½ì—… ê´€ë ¨ í‚¤ì›Œë“œ (ìµœìš°ì„ ) - ë§¥ë½ì— ë”°ë¼ ìƒ‰ìƒ ê²°ì •
        elif any(keyword in story_lower for keyword in ["ì„±ê³µ", "ì°½ì—…", "í•©ê²©", "ì¡¸ì—…", "ìŠ¹ë¦¬", "ì„±ì·¨", "ì¶•í•˜"]):
            # í™”ë ¤í•œ + í•©ê²©/ì„±ê³µ â†’ ë ˆë“œ (í™”ë ¤í•œ ì¶•í•˜)
            if any(keyword in story_lower for keyword in ["í™”ë ¤í•œ", "ë¹„ë¹„ë“œí•œ", "ì•Œë¡ë‹¬ë¡í•œ", "í˜•í˜•ìƒ‰ìƒ‰", "ëˆˆë¶€ì‹ ", "ë¹›ë‚˜ëŠ”"]):
                colors = ["ë ˆë“œ"]  # í™”ë ¤í•œ ì¶•í•˜
            # ìƒˆë¡œìš´ ì‹œì‘, ì‘ì›, í¬ë§ í‚¤ì›Œë“œê°€ í•¨ê»˜ ìˆìœ¼ë©´ ì˜ë¡œìš°/í™”ì´íŠ¸
            elif any(keyword in story_lower for keyword in ["ìƒˆë¡œìš´ ì‹œì‘", "ì‘ì›", "í¬ë§", "ë¯¸ë˜", "ì•ìœ¼ë¡œ", "ì‹œì‘"]):
                colors = ["ì˜ë¡œìš°"]  # ìƒˆë¡œìš´ ì‹œì‘ê³¼ í¬ë§
            else:
                colors = ["ë ˆë“œ"]  # ì„±ê³µ ì¶•í•˜
        # ìƒˆë¡œìš´ ì‹œì‘/ì‘ì› ê´€ë ¨ í‚¤ì›Œë“œ
        elif any(keyword in story_lower for keyword in ["ìƒˆë¡œìš´ ì‹œì‘", "ì‘ì›", "í¬ë§", "ë¯¸ë˜", "ì•ìœ¼ë¡œ", "ì‹œì‘", "ë„ì „", "ë‹¤ì‹œ", "ê´œì°®ì•„", "ê²©ë ¤", "í˜ë‚´", "í™”ì´íŒ…"]):
            # ëª…ì‹œì  ìƒ‰ìƒ ìš”ì²­ì´ ìˆìœ¼ë©´ ìš°ì„ 
            if any(keyword in story_lower for keyword in ["í•‘í¬", "ë¶€ë“œëŸ¬ìš´", "ì˜…ì€"]):
                colors = ["í•‘í¬"]  # íŒŒìŠ¤í…”í†¤ ëŒ€ì‹  í•‘í¬ë¡œ ë§¤í•‘
            else:
                colors = ["ì˜ë¡œìš°"]
        # ì‚¬ë‘ ê´€ë ¨ í‚¤ì›Œë“œ - ì„¸ë¶„í™”ëœ ë§¤í•‘
        elif any(keyword in story_lower for keyword in ["ì‚¬ë‘", "ë¡œë§¨í‹±", "ì—°ì¸", "ë‚¨ìì¹œêµ¬", "ì—¬ìì¹œêµ¬", "í”„ë¡œí¬ì¦ˆ", "ê²°í˜¼", "ë°ì´íŠ¸"]):
            # ì‹ ë¹„ë¡œìš´/ê¹Šì€ ì‚¬ë‘ â†’ í¼í”Œ
            if any(keyword in story_lower for keyword in ["ì‹ ë¹„ë¡œìš´", "ê¹Šì€", "ì˜ì›í•œ", "ìš´ëª…ì ì¸", "ìˆ™ëª…ì ì¸", "ì´ë£¨ì§€ ëª»í•œ", "ë¹„ë°€", "ìˆ¨ê²¨ì§„"]):
                colors = ["í¼í”Œ"]  # ì‹ ë¹„ë¡œìš´ ì‚¬ë‘
            # ê·€ì—¬ìš´/ë”°ëœ»í•œ ì‚¬ë‘ â†’ í•‘í¬
            elif any(keyword in story_lower for keyword in ["ê·€ì—¬ìš´", "ë”°ëœ»í•œ", "í¬ê·¼í•œ", "ë¶€ë“œëŸ¬ìš´", "ì€ì€í•œ", "ì•„ë«ì‚¬ëŒ", "ì¡°ì¹´", "ì•„ì´", "ë”¸", "ì•„ë“¤"]):
                colors = ["í•‘í¬"]  # ê·€ì—¬ìš´ ì‚¬ë‘
            # ì—´ì •ì ì¸/ê°•ë ¬í•œ ì‚¬ë‘ â†’ ë ˆë“œ
            elif any(keyword in story_lower for keyword in ["ì—´ì •ì ì¸", "ê°•ë ¬í•œ", "ë¶ˆíƒ€ëŠ”", "í™”ëˆí•œ", "ëœ¨ê±°ìš´", "ë¹„ë¹„ë“œí•œ"]):
                colors = ["ë ˆë“œ"]  # ì—´ì •ì ì¸ ì‚¬ë‘
            # ê¸°ë³¸ ë¡œë§¨í‹± ì‚¬ë‘ â†’ í•‘í¬
            else:
                colors = ["í•‘í¬"]  # ê¸°ë³¸ ë¡œë§¨í‹± ì‚¬ë‘
        # ìš°ì•„í•¨/ê³ ê¸‰ìŠ¤ëŸ¬ì›€/ì‹ ë¹„ë¡œì›€ ê´€ë ¨ í‚¤ì›Œë“œ â†’ í¼í”Œ
        elif any(keyword in story_lower for keyword in ["ìš°ì•„í•œ", "ê³ ê¸‰ìŠ¤ëŸ¬ìš´", "ì„¸ë ¨ëœ", "í’ˆê²© ìˆëŠ”", "ì‹ ë¹„ë¡œìš´", "ì•„ë¦„ë‹¤ìš´", "ìœ ë‹ˆí¬í•œ", "íŠ¹ë³„í•œ", "ë…íŠ¹í•œ"]):
            colors = ["í¼í”Œ"]

        # ìœ„ë¡œ/ë”°ëœ»í•¨ ê´€ë ¨ í‚¤ì›Œë“œ â†’ í•‘í¬ (ëª…ì‹œì  ìƒ‰ìƒ ìš”ì²­ì´ ì—†ì„ ë•Œë§Œ)
        elif any(keyword in story_lower for keyword in ["ìœ„ë¡œ", "ì§€ì³", "í˜ë“¤", "í”¼ê³¤", "ìŠ¤íŠ¸ë ˆìŠ¤", "ì•¼ê·¼", "ê³ ìƒ", "ê³ ë¯¼", "ê±±ì •", "ë”°ëœ»í•œ", "ë¶€ë“œëŸ¬ìš´", "í¬ê·¼í•œ", "ë¶€ë“œëŸ¬ìš´ ìƒ‰ê°", "ì˜…ì€ í•‘í¬"]) and not any(color in story_lower for color in ["ë¸”ë£¨", "íŒŒë‘", "í‘¸ë¥¸", "ë¸”ë£¨í†¤", "í•‘í¬", "ë ˆë“œ", "í™”ì´íŠ¸", "ë…¸ë‘", "ì˜ë¡œìš°", "ì˜¤ë Œì§€", "í¼í”Œ", "ë³´ë¼", "ê·¸ë¦°", "ì´ˆë¡"]):
            colors = ["í•‘í¬"]  # ë¶€ë“œëŸ½ê³  ë”°ëœ»í•œ ìœ„ë¡œ
        # íŒŒìŠ¤í…”í†¤ ê´€ë ¨ í‚¤ì›Œë“œ â†’ í•‘í¬ë¡œ ë§¤í•‘
        elif any(keyword in story_lower for keyword in ["íŒŒìŠ¤í…”í†¤", "íŒŒìŠ¤í…”", "ë¶€ë“œëŸ¬ìš´ ìƒ‰", "ì—°í•œ ìƒ‰"]):
            colors = ["í•‘í¬"]  # íŒŒìŠ¤í…”í†¤ ëŒ€ì‹  í•‘í¬ë¡œ ë§¤í•‘
        # ê°•ë ¬í•œ/ë¹„ë¹„ë“œ ìƒ‰ìƒ ê´€ë ¨ í‚¤ì›Œë“œ
        elif any(keyword in story_lower for keyword in ["ê°•ë ¬í•œ", "ì•Œë¡ë‹¬ë¡", "í™”ë ¤í•œ", "í˜•í˜•ìƒ‰ìƒ‰", "ë¹„ë¹„ë“œ", "ì„ ëª…í•œ", "í¬ì¸íŠ¸"]):
            colors = ["ë…¸ë‘"]  # ê°€ì¥ ë¹„ë¹„ë“œí•œ ìƒ‰ìƒ
        # ì‹œì›í•œ ì»¬ëŸ¬ ê´€ë ¨ í‚¤ì›Œë“œ
        elif any(keyword in story_lower for keyword in ["ì‹œì›í•œ", "ë¸”ë£¨í†¤", "í‘¸ë¥¸ìƒ‰", "ë°”ë‹·ê°€", "ì—¬í–‰"]):
            colors = ["ë¸”ë£¨"]
        # ë”°ëœ»í•œ ì»¬ëŸ¬ ê´€ë ¨ í‚¤ì›Œë“œ
        elif any(keyword in story_lower for keyword in ["ë”°ëœ»í•œ", "í•‘í¬í†¤", "ë¡œë§¨í‹±"]):
            colors = ["í•‘í¬"]
        # ë°ì€ ì»¬ëŸ¬ ê´€ë ¨ í‚¤ì›Œë“œ
        elif any(keyword in story_lower for keyword in ["ë°ì€", "ì˜ë¡œìš°í†¤", "í¬ë§"]):
            colors = ["ë…¸ë‘"]
        else:
            # ì¼ë°˜ì ì¸ í‚¤ì›Œë“œ ë§¤ì¹­ (ì²« ë²ˆì§¸ ë§¤ì¹­ëœ ê²ƒë§Œ)
            for category, keywords in color_keywords.items():
                if any(keyword in story for keyword in keywords):
                    colors = [category]  # 1ê°œë§Œ ì¶”ê°€
                    break  # ì²« ë²ˆì§¸ ë§¤ì¹­ì—ì„œ ì¤‘ë‹¨
        
        # ì‚¬ìš©ì ì˜ë„ ë¶„ì„ (ì˜ë¯¸ ê¸°ë°˜ vs ë””ìì¸ ê¸°ë°˜)
        meaning_based_keywords = ["ì˜ë¯¸", "ê½ƒë§", "ìƒì§•", "ë©”ì‹œì§€", "ë§ˆìŒ", "ê°ì •", "ì‚¬ë‘", "ê°ì‚¬", "ìœ„ë¡œ", "ê²©ë ¤", "ì¶•í•˜", "ì‘ì›", "í¬ë§", "ìš°ì •", "ì‚¬ê³¼", "ìš©ì„œ"]
        design_based_keywords = ["ìƒ‰ìƒ", "ì»¬ëŸ¬", "ë¬´ë“œ", "ë¶„ìœ„ê¸°", "ë””ìì¸", "í™”ë ¤í•œ", "ë¶€ë“œëŸ¬ìš´", "ë”°ëœ»í•œ", "ìš°ì•„í•œ", "ì„¸ë ¨ëœ", "í•‘í¬", "ë ˆë“œ", "ë¸”ë£¨", "ì˜ë¡œìš°", "í™”ì´íŠ¸", "í¼í”Œ"]
        
        meaning_based_count = sum(1 for keyword in meaning_based_keywords if keyword in story_lower)
        design_based_count = sum(1 for keyword in design_based_keywords if keyword in story_lower)
        
        user_intent = "meaning_based" if meaning_based_count > design_based_count else "design_based"
        
        print(f"ğŸ” ì‚¬ìš©ì ì˜ë„ ë¶„ì„: {user_intent} (ì˜ë¯¸: {meaning_based_count}, ë””ìì¸: {design_based_count})")
        
        # ê°ì • ë¶„ì„ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ìš°ì„ ì ìœ¼ë¡œ ì‚¬ìš©
        if emotions and len(emotions) > 0:
            # ê°ì • ë¶„ì„ ê²°ê³¼ì—ì„œ ê°ì •ëª…ë§Œ ì¶”ì¶œ
            emotion_names = []
            for emotion in emotions:
                if hasattr(emotion, 'emotion'):
                    emotion_names.append(emotion.emotion)
                elif isinstance(emotion, dict) and 'emotion' in emotion:
                    emotion_names.append(emotion['emotion'])
            
            if emotion_names:  # ê°ì •ëª…ì´ ì‹¤ì œë¡œ ì¶”ì¶œëœ ê²½ìš°ì—ë§Œ ì ìš©
                emotions = emotion_names[:3]  # ìµœëŒ€ 3ê°œ ê°ì • ì‚¬ìš©
                print(f"ğŸ”§ Fallbackì—ì„œ ê°ì • ë¶„ì„ ê²°ê³¼ ì ìš©: {emotion_names[:3]}")
            else:
                # ê°ì •ëª…ì´ ì¶”ì¶œë˜ì§€ ì•Šì€ ê²½ìš° ê¸°ë³¸ ê°ì • ì¶”ì¶œ
                emotions = self._extract_basic_emotions(story)
                print(f"ğŸ”§ Fallbackì—ì„œ ê¸°ë³¸ ê°ì • ì¶”ì¶œ: {emotions}")
        else:
            # ê¸°ë³¸ ê°ì • ì¶”ì¶œ
            emotions = self._extract_basic_emotions(story)
            print(f"ğŸ”§ Fallbackì—ì„œ ê¸°ë³¸ ê°ì • ì¶”ì¶œ: {emotions}")
        
        # ê°ì •ì´ ì ìœ¼ë©´ ê´€ë ¨ ê°ì • ì¶”ê°€ (ê°•í™”)
        if len(emotions) < 3:
            story_lower = story.lower()
            if "ê³ ë§ˆì›Œ" in story_lower or "ê°ì‚¬" in story_lower:
                if "ê°ì‚¬" not in emotions:
                    emotions.append("ê°ì‚¬")
                if "ì‚¬ë‘" not in emotions:
                    emotions.append("ì‚¬ë‘")
                if "ê¸°ì¨" not in emotions:
                    emotions.append("ê¸°ì¨")
            elif "ë‚¨í¸" in story_lower or "ì•„ë‚´" in story_lower:
                if "ì‚¬ë‘" not in emotions:
                    emotions.append("ì‚¬ë‘")
                if "ê°ì‚¬" not in emotions:
                    emotions.append("ê°ì‚¬")
                if "ê¸°ì¨" not in emotions:
                    emotions.append("ê¸°ì¨")
            elif "ë¶€ë“œëŸ¬ìš´" in story_lower:
                if "ì‚¬ë‘" not in emotions:
                    emotions.append("ì‚¬ë‘")
                if "ê°ì‚¬" not in emotions:
                    emotions.append("ê°ì‚¬")
                if "ë”°ëœ»í•¨" not in emotions:
                    emotions.append("ë”°ëœ»í•¨")
        
        # ì œì™¸ëœ í‚¤ì›Œë“œ í•„í„°ë§
        excluded_texts = [kw.get('text', '') for kw in excluded_keywords] if excluded_keywords else []
        emotions = [e for e in emotions if e not in excluded_texts]
        print(f"ğŸš« ì œì™¸ëœ í‚¤ì›Œë“œë¡œ ì¸í•œ ê°ì • í•„í„°ë§: {excluded_texts}")
        
        # ê°ì •ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ê°ì • 1ê°œ ì¶”ê°€ (ì œì™¸ëœ í‚¤ì›Œë“œ ì œì™¸)
        if len(emotions) < 1:
            # í˜„ì¬ ê°ì • ìœ„ì£¼ë¡œ ê¸°ë³¸ê°’ ì„¤ì •
            default_emotions = ["ì‚¬ë‘", "ê°ì‚¬", "ê¸°ì¨", "í¬ë§", "ë”°ëœ»í•¨", "í¸ì•ˆí•¨", "ì„¤ë ˜", "ìš°ì •"]
            for emotion in default_emotions:
                if emotion not in emotions and emotion not in excluded_texts and len(emotions) < 1:
                    emotions.append(emotion)
                    break  # 1ê°œë§Œ ì¶”ê°€
        
        # emotionsê°€ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ê°’ ì„¤ì •
        if not emotions:
            emotions = ["ì‚¬ë‘"]
        
        # ìƒí™© í‚¤ì›Œë“œ ë§¤ì¹­ (ê°€ì¥ ì •í™•í•œ ë§¤ì¹­ ìš°ì„ )
        situations = []
        for category, keywords in situation_keywords.items():
            if any(keyword in story for keyword in keywords):
                situations.append(category)  # ì—¬ëŸ¬ ê°œ ì¶”ê°€ ê°€ëŠ¥
        
        # ì•¼ê·¼/ìŠ¤íŠ¸ë ˆìŠ¤ ê´€ë ¨ íŠ¹ë³„ ì²˜ë¦¬
        if any(keyword in story_lower for keyword in ["ì•¼ê·¼", "ìŠ¤íŠ¸ë ˆìŠ¤", "ì§€ì³", "í”¼ê³¤", "ê³¼ë¡œ"]):
            if "ì•„ë‚´" in story_lower or "ì™€ì´í”„" in story_lower or "ë¶€ì¸" in story_lower:
                situations = ["ì•„ë‚´"]  # ì•„ë‚´ê°€ ì•¼ê·¼/ìŠ¤íŠ¸ë ˆìŠ¤ë¡œ ì§€ì³ìˆìŒ
            elif "ë‚¨í¸" in story_lower:
                situations = ["ë‚¨í¸"]  # ë‚¨í¸ì´ ì•¼ê·¼/ìŠ¤íŠ¸ë ˆìŠ¤ë¡œ ì§€ì³ìˆìŒ
            elif "ì¹œêµ¬" in story_lower or "ë™ë£Œ" in story_lower:
                situations = ["ì¹œêµ¬"]  # ì¹œêµ¬ê°€ ì•¼ê·¼/ìŠ¤íŠ¸ë ˆìŠ¤ë¡œ ì§€ì³ìˆìŒ
            else:
                situations = ["ê±±ì •"]  # ì¼ë°˜ì ì¸ ê±±ì • ìƒí™©
        
        # ë§¥ë½ ê¸°ë°˜ ê°ì •/ìƒí™© êµ¬ë¶„
        story_lower = story.lower()
        
        # ë°›ëŠ” ì‚¬ëŒì˜ ìƒí™© í‚¤ì›Œë“œ (ìƒëŒ€ë°©ì´ ê²ªê³  ìˆëŠ” ê²ƒ)
        receiver_situation_keywords = ["ìŠ¤íŠ¸ë ˆìŠ¤", "í”¼ê³¤", "ì§€ì³", "í˜ë“¤", "ì•¼ê·¼", "ê³¼ë¡œ", "ê³ ìƒ"]
        
        # ì‚¬ìš©ìì˜ ê°ì • í‚¤ì›Œë“œ (ë³¸ì¸ì´ ëŠë¼ëŠ” ê²ƒ)
        user_emotion_keywords = ["ìœ„ë¡œ", "ê±±ì •", "ì‚¬ë‘", "ê°ì‚¬", "ê¸°ì¨", "í¬ë§", "ë”°ëœ»í•¨", "ì™¸ë¡œì›€", "ë¶ˆì•ˆ", "ìŠ¬í””", "ì¶•í•˜"]
        
        # ë§¥ë½ ë¶„ì„: ëˆ„êµ¬ì˜ ìŠ¤íŠ¸ë ˆìŠ¤/í”¼ê³¤ì¸ì§€ êµ¬ë¶„
        for keyword in receiver_situation_keywords:
            if keyword in story_lower:
                # "~ê°€ ìŠ¤íŠ¸ë ˆìŠ¤ë¡œ" â†’ ë°›ëŠ” ì‚¬ëŒì˜ ìƒí™©
                if any(pronoun in story_lower for pronoun in ["ê°€", "ì´", "ë„", "ëŠ”", "ì„", "ë¥¼"]):
                    # ì´ë¯¸ situationsì— ì¶”ê°€ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                    if keyword not in [s.lower() for s in situations]:
                        situations.append(keyword)
                # "ì €ë„ ìŠ¤íŠ¸ë ˆìŠ¤ê°€" â†’ ì‚¬ìš©ìì˜ ê°ì •
                elif any(pronoun in story_lower for pronoun in ["ì €", "ë‚˜", "ì œê°€", "ë‚´ê°€"]):
                    if keyword not in [e.lower() for e in emotions]:
                        emotions.append(keyword)
        
        # ìŠ¬ë˜ì‹œ ì œê±°: ê°ì •ê³¼ ìƒí™©ì—ì„œ ìŠ¬ë˜ì‹œê°€ ìˆìœ¼ë©´ ì²« ë²ˆì§¸ í‚¤ì›Œë“œë§Œ ì‚¬ìš©
        emotions = [e.split('/')[0] if '/' in e else e for e in emotions]
        situations = [s.split('/')[0] if '/' in s else s for s in situations]
        
        # ë¬´ë“œ í‚¤ì›Œë“œ ë§¤ì¹­ (ë” ë§ì€ ì˜µì…˜ ì œê³µ)
        for category, keywords in mood_keywords.items():
            if any(keyword in story for keyword in keywords):
                moods.append(category)  # ì—¬ëŸ¬ ê°œ ì¶”ê°€ ê°€ëŠ¥
        
        # ë¬´ë“œ ì¶”ì¶œ ì „ëµ: ë¬´ë“œ ëª…ì‹œ ì—¬ë¶€ì™€ í™•ì‹¤ì„±ì— ë”°ë¼ ë¶„ê¸°
        story_lower = story.lower()
        
        # ëª…ì‹œì  ë¬´ë“œ í‚¤ì›Œë“œ ì²´í¬
        explicit_mood_keywords = ["ë¶€ë“œëŸ¬ìš´", "ë”°ëœ»í•œ", "ë¡œë§¨í‹±í•œ", "ìš°ì•„í•œ", "í™”ë ¤í•œ", "ìì—°ìŠ¤ëŸ¬ìš´", "ì‹¬í”Œí•œ", "ê°€ë²¼ìš´", "í™œê¸°ì°¬", "ê°ì‚¬í•œ", "ì‚¬ë‘ìŠ¤ëŸ¬ìš´"]
        has_explicit_mood = any(mood in story_lower for mood in explicit_mood_keywords)
        
        # í™•ì‹¤í•œ ë¬´ë“œ í‘œí˜„ ì²´í¬ (ë§¤ìš° êµ¬ì²´ì )
        certain_mood_expressions = ["ë¶€ë“œëŸ¬ìš´ ê½ƒ", "ë”°ëœ»í•œ ëŠë‚Œ", "ë¡œë§¨í‹±í•œ ë¶„ìœ„ê¸°", "ìš°ì•„í•œ ìŠ¤íƒ€ì¼", "í™”ë ¤í•œ ìƒ‰ìƒ"]
        has_certain_mood = any(expression in story_lower for expression in certain_mood_expressions)
        
        if has_explicit_mood and has_certain_mood:
            # ë¬´ë“œê°€ ëª…ì‹œë˜ê³  í™•ì‹¤í•œ ê²½ìš°: 2ê°œê¹Œì§€ ìœ ì§€
            moods = moods[:2]
            print(f"ğŸ­ í™•ì‹¤í•œ ë¬´ë“œ ê°ì§€: {moods} (2ê°œê¹Œì§€ ìœ ì§€)")
        elif has_explicit_mood and not has_certain_mood:
            # ë¬´ë“œê°€ ëª…ì‹œë˜ì—ˆì§€ë§Œ ëª¨í˜¸í•œ ê²½ìš°: 4ê°œ ì˜µì…˜ ì œì•ˆ
            if len(moods) < 4:
                if "ë¶€ë“œëŸ¬ìš´" in story_lower:
                    if "ë¶€ë“œëŸ¬ìš´" not in moods:
                        moods.append("ë¶€ë“œëŸ¬ìš´")
                    if "ë”°ëœ»í•œ" not in moods:
                        moods.append("ë”°ëœ»í•œ")
                    if "ë¡œë§¨í‹±í•œ" not in moods:
                        moods.append("ë¡œë§¨í‹±í•œ")
                elif "ë‚¨í¸" in story_lower or "ì•„ë‚´" in story_lower:
                    if "ë¡œë§¨í‹±í•œ" not in moods:
                        moods.append("ë¡œë§¨í‹±í•œ")
                    if "ë”°ëœ»í•œ" not in moods:
                        moods.append("ë”°ëœ»í•œ")
                    if "ì‚¬ë‘ìŠ¤ëŸ¬ìš´" not in moods:
                        moods.append("ì‚¬ë‘ìŠ¤ëŸ¬ìš´")
                elif "ê³ ë§ˆì›Œ" in story_lower or "ê°ì‚¬" in story_lower:
                    if "ê°ì‚¬í•œ" not in moods:
                        moods.append("ê°ì‚¬í•œ")
                    if "ë”°ëœ»í•œ" not in moods:
                        moods.append("ë”°ëœ»í•œ")
                    if "ë¶€ë“œëŸ¬ìš´" not in moods:
                        moods.append("ë¶€ë“œëŸ¬ìš´")
                elif "ë”°ëœ»í•œ" in story_lower:
                    if "ë”°ëœ»í•œ" not in moods:
                        moods.append("ë”°ëœ»í•œ")
                    if "ë¶€ë“œëŸ¬ìš´" not in moods:
                        moods.append("ë¶€ë“œëŸ¬ìš´")
                    if "ë¡œë§¨í‹±í•œ" not in moods:
                        moods.append("ë¡œë§¨í‹±í•œ")
                elif "ë¡œë§¨í‹±í•œ" in story_lower:
                    if "ë¡œë§¨í‹±í•œ" not in moods:
                        moods.append("ë¡œë§¨í‹±í•œ")
                    if "ì‚¬ë‘ìŠ¤ëŸ¬ìš´" not in moods:
                        moods.append("ì‚¬ë‘ìŠ¤ëŸ¬ìš´")
                    if "ë”°ëœ»í•œ" not in moods:
                        moods.append("ë”°ëœ»í•œ")
            print(f"ğŸ­ ëª¨í˜¸í•œ ë¬´ë“œ: {moods} (3ê°œ ì˜µì…˜ ì œì•ˆ)")
        else:
            # ë¬´ë“œê°€ ëª…ì‹œë˜ì§€ ì•Šì€ ê²½ìš°: ê¸°ë³¸ ë¬´ë“œ ì¶”ê°€
            if len(moods) < 4:
                default_moods = ["ë”°ëœ»í•œ", "ë¶€ë“œëŸ¬ìš´", "ë¡œë§¨í‹±í•œ", "ìš°ì•„í•œ", "ìì—°ìŠ¤ëŸ¬ìš´", "í™œê¸°ì°¬", "í¸ì•ˆí•œ", "ì„¸ë ¨ëœ"]
                for mood in default_moods:
                    if mood not in moods and len(moods) < 4:
                        moods.append(mood)
            print(f"ğŸ­ ê¸°ë³¸ ë¬´ë“œ: {moods} (ê¸°ë³¸ê°’ ì¶”ê°€)")
        
        # ì¤‘ë³µ ì œê±°: emotionsì™€ situationsì—ì„œ ê°™ì€ í‚¤ì›Œë“œ ì œê±°
        # situationsë¥¼ ìš°ì„ í•˜ê³  emotionsì—ì„œ ì¤‘ë³µ ì œê±°
        emotions = [e for e in emotions if e not in situations]
        
        # emotionsê°€ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ê°’ ì¶”ê°€
        if not emotions:
            emotions = ["ì‚¬ë‘"]
        
        # moodsê°€ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ê°’ ì¶”ê°€
        if not moods:
            moods = ["ë”°ëœ»í•œ"]
        
        # colorsê°€ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ê°’ ì¶”ê°€
        if not colors:
            colors = ["í™”ì´íŠ¸"]
        
        # ìƒí™© í‚¤ì›Œë“œê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ 1ê°œ ì¶”ê°€
        if len(situations) < 1:
            story_lower = story.lower()
            if "ë‚¨í¸" in story_lower or "ì•„ë‚´" in story_lower:
                if "ë‚¨í¸" not in situations and "ì•„ë‚´" not in situations:
                    situations.append("ë‚¨í¸" if "ë‚¨í¸" in story_lower else "ì•„ë‚´")
            elif "ì¹œêµ¬" in story_lower:
                if "ì¹œêµ¬" not in situations:
                    situations.append("ì¹œêµ¬")
            else:
                default_situations = ["ì¹œêµ¬", "ê°€ì¡±", "ë¡œë§¨í‹±", "ì¼ìƒ", "ìœ„ë¡œ", "ì¶•í•˜"]
                for situation in default_situations:
                    if situation not in situations and len(situations) < 1:
                        situations.append(situation)
                        break  # 1ê°œë§Œ ì¶”ê°€
        
        # situationsê°€ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ê°’ ì„¤ì •
        if not situations:
            situations = ["ì¼ìƒ"]
        
        # ìƒ‰ìƒ ìš°ì„ ìˆœìœ„ ì²˜ë¦¬ (ì—¬ëŸ¬ ìƒ‰ìƒì´ ì¶”ì¶œëœ ê²½ìš°)
        if len(colors) > 1:
            # í•‘í¬ê°€ ìˆìœ¼ë©´ ìš°ì„  (ë¡œë§¨í‹±/ë¶€ë“œëŸ¬ìš´ ëŠë‚Œ)
            if "í•‘í¬" in colors:
                colors = ["í•‘í¬"]
            # ì˜ë¡œìš°ê°€ ìˆìœ¼ë©´ ìš°ì„  (í¬ë§/ê¸°ì¨)
            elif "ì˜ë¡œìš°" in colors:
                colors = ["ì˜ë¡œìš°"]
            # ë ˆë“œê°€ ìˆìœ¼ë©´ ìš°ì„  (ì—´ì •/ì¶•í•˜)
            elif "ë ˆë“œ" in colors:
                colors = ["ë ˆë“œ"]
            # ê·¸ ì™¸ì—ëŠ” ì²« ë²ˆì§¸ ìƒ‰ìƒ ì‚¬ìš©
            else:
                colors = colors[:1]
        
        # ìƒ‰ìƒ ì¶”ì¶œ ì „ëµ: ì»¬ëŸ¬í†¤ ëª…ì‹œ ì—¬ë¶€ì— ë”°ë¼ ë¶„ê¸°
        story_lower = story.lower()
        
        # ê´€ìš©ì–´/ë¹„ìœ  í‘œí˜„ ì œì™¸ ì²´í¬
        idiom_expressions = ["ë¬´ì§€ê°œë‹¤ë¦¬ë¥¼ ê±´ë„œë‹¤", "ë¬´ì§€ê°œë‹¤ë¦¬ë¥¼ ê±´ë„œì–´", "ë¬´ì§€ê°œë‹¤ë¦¬ë¥¼ ê±´ë„œìŠµë‹ˆë‹¤", "ë¬´ì§€ê°œë‹¤ë¦¬ë¥¼ ê±´ë„œì–´ìš”"]
        has_idiom = any(idiom in story for idiom in idiom_expressions)
        
        # ëª…ì‹œì  ì»¬ëŸ¬ í‚¤ì›Œë“œ ì²´í¬ (ê´€ìš©ì–´ ì œì™¸)
        explicit_color_keywords = ["í•‘í¬", "ë ˆë“œ", "ë¸”ë£¨", "í™”ì´íŠ¸", "ë…¸ë‘", "ì˜ë¡œìš°", "í¼í”Œ", "ë³´ë¼", "ì˜¤ë Œì§€", "ê·¸ë¦°", "ì´ˆë¡"]
        has_explicit_color = any(color in story_lower for color in explicit_color_keywords)
        
        # ê´€ìš©ì–´ê°€ ìˆìœ¼ë©´ ìƒ‰ìƒ ì¶”ì¶œ ì œì™¸í•˜ê³  ìœ„ë¡œ/ìŠ¬í”” ê°ì •ìœ¼ë¡œ ë¶„ë¥˜
        if has_idiom:
            print(f"âš ï¸ ê´€ìš©ì–´ ê°ì§€: ìƒ‰ìƒ ì¶”ì¶œ ì œì™¸, ìœ„ë¡œ/ìŠ¬í”” ê°ì •ìœ¼ë¡œ ë¶„ë¥˜")
            colors = ["í™”ì´íŠ¸"]  # ìœ„ë¡œë¥¼ ìœ„í•œ í™”ì´íŠ¸
            if "ìœ„ë¡œ" not in emotions:
                emotions.insert(0, "ìœ„ë¡œ")
            if "ìŠ¬í””" not in emotions:
                emotions.append("ìŠ¬í””")
            return ExtractedContext(
                emotions=emotions[:1],
                situations=situations[:1],
                moods=moods[:1],
                colors=colors[:1],
                confidence=0.9
            )
        
        # ë¶„ìœ„ê¸° í‚¤ì›Œë“œ ì²´í¬
        mood_color_keywords = ["ë¶€ë“œëŸ¬ìš´", "ë”°ëœ»í•œ", "ë¡œë§¨í‹±í•œ", "ìš°ì•„í•œ", "í™”ë ¤í•œ", "ìì—°ìŠ¤ëŸ¬ìš´", "ì‹¬í”Œí•œ", "ê°€ë²¼ìš´"]
        has_mood_only = any(mood in story_lower for mood in mood_color_keywords) and not has_explicit_color
        
        if has_explicit_color:
            # ì»¬ëŸ¬í†¤ì´ ëª…ì‹œëœ ê²½ìš°: 2ê°œê¹Œì§€ ìœ ì§€ (ê³ ê°ì´ ì›í•˜ëŠ” ìƒ‰ìƒì´ ëª…í™•í•¨)
            colors = colors[:2]
            print(f"ğŸ¨ ëª…ì‹œì  ì»¬ëŸ¬ ê°ì§€: {colors} (2ê°œê¹Œì§€ ìœ ì§€)")
        elif has_mood_only:
            # ë¶„ìœ„ê¸°ë§Œ ì§€ì •ëœ ê²½ìš°: 4ê°œ ì˜µì…˜ ì œì•ˆ
            if len(colors) < 4:
                if "ë¶€ë“œëŸ¬ìš´" in story_lower or "ë¶€ë“œëŸ¬ìš´ ê½ƒ" in story_lower:
                    if "í•‘í¬" not in colors:
                        colors.append("í•‘í¬")
                    if "í™”ì´íŠ¸" not in colors:
                        colors.append("í™”ì´íŠ¸")
                elif "ë‚¨í¸" in story_lower or "ì•„ë‚´" in story_lower:
                    if "í•‘í¬" not in colors:
                        colors.append("í•‘í¬")
                    if "ë ˆë“œ" not in colors:
                        colors.append("ë ˆë“œ")
                elif "ê³ ë§ˆì›Œ" in story_lower or "ê°ì‚¬" in story_lower:
                    if "í•‘í¬" not in colors:
                        colors.append("í•‘í¬")
                    if "í™”ì´íŠ¸" not in colors:
                        colors.append("í™”ì´íŠ¸")
                elif "ë”°ëœ»í•œ" in story_lower:
                    if "í•‘í¬" not in colors:
                        colors.append("í•‘í¬")
                    if "ì˜¤ë Œì§€" not in colors:
                        colors.append("ì˜¤ë Œì§€")
                elif "ë¡œë§¨í‹±í•œ" in story_lower:
                    if "í•‘í¬" not in colors:
                        colors.append("í•‘í¬")
                    if "ë ˆë“œ" not in colors:
                        colors.append("ë ˆë“œ")
                    if "í¼í”Œ" not in colors:
                        colors.append("í¼í”Œ")
                elif "í™”ë ¤í•œ" in story_lower:
                    if "ì˜¤ë Œì§€" not in colors:
                        colors.append("ì˜¤ë Œì§€")
                    if "ë ˆë“œ" not in colors:
                        colors.append("ë ˆë“œ")
                    if "ì˜ë¡œìš°" not in colors:
                        colors.append("ì˜ë¡œìš°")
                elif "ìš°ì•„í•œ" in story_lower:
                    if "í™”ì´íŠ¸" not in colors:
                        colors.append("í™”ì´íŠ¸")
                    if "í¼í”Œ" not in colors:
                        colors.append("í¼í”Œ")
            print(f"ğŸ­ ë¶„ìœ„ê¸°ë§Œ ì§€ì •: {colors} (3ê°œ ì˜µì…˜ ì œì•ˆ)")
        else:
            # ê¸°ë³¸ ìƒ‰ìƒì´ ì¶”ì¶œëœ ê²½ìš°: ê¸°ë³¸ ìƒ‰ìƒ ì¶”ê°€ (ê¸´ í…ìŠ¤íŠ¸ì—ì„œë§Œ)
            if len(colors) < 4 and len(story.strip()) > 30:
                default_colors = ["í•‘í¬", "í™”ì´íŠ¸", "ë ˆë“œ", "ë¸”ë£¨", "ì˜ë¡œìš°", "í¼í”Œ", "ì˜¤ë Œì§€", "ê·¸ë¦°"]
                for color in default_colors:
                    if color not in colors and len(colors) < 4:
                        colors.append(color)
                print(f"ğŸ¨ ê¸°ë³¸ ìƒ‰ìƒ: {colors} (ê¸°ë³¸ê°’ ì¶”ê°€)")
            elif len(colors) == 0:
                print(f"ğŸ¨ ìƒ‰ìƒ ë¯¸ì¶”ì¶œ: ëª…ì‹œì  ìƒ‰ìƒ ìš”ì²­ì´ ì—†ìŒ")
        
        # ë©”ì¸ í‚¤ì›Œë“œëŠ” ê° ë””ë©˜ì…˜ë³„ë¡œ 1ê°œì”©ë§Œ ì¶”ì¶œ
        emotions = emotions[:1]  # ë©”ì¸ í‚¤ì›Œë“œ 1ê°œ
        situations = situations[:1]  # ë©”ì¸ í‚¤ì›Œë“œ 1ê°œ
        moods = moods[:1]  # ë©”ì¸ í‚¤ì›Œë“œ 1ê°œ
        colors = colors[:1]  # ë©”ì¸ í‚¤ì›Œë“œ 1ê°œ
        
        # ë©”ì¸ í‚¤ì›Œë“œëŠ” ì´ë¯¸ 1ê°œì”©ìœ¼ë¡œ ì œí•œë¨ (ì „ì²´ 4ê°œ)
        total_keywords = len(emotions) + len(situations) + len(moods) + len(colors)
        print(f"ğŸ”§ ë©”ì¸ í‚¤ì›Œë“œ ê°œìˆ˜: {total_keywords}ê°œ")
        
        # ì ì§„ì  í‚¤ì›Œë“œ ì¶”ì¶œ: í…ìŠ¤íŠ¸ ê¸¸ì´ì— ë”°ë¼ í‚¤ì›Œë“œ ìˆ˜ ì¡°ì ˆ
        text_length = len(story.strip())
        
        # ë©”ì¸ í‚¤ì›Œë“œëŠ” í•­ìƒ 1ê°œì”©ë§Œ ì¶”ì¶œ (í…ìŠ¤íŠ¸ ê¸¸ì´ì™€ ë¬´ê´€)
        emotions = emotions[:1] if emotions else []
        situations = situations[:1] if situations else []
        moods = moods[:1] if moods else []
        colors = colors[:1] if colors else []
        print(f"ğŸ“ ë©”ì¸ í‚¤ì›Œë“œ ì¶”ì¶œ: ê°ì •={emotions}, ìƒí™©={situations}, ë¬´ë“œ={moods}, ìƒ‰ìƒ={colors}")
        
        print(f"ğŸ”§ ìµœì¢… í‚¤ì›Œë“œ: emotions={emotions}, situations={situations}, moods={moods}, colors={colors}")
        
        # ëŒ€ì•ˆ í‚¤ì›Œë“œ ìƒì„±
        emotions_alternatives = []
        situations_alternatives = []
        moods_alternatives = []
        colors_alternatives = []
        
        print(f"ğŸ” ëŒ€ì•ˆ í‚¤ì›Œë“œ ìƒì„± ì‹œì‘:")
        print(f"  emotions: {emotions}, len: {len(emotions) if emotions else 0}")
        print(f"  situations: {situations}, len: {len(situations) if situations else 0}")
        print(f"  moods: {moods}, len: {len(moods) if moods else 0}")
        print(f"  colors: {colors}, len: {len(colors) if colors else 0}")
        
        if emotions and len(emotions) > 0:
            print(f"  ê°ì • ëŒ€ì•ˆ ìƒì„±: {emotions[0]}")
            emotions_alternatives = self._generate_emotion_alternatives(emotions[0])
            print(f"  ê°ì • ëŒ€ì•ˆ ê²°ê³¼: {emotions_alternatives}")
        
        if situations and len(situations) > 0:
            print(f"  ìƒí™© ëŒ€ì•ˆ ìƒì„±: {situations[0]}")
            situations_alternatives = self._generate_situation_alternatives(situations[0])
            print(f"  ìƒí™© ëŒ€ì•ˆ ê²°ê³¼: {situations_alternatives}")
        
        if moods and len(moods) > 0:
            print(f"  ë¬´ë“œ ëŒ€ì•ˆ ìƒì„±: {moods[0]}")
            moods_alternatives = self._generate_mood_alternatives(moods[0])
            print(f"  ë¬´ë“œ ëŒ€ì•ˆ ê²°ê³¼: {moods_alternatives}")
        
        if colors and len(colors) > 0:
            print(f"  ìƒ‰ìƒ ëŒ€ì•ˆ ìƒì„±: {colors[0]}")
            colors_alternatives = self._generate_color_alternatives(colors[0], context)
            print(f"  ìƒ‰ìƒ ëŒ€ì•ˆ ê²°ê³¼: {colors_alternatives}")
        
        print(f"ğŸ¯ ëŒ€ì•ˆ í‚¤ì›Œë“œ ìƒì„±:")
        print(f"  ê°ì •: {emotions} â†’ ëŒ€ì•ˆ: {emotions_alternatives}")
        print(f"  ìƒí™©: {situations} â†’ ëŒ€ì•ˆ: {situations_alternatives}")
        print(f"  ë¬´ë“œ: {moods} â†’ ëŒ€ì•ˆ: {moods_alternatives}")
        print(f"  ìƒ‰ìƒ: {colors} â†’ ëŒ€ì•ˆ: {colors_alternatives}")
        
        return ExtractedContext(
            emotions=emotions[:1],  # ë©”ì¸ í‚¤ì›Œë“œ 1ê°œ
            situations=situations[:1],  # ë©”ì¸ í‚¤ì›Œë“œ 1ê°œ
            moods=moods[:1],  # ë©”ì¸ í‚¤ì›Œë“œ 1ê°œ
            colors=colors[:1],  # ë©”ì¸ í‚¤ì›Œë“œ 1ê°œ
            confidence=0.3,  # ë‚®ì€ ì‹ ë¢°ë„
            user_intent=user_intent,  # ì‚¬ìš©ì ì˜ë„ ì¶”ê°€
            emotions_alternatives=emotions_alternatives,  # ê°ì • ëŒ€ì•ˆ í‚¤ì›Œë“œ
            situations_alternatives=situations_alternatives,  # ìƒí™© ëŒ€ì•ˆ í‚¤ì›Œë“œ
            moods_alternatives=moods_alternatives,  # ë¬´ë“œ ëŒ€ì•ˆ í‚¤ì›Œë“œ
            colors_alternatives=colors_alternatives  # ìƒ‰ìƒ ëŒ€ì•ˆ í‚¤ì›Œë“œ
        )
    
    def _extract_basic_emotions(self, story: str) -> List[str]:
        """ê¸°ë³¸ ê°ì • ì¶”ì¶œ (ë‹¨ê³„ë³„ ì¶”ì¶œ)"""
        emotions = []
        story_lower = story.lower()
        
        # 1ë‹¨ê³„: ëª…í™•í•œ ê°ì • í‚¤ì›Œë“œ ìš°ì„  ë§¤ì¹­
        clear_emotion_keywords = {
            "ìš°ìš¸": ["ìš°ìš¸", "ìš°ìš¸í•´", "ìš°ìš¸í•œ", "ìš°ìš¸í•¨", "ìš°ìš¸í•´ì„œ"],
            "ìŠ¬í””": ["ìŠ¬í”„", "ìŠ¬í”ˆ", "ìŠ¬í¼", "ìŠ¬í””"],
            "ìŠ¤íŠ¸ë ˆìŠ¤": ["ìŠ¤íŠ¸ë ˆìŠ¤", "ìŠ¤íŠ¸ë ˆìŠ¤ë°›", "ìŠ¤íŠ¸ë ˆìŠ¤ ë°›", "ìŠ¤íŠ¸ë ˆìŠ¤ë°›ì•„"],
            "í”¼ê³¤": ["í”¼ê³¤", "í”¼ê³¤í•´", "í”¼ê³¤í•œ", "ì§€ì³", "ì§€ì³¤ì–´"],
            "ì™¸ë¡œì›€": ["ì™¸ë¡œì›Œ", "ì™¸ë¡œìš´", "ì™¸ë¡œì›€"],
            "ë¶ˆì•ˆ": ["ë¶ˆì•ˆ", "ë¶ˆì•ˆí•´", "ë¶ˆì•ˆí•œ", "ê±±ì •", "ê±±ì •í•´"],
            "ê°ì‚¬": ["ê°ì‚¬", "ê³ ë§ˆì›Œ", "ì€í˜œ", "ë„ì›€"],
            "ê¸°ì¨": ["ê¸°ì˜", "í–‰ë³µ", "ì¦ê±°", "ì‹ ë‚˜", "ì›ƒìŒ"],
            "ì‚¬ë‘": ["ì‚¬ë‘", "ì¢‹ì•„", "ì• ì •", "ì •", "ë§ˆìŒ"],
            "í¬ë§": ["í¬ë§", "ìƒˆë¡œìš´", "ì‹œì‘", "ë¯¸ë˜"]
        }
        
        # ëª…í™•í•œ ê°ì • í‚¤ì›Œë“œ ë§¤ì¹­ (ìš°ì„ ìˆœìœ„ ë†’ìŒ)
        for emotion, keywords in clear_emotion_keywords.items():
            if any(keyword in story_lower for keyword in keywords):
                emotions.append(emotion)
                print(f"ğŸ’­ ëª…í™•í•œ ê°ì • ê°ì§€: {emotion}")
                break  # ì²« ë²ˆì§¸ ë§¤ì¹­ì—ì„œ ì¤‘ë‹¨ (ë‹¨ê³„ë³„ ì¶”ì¶œ)
        
        # ëª…í™•í•œ ê°ì •ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì¶”ê°€
        if not emotions:
            # í…ìŠ¤íŠ¸ ê¸¸ì´ì— ë”°ë¼ ë‹¤ë¥¸ ê¸°ë³¸ê°’
            if len(story.strip()) <= 5:  # ë§¤ìš° ì§§ì€ í…ìŠ¤íŠ¸
                emotions = ["ì‚¬ë‘"]  # ìµœì†Œí•œì˜ ê¸°ë³¸ê°’
            else:
                emotions = ["ì‚¬ë‘", "ê°ì‚¬"]
        
        print(f"ğŸ¯ ìµœì¢… ê°ì • ì¶”ì¶œ: {emotions}")
        return emotions
    
    def get_extraction_summary(self, context: ExtractedContext) -> Dict[str, Any]:
        """ì¶”ì¶œ ê²°ê³¼ ìš”ì•½"""
        return {
            "emotions": context.emotions,
            "situations": context.situations,
            "moods": context.moods,
            "colors": context.colors,
            "confidence": context.confidence,
            "total_extracted": len(context.emotions) + len(context.situations) + len(context.moods) + len(context.colors)
        }
    
    def _get_default_emotions(self, story: str) -> List[str]:
        """ê¸°ë³¸ ê°ì • ì œê³µ"""
        story_lower = story.lower()
        
        # ìœ„ë¡œ/íë§ ê´€ë ¨
        if any(word in story_lower for word in ["ìœ„ë¡œ", "íë§", "í¸ì•ˆ", "ì°¨ë¶„", "ì‰¬ê³ ", "íœ´ì‹"]):
            return ["ë”°ëœ»í•¨"]
        # ì¶•í•˜/ê¸°ì¨ ê´€ë ¨
        elif any(word in story_lower for word in ["ì¶•í•˜", "ìƒì¼", "ê¸°ì¨", "í–‰ë³µ", "í•©ê²©"]):
            return ["ê¸°ì¨"]
        # ì‚¬ë‘/ê°ì‚¬ ê´€ë ¨
        elif any(word in story_lower for word in ["ì‚¬ë‘", "ê°ì‚¬", "ê³ ë§™", "ì€í˜œ"]):
            return ["ì‚¬ë‘"]
        # ê¸°ë³¸ê°’
        else:
            return ["ë”°ëœ»í•¨"]
    
    def _get_default_situations(self, story: str) -> List[str]:
        """ê¸°ë³¸ ìƒí™© ì œê³µ"""
        story_lower = story.lower()
        
        # ìœ„ë¡œ/íë§ ê´€ë ¨
        if any(word in story_lower for word in ["ìœ„ë¡œ", "íë§", "í¸ì•ˆ", "ì°¨ë¶„", "ì‰¬ê³ ", "íœ´ì‹"]):
            return ["ìœ„ë¡œ"]
        # ì¶•í•˜/ê¸°ì¨ ê´€ë ¨
        elif any(word in story_lower for word in ["ì¶•í•˜", "ìƒì¼", "ê¸°ì¨", "í–‰ë³µ", "í•©ê²©"]):
            return ["ì¶•í•˜"]
        # ì‚¬ë‘/ê°ì‚¬ ê´€ë ¨
        elif any(word in story_lower for word in ["ì‚¬ë‘", "ê°ì‚¬", "ê³ ë§™", "ì€í˜œ"]):
            return ["ê°ì‚¬"]
        # ê¸°ë³¸ê°’
        else:
            return ["ì¼ìƒ"]
    
    def _get_default_moods(self, story: str) -> List[str]:
        """ê¸°ë³¸ ë¬´ë“œ ì œê³µ"""
        story_lower = story.lower()
        
        # ìœ„ë¡œ/íë§ ê´€ë ¨
        if any(word in story_lower for word in ["ìœ„ë¡œ", "íë§", "í¸ì•ˆ", "ì°¨ë¶„", "ì‰¬ê³ ", "íœ´ì‹"]):
            return ["ë”°ëœ»í•œ"]
        # ì¶•í•˜/ê¸°ì¨ ê´€ë ¨
        elif any(word in story_lower for word in ["ì¶•í•˜", "ìƒì¼", "ê¸°ì¨", "í–‰ë³µ", "í•©ê²©"]):
            return ["ë°ì€"]
        # ì‚¬ë‘/ê°ì‚¬ ê´€ë ¨
        elif any(word in story_lower for word in ["ì‚¬ë‘", "ê°ì‚¬", "ê³ ë§™", "ì€í˜œ"]):
            return ["ë¡œë§¨í‹±í•œ"]
        # ê¸°ë³¸ê°’
        else:
            return ["ë”°ëœ»í•œ"]
    
    def _get_default_colors(self, story: str) -> List[str]:
        """ê¸°ë³¸ ìƒ‰ìƒ ì œê³µ"""
        story_lower = story.lower()
        
        # ìœ„ë¡œ/íë§ ê´€ë ¨
        if any(word in story_lower for word in ["ìœ„ë¡œ", "íë§", "í¸ì•ˆ", "ì°¨ë¶„", "ì‰¬ê³ ", "íœ´ì‹"]):
            return ["í™”ì´íŠ¸"]
        # ì¶•í•˜/ê¸°ì¨ ê´€ë ¨
        elif any(word in story_lower for word in ["ì¶•í•˜", "ìƒì¼", "ê¸°ì¨", "í–‰ë³µ", "í•©ê²©"]):
            return ["ì˜ë¡œìš°"]
        # ì‚¬ë‘/ê°ì‚¬ ê´€ë ¨
        elif any(word in story_lower for word in ["ì‚¬ë‘", "ê°ì‚¬", "ê³ ë§™", "ì€í˜œ"]):
            return ["í•‘í¬"]
        # ê¸°ë³¸ê°’
        else:
            return ["í™”ì´íŠ¸"]
    
    def _generate_emotion_alternatives(self, main_emotion: str) -> List[str]:
        """ê°ì • ëŒ€ì•ˆ í‚¤ì›Œë“œ ìƒì„±"""
        alternatives_map = {
            "ì‚¬ë‘": ["ì• ì •", "ë¡œë§¨í‹±", "ë”°ëœ»í•¨"],
            "ê°ì‚¬": ["ê³ ë§ˆì›€", "ì€í˜œ", "ì†Œì¤‘í•¨"],
            "ê¸°ì¨": ["í–‰ë³µ", "ì¦ê±°ì›€", "ì„¤ë ˜"],
            "í¬ë§": ["ë¯¸ë˜", "ìƒˆë¡œìš´ ì‹œì‘", "ê¿ˆ"],
            "ìœ„ë¡œ": ["ì•ˆì‹¬", "í¸ì•ˆí•¨", "ì°¨ë¶„í•¨"],
            "ìŠ¬í””": ["ì• ë„", "ê·¸ë¦¬ì›€", "ì™¸ë¡œì›€"],
            "ìŠ¤íŠ¸ë ˆìŠ¤": ["í”¼ê³¤", "ì§€ì¹¨", "ë¶ˆì•ˆ"],
            "ìš°ìš¸": ["ì¹¨ìš¸", "ë‹µë‹µí•¨", "í—ˆì „í•¨"],
            "ì„¤ë ˜": ["ë‘ê·¼ê±°ë¦¼", "ë–¨ë¦¼", "ê¸´ì¥"],
            "ê°ë™": ["ê°ì‚¬", "ë­‰í´í•¨", "ë”°ëœ»í•¨"]
        }
        return alternatives_map.get(main_emotion, ["ì• ì •", "ë”°ëœ»í•¨", "í¸ì•ˆí•¨"])
    
    def _generate_situation_alternatives(self, main_situation: str) -> List[str]:
        """ìƒí™© ëŒ€ì•ˆ í‚¤ì›Œë“œ ìƒì„±"""
        alternatives_map = {
            "ìœ„ë¡œ": ["ê²©ë ¤", "íë§", "ì•ˆì‹¬"],
            "ì¶•í•˜": ["ê²½ì‚¬", "ì¶•í•˜íŒŒí‹°", "ê¸°ë…"],
            "ì‚¬ê³¼": ["ìš©ì„œ", "í™”í•´", "ì¬íšŒ"],
            "ê³ ë°±": ["í”„ë¡œí¬ì¦ˆ", "ì‚¬ë‘", "ì§„ì‹¬"],
            "ìƒì¼": ["ê¸°ë…ì¼", "íŒŒí‹°", "ì„ ë¬¼"],
            "ì¡¸ì—…": ["í•™ìœ„", "ì„±ì·¨", "ìƒˆë¡œìš´ ì‹œì‘"],
            "í•©ê²©": ["ì„±ê³µ", "ì¶•í•˜", "ìë‘"],
            "ì¹œêµ¬": ["ìš°ì •", "ë™ë£Œ", "ì ˆì¹œ"],
            "ê°€ì¡±": ["ë¶€ëª¨", "ìì‹", "í˜•ì œ"],
            "ë¡œë§¨í‹±": ["ë°ì´íŠ¸", "ì—°ì¸", "ì‚¬ë‘"],
            "ì¼ìƒ": ["ë£¨í‹´", "í¸ì•ˆí•¨", "ì†Œì†Œí•œ"],
            "ë°©ê¾¸ë¯¸ê¸°": ["ì¸í…Œë¦¬ì–´", "í™ˆë°ì½”", "ê³µê°„"],
            "íœ´ì‹": ["ì‰¬ê¸°", "íë§", "í¸ì•ˆí•¨"],
            "ê¸°ë¶„ì „í™˜": ["ìƒˆë¡œìš´", "í™œë ¥", "í™˜ê¸°"],
            "ìŠ¤íŠ¸ë ˆìŠ¤í•´ì†Œ": ["íë§", "í¸ì•ˆí•¨", "ì•ˆì •"],
            "ìê¸°ìœ„ë¡œ": ["íë§", "í¸ì•ˆí•¨", "ì•ˆì •"],
            "íë§": ["ì¹˜ìœ ", "í¸ì•ˆí•¨", "ì•ˆì •"],
            "ëª…ìƒ": ["ì§‘ì¤‘", "ì°¨ë¶„í•¨", "í‰ì˜¨"],
            "ë…ì„œ": ["ì§€ì‹", "ì—¬ìœ ", "í¸ì•ˆí•¨"],
            "ìš´ë™": ["í™œë ¥", "ê±´ê°•", "ì—ë„ˆì§€"],
            "ì·¨ë¯¸í™œë™": ["ì¦ê±°ì›€", "ì°½ì‘", "í‘œí˜„"],
            "ìê¸°ê³„ë°œ": ["ì„±ì¥", "ë°œì „", "í•™ìŠµ"],
            "ìƒˆë¡œìš´ì‹œì‘": ["ë³€í™”", "ë„ì „", "ëª¨í—˜"],
            "ê±°ì‹¤": ["ê°€ì¡±", "í¸ì•ˆí•¨", "ì•„ëŠ‘í•¨"],
            "ì¹¨ì‹¤": ["íœ´ì‹", "í¸ì•ˆí•¨", "ì•ˆì •"],
            "ì‚¬ë¬´ì‹¤": ["ì—…ë¬´", "ì§‘ì¤‘", "ì„±ê³¼"],
            "ì¹´í˜": ["ë¶„ìœ„ê¸°", "ì•„ëŠ‘í•¨", "í¸ì•ˆí•¨"],
            "ì •ì›": ["ìì—°", "ì‹ ì„ í•¨", "í‰í™”"],
            "ë°œì½”ë‹ˆ": ["ì•¼ì™¸", "ë°”ëŒ", "í–‡ì‚´"],
            "ë² ë€ë‹¤": ["ì•¼ì™¸", "ë°”ëŒ", "í–‡ì‚´"],
            "ì¸í…Œë¦¬ì–´": ["ë””ìì¸", "ìŠ¤íƒ€ì¼", "ë¶„ìœ„ê¸°"],
            "í™ˆë°ì½”": ["ì¥ì‹", "ì†Œí’ˆ", "í¬ì¸íŠ¸"],
            "ê³µê°„ë¶„ìœ„ê¸°": ["ë¬´ë“œ", "ê°ì„±", "í™˜ê²½"],
            "ì¡°ëª…": ["ë¶„ìœ„ê¸°", "ë°ê¸°", "í™˜ê²½"]
        }
        return alternatives_map.get(main_situation, ["ì¼ìƒ", "í¸ì•ˆí•¨", "ì¦ê±°ì›€"])
    
    def _generate_mood_alternatives(self, main_mood: str) -> List[str]:
        """ë¬´ë“œ ëŒ€ì•ˆ í‚¤ì›Œë“œ ìƒì„±"""
        alternatives_map = {
            "ë”°ëœ»í•œ": ["í¬ê·¼í•œ", "í¸ì•ˆí•œ", "ì•ˆì •ì ì¸"],
            "ë¶€ë“œëŸ¬ìš´": ["ì€ì€í•œ", "ì¡°ìš©í•œ", "ì°¨ë¶„í•œ"],
            "ë¡œë§¨í‹±í•œ": ["ë‹¬ì½¤í•œ", "ì‚¬ë‘ìŠ¤ëŸ¬ìš´", "ì•„ë¦„ë‹¤ìš´"],
            "í™œê¸°ì°¬": ["ê²½ì¾Œí•œ", "ë°ì€", "ì¦ê±°ìš´"],
            "ìš°ì•„í•œ": ["ì„¸ë ¨ëœ", "ê³ ê¸‰ìŠ¤ëŸ¬ìš´", "í’ˆê²© ìˆëŠ”"],
            "ìì—°ìŠ¤ëŸ¬ìš´": ["ë‚´ì¶”ëŸ´í•œ", "ê¹”ë”í•œ", "ì‹¬í”Œí•œ"],
            "í™”ë ¤í•œ": ["ë¹„ë¹„ë“œí•œ", "ì•Œë¡ë‹¬ë¡í•œ", "ëˆˆë¶€ì‹ "],
            "ì‹¬í”Œí•œ": ["ê°€ë²¼ìš´", "ê°„ë‹¨í•œ", "ë¯¸ë‹ˆë©€í•œ"],
            "ê°€ë²¼ìš´": ["ê°€ë³ì§€ë§Œ", "ê°„ë‹¨í•œ", "ì‹¬í”Œí•œ"],
            "ê°ì‚¬í•œ": ["ê³ ë§ˆì›Œ", "ì€í˜œ", "ë„ì›€"],
            "ì‚¬ë‘ìŠ¤ëŸ¬ìš´": ["ì• ì •", "ì •", "ë§ˆìŒ"],
            "í¸ì•ˆí•œ": ["í¸í•˜ê²Œ", "ì‰¬ê³ ", "íœ´ì‹"],
            "í‰ì˜¨í•œ": ["ì°¨ë¶„", "ì¡°ìš©í•œ", "ê³ ìš”í•œ"],
            "ê¸°ë¶„ì „í™˜": ["ìƒˆë¡œìš´", "í™œë ¥", "í™˜ê¸°"],
            "ë°ì€": ["ë°ê²Œ", "í™œê¸°ì°¬", "ê²½ì¾Œí•œ"],
            "ê¸°ìœ": ["í–‰ë³µí•œ", "ì¦ê±°ìš´", "ì‹ ë‚˜ëŠ”"],
            "ìœ„ë¡œë°›ê³  ì‹¶ì€": ["ì•ˆì‹¬", "í¸ì•ˆí•¨", "ì°¨ë¶„í•¨"],
            
            # ìƒ‰ìƒ ê´€ë ¨ ë¬´ë“œ ì¶”ê°€
            "ì‹œì›í•œ": ["ì‹œì›í•œ", "ì°¨ë¶„í•œ", "ìƒì¾Œí•œ"],
            "ì‹ ë¹„ë¡œìš´": ["ì‹ ë¹„ë¡œìš´", "ìš°ì•„í•œ", "ê³ ê¸‰ìŠ¤ëŸ¬ìš´"],
            "ìˆœìˆ˜í•œ": ["ìˆœìˆ˜í•œ", "ê¹¨ë—í•œ", "ì •ê°ˆí•œ"],
            "ì—´ì •ì ì¸": ["ì—´ì •ì ì¸", "ê°•ë ¬í•œ", "ëœ¨ê±°ìš´"],
            "ì€ì€í•œ": ["ì€ì€í•œ", "ë¶€ë“œëŸ¬ìš´", "ì¡°ìš©í•œ"]
        }
        return alternatives_map.get(main_mood, ["ë”°ëœ»í•œ", "í¸ì•ˆí•œ", "ìì—°ìŠ¤ëŸ¬ìš´"])
    
    def _generate_color_alternatives(self, main_color: str, context: ExtractedContext = None) -> List[str]:
        """ìƒ‰ìƒ ëŒ€ì•ˆ í‚¤ì›Œë“œ ìƒì„± - ì»¨í…ìŠ¤íŠ¸ ê¸°ë°˜ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ ì¶”ì²œ"""
        
        # ì»¨í…ìŠ¤íŠ¸ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ëŒ€ì•ˆ ë°˜í™˜
        if not context:
            basic_alternatives = {
                "í™”ì´íŠ¸": ["í•‘í¬", "ë¼ì¼ë½"],     # wh
                "ì˜¤ë Œì§€": ["ì˜ë¡œìš°", "ë ˆë“œ"],     # or  
                "ë ˆë“œ": ["í•‘í¬", "ì˜¤ë Œì§€"],       # rd
                "ì˜ë¡œìš°": ["ì˜¤ë Œì§€", "í•‘í¬"],     # yl
                "í•‘í¬": ["ë¼ì¼ë½", "í™”ì´íŠ¸"],    # pk
                "ë¼ì¼ë½": ["í•‘í¬", "í¼í”Œ"],      # ll
                "ë¸”ë£¨": ["í¼í”Œ", "í™”ì´íŠ¸"],      # bl
                "í¼í”Œ": ["ë¼ì¼ë½", "ë¸”ë£¨"]       # pu
            }
            return basic_alternatives.get(main_color, ["í™”ì´íŠ¸", "í•‘í¬", "ë¸”ë£¨"])
        
        # ì»¨í…ìŠ¤íŠ¸ ê¸°ë°˜ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ ì¶”ì²œ
        emotion = context.emotions[0] if context.emotions else ""
        mood = context.moods[0] if context.moods else ""
        
        # ê°ì • + ë¬´ë“œ ì¡°í•©ì— ë”°ë¥¸ ìƒ‰ìƒ íŒ”ë ˆíŠ¸
        if emotion == "ìœ„ë¡œ" or "ìœ„ë¡œ" in mood or "ë”°ëœ»í•œ" in mood:
            # ìœ„ë¡œ/ë”°ëœ»í•¨ â†’ ë¶€ë“œëŸ½ê³  í¸ì•ˆí•œ ìƒ‰ìƒ
            warm_palette = {
                "í•‘í¬": ["ë¼ì¼ë½", "í™”ì´íŠ¸"],
                "ë¼ì¼ë½": ["í•‘í¬", "í¼í”Œ"],
                "í™”ì´íŠ¸": ["í•‘í¬", "ë¼ì¼ë½"],
                "í¼í”Œ": ["ë¼ì¼ë½", "í•‘í¬"],
                "ë¸”ë£¨": ["ë¼ì¼ë½", "í™”ì´íŠ¸"],
                "ë ˆë“œ": ["í•‘í¬", "ë¼ì¼ë½"],
                "ì˜¤ë Œì§€": ["í•‘í¬", "ì˜ë¡œìš°"],
                "ì˜ë¡œìš°": ["í•‘í¬", "ì˜¤ë Œì§€"]
            }
            return warm_palette.get(main_color, ["í•‘í¬", "ë¼ì¼ë½"])
            
        elif emotion == "ê¸°ì¨" or "í™œê¸°ì°¬" in mood or "ë°ì€" in mood:
            # ê¸°ì¨/í™œê¸°ì°¬ â†’ ë°ê³  ê²½ì¾Œí•œ ìƒ‰ìƒ
            bright_palette = {
                "ì˜ë¡œìš°": ["ì˜¤ë Œì§€", "í•‘í¬"],
                "ì˜¤ë Œì§€": ["ì˜ë¡œìš°", "ë ˆë“œ"],
                "í•‘í¬": ["ì˜ë¡œìš°", "ë¼ì¼ë½"],
                "ë ˆë“œ": ["ì˜¤ë Œì§€", "í•‘í¬"],
                "ë¼ì¼ë½": ["í•‘í¬", "í¼í”Œ"],
                "í¼í”Œ": ["ë¼ì¼ë½", "í•‘í¬"],
                "ë¸”ë£¨": ["ë¼ì¼ë½", "í¼í”Œ"],
                "í™”ì´íŠ¸": ["í•‘í¬", "ì˜ë¡œìš°"]
            }
            return bright_palette.get(main_color, ["ì˜ë¡œìš°", "í•‘í¬"])
            
        elif emotion == "ì‚¬ë‘" or "ë¡œë§¨í‹±" in mood:
            # ì‚¬ë‘/ë¡œë§¨í‹± â†’ ë¡œë§¨í‹±í•œ ìƒ‰ìƒ
            romantic_palette = {
                "í•‘í¬": ["ë¼ì¼ë½", "ë ˆë“œ"],
                "ë ˆë“œ": ["í•‘í¬", "ë¼ì¼ë½"],
                "ë¼ì¼ë½": ["í•‘í¬", "í¼í”Œ"],
                "í¼í”Œ": ["ë¼ì¼ë½", "í•‘í¬"],
                "í™”ì´íŠ¸": ["í•‘í¬", "ë¼ì¼ë½"],
                "ë¸”ë£¨": ["ë¼ì¼ë½", "í¼í”Œ"],
                "ì˜¤ë Œì§€": ["í•‘í¬", "ë ˆë“œ"],
                "ì˜ë¡œìš°": ["í•‘í¬", "ì˜¤ë Œì§€"]
            }
            return romantic_palette.get(main_color, ["í•‘í¬", "ë¼ì¼ë½"])
            
        elif emotion == "ìš°ìš¸" or "ì°¨ë¶„í•œ" in mood or "ì‹œì›í•œ" in mood:
            # ìš°ìš¸/ì°¨ë¶„í•¨ â†’ ì°¨ë¶„í•˜ê³  ì‹œì›í•œ ìƒ‰ìƒ
            cool_palette = {
                "ë¸”ë£¨": ["í¼í”Œ", "ë¼ì¼ë½"],
                "í¼í”Œ": ["ë¸”ë£¨", "ë¼ì¼ë½"],
                "ë¼ì¼ë½": ["ë¸”ë£¨", "í¼í”Œ"],
                "í™”ì´íŠ¸": ["ë¸”ë£¨", "ë¼ì¼ë½"],
                "í•‘í¬": ["ë¼ì¼ë½", "í¼í”Œ"],
                "ë ˆë“œ": ["í¼í”Œ", "ë¸”ë£¨"],
                "ì˜¤ë Œì§€": ["ë¼ì¼ë½", "ë¸”ë£¨"],
                "ì˜ë¡œìš°": ["ë¼ì¼ë½", "ë¸”ë£¨"]
            }
            return cool_palette.get(main_color, ["ë¸”ë£¨", "ë¼ì¼ë½"])
        
        # ê¸°ë³¸ íŒ”ë ˆíŠ¸ (ìœ„ ì¡°ê±´ì— í•´ë‹¹í•˜ì§€ ì•ŠëŠ” ê²½ìš°)
        default_palette = {
            "í•‘í¬": ["ë¼ì¼ë½", "í™”ì´íŠ¸"],
            "ë¸”ë£¨": ["í¼í”Œ", "ë¼ì¼ë½"],
            "í™”ì´íŠ¸": ["í•‘í¬", "ë¼ì¼ë½"],
            "ë ˆë“œ": ["í•‘í¬", "ì˜¤ë Œì§€"],
            "ì˜ë¡œìš°": ["ì˜¤ë Œì§€", "í•‘í¬"],
            "ì˜¤ë Œì§€": ["ì˜ë¡œìš°", "ë ˆë“œ"],
            "ë¼ì¼ë½": ["í•‘í¬", "í¼í”Œ"],
            "í¼í”Œ": ["ë¼ì¼ë½", "ë¸”ë£¨"]
        }
        return default_palette.get(main_color, ["í™”ì´íŠ¸", "í•‘í¬", "ë¸”ë£¨"])
